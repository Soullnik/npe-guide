import{b as k,c as W}from"./chunk-AQQWADZY.js";import{a as P,b as K}from"./chunk-636WS3ZT.js";import{a as B,h as J}from"./chunk-PH4NQ2ZM.js";import{c as T,d as z}from"./chunk-CKT5VIRA.js";import{A as I,D as F}from"./chunk-Q33HFBOA.js";import{a as p,e as $}from"./chunk-VLML44LO.js";import{c as E,f as U}from"./chunk-I3I5672P.js";import{a as y,b as D,f as O,u as M}from"./chunk-J2REHNP7.js";import{a as V,c as L}from"./chunk-4RWBSKZ4.js";import{a as m,d as R}from"./chunk-A2QYPOYP.js";import{c as a,d as g}from"./chunk-2AUPWM7R.js";import{a as h,b as C}from"./chunk-MEUTOEEX.js";import{e as l}from"./chunk-FAF55DAL.js";var H,_,S=l(()=>{"use strict";C();H=(function(i){return i.ExecuteBlock="ExecuteBlock",i.ExecuteEvent="ExecuteEvent",i.TriggerConnection="TriggerConnection",i.ContextVariableSet="ContextVariableSet",i.GlobalVariableSet="GlobalVariableSet",i.GlobalVariableDelete="GlobalVariableDelete",i.GlobalVariableGet="GlobalVariableGet",i.AddConnection="AddConnection",i.GetConnectionValue="GetConnectionValue",i.SetConnectionValue="SetConnectionValue",i.ActivateSignal="ActivateSignal",i.ContextVariableGet="ContextVariableGet",i})(H||{}),_=class{constructor(){this.logToConsole=!1,this.log=[]}addLogItem(e){if(e.time||(e.time=Date.now()),this.log.push(e),this.logToConsole){let t=e.payload?.value;typeof t=="object"&&t.getClassName?h.Log(`[FGLog] ${e.className}:${e.uniqueId.split("-")[0]} ${e.action} - ${JSON.stringify(t.getClassName())}: ${t.toString()}`):h.Log(`[FGLog] ${e.className}:${e.uniqueId.split("-")[0]} ${e.action} - ${JSON.stringify(e.payload)}`)}}getItemsOfType(e){return this.log.filter(t=>t.action===e)}}});var d,q=l(()=>{"use strict";D();M();L();F();g();W();S();d=class{get enableLogging(){return this._enableLogging}set enableLogging(e){this._enableLogging!==e&&(this._enableLogging=e,this._enableLogging?(this.logger=new _,this.logger.logToConsole=!0):this.logger=null)}constructor(e){this.uniqueId=V(),this._userVariables={},this._executionVariables={},this._globalContextVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new a,this.treatDataAsRightHanded=!1,this._enableLogging=!1,this._configuration=e,this.assetsContext=e.assetsContext??e.scene}hasVariable(e){return e in this._userVariables}setVariable(e,t){this._userVariables[e]=t,this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"ContextVariableSet",payload:{name:e,value:t}})}getAsset(e,t){return k(this.assetsContext,e,t)}getVariable(e){return this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"ContextVariableGet",payload:{name:e,value:this._userVariables[e]}}),this._userVariables[e]}get userVariables(){return this._userVariables}getScene(){return this._configuration.scene}_getUniqueIdPrefixedName(e,t){return`${e.uniqueId}_${t}`}_getGlobalContextVariable(e,t){return this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableGet",payload:{name:e,defaultValue:t,possibleValue:this._globalContextVariables[e]}}),this._hasGlobalContextVariable(e)?this._globalContextVariables[e]:t}_setGlobalContextVariable(e,t){this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableSet",payload:{name:e,value:t}}),this._globalContextVariables[e]=t}_deleteGlobalContextVariable(e){this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableDelete",payload:{name:e}}),delete this._globalContextVariables[e]}_hasGlobalContextVariable(e){return e in this._globalContextVariables}_setExecutionVariable(e,t,s){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=s}_getExecutionVariable(e,t,s){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:s}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)]}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t)in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){this._connectionValues[e.uniqueId]=t,this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"SetConnectionValue",payload:{connectionPointId:e.uniqueId,value:t}})}_setConnectionValueByKey(e,t){this._connectionValues[e]=t}_getConnectionValue(e){return this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GetConnectionValue",payload:{connectionPointId:e.uniqueId,value:this._connectionValues[e.uniqueId]}}),this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}get hasPendingBlocks(){return this._pendingBlocks.length>0}_addPendingBlock(e){this._pendingBlocks.includes(e)||(this._pendingBlocks.push(e),this._pendingBlocks.sort((t,s)=>t.priority-s.priority))}_removePendingBlock(e){let t=this._pendingBlocks.indexOf(e);t!==-1&&this._pendingBlocks.splice(t,1)}_clearPendingBlocks(){for(let e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0}_notifyExecuteNode(e){this.onNodeExecutedObservable.notifyObservers(e),this.logger?.addLogItem({time:Date.now(),className:e.getClassName(),uniqueId:e.uniqueId,action:"ExecuteBlock"})}_notifyOnTick(e){this._setGlobalContextVariable("timeSinceStart",e.timeSinceStart),this._setGlobalContextVariable("deltaTime",e.deltaTime);for(let t of this._pendingBlocks)t._executeOnTick?.(this)}_increaseExecutionId(){this._executionId++}get executionId(){return this._executionId}serialize(e={},t=I){e.uniqueId=this.uniqueId,e._userVariables={};for(let s in this._userVariables)t(s,this._userVariables[s],e._userVariables);e._connectionValues={};for(let s in this._connectionValues)t(s,this._connectionValues[s],e._connectionValues);this.assetsContext!==this.getScene()&&(e._assetsContext={meshes:this.assetsContext.meshes.map(s=>s.id),materials:this.assetsContext.materials.map(s=>s.id),textures:this.assetsContext.textures.map(s=>s.name),animations:this.assetsContext.animations.map(s=>s.name),lights:this.assetsContext.lights.map(s=>s.id),cameras:this.assetsContext.cameras.map(s=>s.id),sounds:this.assetsContext.sounds?.map(s=>s.name),skeletons:this.assetsContext.skeletons.map(s=>s.id),particleSystems:this.assetsContext.particleSystems.map(s=>s.name),geometries:this.assetsContext.geometries.map(s=>s.id),multiMaterials:this.assetsContext.multiMaterials.map(s=>s.id),transformNodes:this.assetsContext.transformNodes.map(s=>s.id)})}getClassName(){return"FlowGraphContext"}};y([O()],d.prototype,"uniqueId",void 0)});var f,N=l(()=>{"use strict";$();g();f=class{constructor(e){this.onEventTriggeredObservable=new a,this.sceneReadyTriggered=!1,this._pointerUnderMeshState={},this._startingTime=0,this._scene=e,this._initialize()}_initialize(){this._sceneReadyObserver=this._scene.onReadyObservable.add(()=>{this.sceneReadyTriggered||(this.onEventTriggeredObservable.notifyObservers({type:"SceneReady"}),this.sceneReadyTriggered=!0)}),this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>{this.onEventTriggeredObservable.notifyObservers({type:"SceneDispose"})}),this._sceneOnBeforeRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{let e=this._scene.getEngine().getDeltaTime()/1e3;this.onEventTriggeredObservable.notifyObservers({type:"SceneBeforeRender",payload:{timeSinceStart:this._startingTime,deltaTime:e}}),this._startingTime+=e}),this._meshPickedObserver=this._scene.onPointerObservable.add(e=>{this.onEventTriggeredObservable.notifyObservers({type:"MeshPick",payload:e})},p.POINTERPICK),this._meshUnderPointerObserver=this._scene.onMeshUnderPointerUpdatedObservable.add(e=>{let t=e.pointerId,s=e.mesh,n=this._pointerUnderMeshState[t];!n&&s?this.onEventTriggeredObservable.notifyObservers({type:"PointerOver",payload:{pointerId:t,mesh:s}}):n&&!s?this.onEventTriggeredObservable.notifyObservers({type:"PointerOut",payload:{pointerId:t,mesh:n}}):n&&s&&n!==s&&(this.onEventTriggeredObservable.notifyObservers({type:"PointerOut",payload:{pointerId:t,mesh:n,over:s}}),this.onEventTriggeredObservable.notifyObservers({type:"PointerOver",payload:{pointerId:t,mesh:s,out:n}})),this._pointerUnderMeshState[t]=s},p.POINTERMOVE)}dispose(){this._sceneDisposeObserver?.remove(),this._sceneReadyObserver?.remove(),this._sceneOnBeforeRenderObserver?.remove(),this._meshPickedObserver?.remove(),this._meshUnderPointerObserver?.remove(),this.onEventTriggeredObservable.clear()}}});var A,b,G=l(()=>{"use strict";g();q();z();N();J();A=(function(i){return i[i.Stopped=0]="Stopped",i[i.Started=1]="Started",i})(A||{}),b=class{get state(){return this._state}set state(e){this._state=e,this.onStateChangedObservable.notifyObservers(e)}constructor(e){this.onStateChangedObservable=new a,this._eventBlocks={SceneReady:[],SceneDispose:[],SceneBeforeRender:[],MeshPick:[],PointerDown:[],PointerUp:[],PointerMove:[],PointerOver:[],PointerOut:[],SceneAfterRender:[],NoTrigger:[]},this._executionContexts=[],this._state=0,this._scene=e.scene,this._sceneEventCoordinator=new f(this._scene),this._coordinator=e.coordinator,this._eventObserver=this._sceneEventCoordinator.onEventTriggeredObservable.add(t=>{for(let s of this._executionContexts){let n=this._getContextualOrder(t.type,s);for(let o of n)if(!o._executeEvent(s,t.payload))break}switch(t.type){case"SceneReady":this._sceneEventCoordinator.sceneReadyTriggered=!0;break;case"SceneBeforeRender":for(let s of this._executionContexts)s._notifyOnTick(t.payload);break;case"SceneDispose":this.dispose();break}})}createContext(){let e=new d({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}getContext(e){return this._executionContexts[e]}addEventBlock(e){if((e.type==="PointerOver"||e.type==="PointerOut")&&(this._scene.constantlyUpdateMeshUnderPointer=!0),e.type!=="NoTrigger"&&this._eventBlocks[e.type].push(e),this.state===1)for(let t of this._executionContexts)e._startPendingTasks(t);else this.onStateChangedObservable.addOnce(t=>{if(t===1)for(let s of this._executionContexts)e._startPendingTasks(s)})}start(){this.state!==1&&(this._executionContexts.length===0&&this.createContext(),this.onStateChangedObservable.add(e=>{e===1&&(this._startPendingEvents(),this._scene.isReady(!0)&&this._sceneEventCoordinator.onEventTriggeredObservable.notifyObservers({type:"SceneReady"}))}),this.state=1)}_startPendingEvents(){for(let e of this._executionContexts)for(let t in this._eventBlocks){let s=this._getContextualOrder(t,e);for(let n of s)n._startPendingTasks(e)}}_getContextualOrder(e,t){let s=this._eventBlocks[e].sort((n,o)=>o.initPriority-n.initPriority);if(e==="MeshPick"){let n=[];for(let o of s){let r=o.asset.getValue(t),u=0;for(;u<s.length;u++){let x=s[u].asset.getValue(t);if(r&&x&&B(r,x))break}n.splice(u,0,o)}return n}return s}dispose(){if(this.state!==0){this.state=0;for(let e of this._executionContexts)e._clearPendingBlocks();this._executionContexts.length=0;for(let e in this._eventBlocks)this._eventBlocks[e].length=0;this._eventObserver?.remove(),this._sceneEventCoordinator.dispose()}}visitAllBlocks(e){let t=[],s=new Set;for(let n in this._eventBlocks)for(let o of this._eventBlocks[n])t.push(o),s.add(o.uniqueId);for(;t.length>0;){let n=t.pop();e(n);for(let o of n.dataInputs)for(let r of o._connectedPoint)s.has(r._ownerBlock.uniqueId)||(t.push(r._ownerBlock),s.add(r._ownerBlock.uniqueId));if(n instanceof T)for(let o of n.signalOutputs)for(let r of o._connectedPoint)s.has(r._ownerBlock.uniqueId)||(t.push(r._ownerBlock),s.add(r._ownerBlock.uniqueId))}}serialize(e={},t){e.allBlocks=[],this.visitAllBlocks(s=>{let n={};s.serialize(n),e.allBlocks.push(n)}),e.executionContexts=[];for(let s of this._executionContexts){let n={};s.serialize(n,t),e.executionContexts.push(n)}}}});var c,w=l(()=>{"use strict";g();G();C();c=class i{constructor(e){this.config=e,this.dispatchEventsSynchronously=!0,this._flowGraphs=[],this._customEventsMap=new Map,this._eventExecutionCounter=new Map,this._executeOnNextFrame=[],this._eventUniqueId=0,this._disposeObserver=this.config.scene.onDisposeObservable.add(()=>{this.dispose()}),this._onBeforeRenderObserver=this.config.scene.onBeforeRenderObservable.add(()=>{this._eventExecutionCounter.clear();let s=this._executeOnNextFrame.slice(0);if(s.length)for(let n of s){this.notifyCustomEvent(n.id,n.data,!1);let o=this._executeOnNextFrame.findIndex(r=>r.uniqueId===n.uniqueId);o!==-1&&this._executeOnNextFrame.splice(o,1)}}),(i.SceneCoordinators.get(this.config.scene)??[]).push(this)}createGraph(){let e=new b({scene:this.config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){let t=this._flowGraphs.indexOf(e);t!==-1&&(e.dispose(),this._flowGraphs.splice(t,1))}start(){for(let e of this._flowGraphs)e.start()}dispose(){for(let s of this._flowGraphs)s.dispose();this._flowGraphs.length=0,this._disposeObserver?.remove(),this._onBeforeRenderObserver?.remove();let e=i.SceneCoordinators.get(this.config.scene)??[],t=e.indexOf(this);t!==-1&&e.splice(t,1)}serialize(e,t){e._flowGraphs=[];for(let s of this._flowGraphs){let n={};s.serialize(n,t),e._flowGraphs.push(n)}e.dispatchEventsSynchronously=this.dispatchEventsSynchronously}get flowGraphs(){return this._flowGraphs}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new a,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t,s=!this.dispatchEventsSynchronously){if(s){this._executeOnNextFrame.push({id:e,data:t,uniqueId:this._eventUniqueId++});return}if(this._eventExecutionCounter.has(e)){let o=this._eventExecutionCounter.get(e);if(this._eventExecutionCounter.set(e,o+1),o>=i.MaxEventTypeExecutionPerFrame){o===i.MaxEventTypeExecutionPerFrame&&h.Warn(`FlowGraphCoordinator: Too many executions of event "${e}".`);return}}else this._eventExecutionCounter.set(e,1);let n=this._customEventsMap.get(e);n&&n.notifyObservers(t)}};c.MaxEventsPerType=30;c.MaxEventTypeExecutionPerFrame=30;c.SceneCoordinators=new Map});var v,Q=l(()=>{K();U();R();w();v=class extends P{constructor(e){super(e),this.config=e,this.initPriority=1;for(let t in this.config.eventData)this.registerDataOutput(t,this.config.eventData[t].type)}_preparePendingTasks(e){let t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(t&&t.hasObservers()&&t.observers.length>c.MaxEventsPerType){this._reportError(e,`FlowGraphReceiveCustomEventBlock: Too many observers for event ${this.config.eventId}. Max is ${c.MaxEventsPerType}.`);return}let s=t.add(n=>{let o=Object.keys(n);for(let r of o)this.getDataOutput(r)?.setValue(n[r],e);this._execute(e)});e._setExecutionVariable(this,"_eventObserver",s)}_cancelPendingTasks(e){let t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(t){let s=e._getExecutionVariable(this,"_eventObserver",null);t.remove(s)}else E.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`)}_executeEvent(e,t){return!0}getClassName(){return"FlowGraphReceiveCustomEventBlock"}};m("FlowGraphReceiveCustomEventBlock",v)});export{H as a,_ as b,S as c,d,q as e,A as f,b as g,G as h,c as i,w as j,v as k,Q as l};
