import{k as c,l as A}from"./chunk-RIAPI5OR.js";import{a as B,b as I}from"./chunk-TV2MNGU5.js";import{A as y,v as R}from"./chunk-DYR6BFEB.js";import{c as T,d as M}from"./chunk-2AUPWM7R.js";import{e as g}from"./chunk-FAF55DAL.js";var _,b,D=g(()=>{"use strict";_=(()=>{class r{constructor(e){this.length=0,this.data=new Array(e),this._id=r._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){let t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}}return r._GlobalId=0,r})(),b=class extends _{constructor(){super(...arguments),this._duplicateId=0}push(s){super.push(s),s.__smartArrayFlags||(s.__smartArrayFlags={}),s.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(s){return s.__smartArrayFlags&&s.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(s),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(s){if(s.length!==0){this.length+s.length>this.data.length&&(this.data.length=(this.length+s.length)*2);for(let e=0;e<s.length;e++){let t=(s.data||s)[e];this.pushNoDuplicate(t)}}}}});var F,E=g(()=>{"use strict";A();M();F=class{constructor(s){this._vertexBuffers={},this.onBeforeRenderObservable=new T,this._scene=s}_prepareBuffers(){if(this._vertexBuffers[c.PositionKind])return;let s=[];s.push(1,1),s.push(-1,1),s.push(-1,-1),s.push(1,-1),this._vertexBuffers[c.PositionKind]=new c(this._scene.getEngine(),s,c.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){let s=[];s.push(0),s.push(1),s.push(2),s.push(0),s.push(2),s.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(s)}_rebuild(){let s=this._vertexBuffers[c.PositionKind];s&&(s._rebuild(),this._buildIndexBuffer())}_prepareFrame(s=null,e=null){let t=this._scene.activeCamera;return!t||(e=e||t._postProcesses.filter(i=>i!=null),!e||e.length===0||!this._scene.postProcessesEnabled)?!1:(e[0].activate(t,s,e!=null),!0)}directRender(s,e=null,t=!1,i=0,f=0,p=!1,n=s.length){let l=this._scene.getEngine();for(let d=0;d<n;d++){d<s.length-1?s[d+1].activate(this._scene.activeCamera||this._scene,e?.texture):(e?l.bindFramebuffer(e,i,void 0,void 0,t,f):p||l.restoreDefaultFramebuffer(),l._debugInsertMarker?.(`post process ${s[d].name} output`));let a=s[d],o=a.apply();o&&(a.onBeforeRenderObservable.notifyObservers(o),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,o),l.drawElementsType(0,0,6),a.onAfterRenderObservable.notifyObservers(o))}l.setDepthBuffer(!0),l.setDepthWrite(!0)}_finalizeFrame(s,e,t,i,f=!1){let p=this._scene.activeCamera;if(!p||(this.onBeforeRenderObservable.notifyObservers(this),i=i||p._postProcesses.filter(l=>l!=null),i.length===0||!this._scene.postProcessesEnabled))return;let n=this._scene.getEngine();for(let l=0,d=i.length;l<d;l++){let a=i[l];if(l<d-1?a._outputTexture=i[l+1].activate(p,e?.texture):(e?(n.bindFramebuffer(e,t,void 0,void 0,f),a._outputTexture=e):(n.restoreDefaultFramebuffer(),a._outputTexture=null),n._debugInsertMarker?.(`post process ${i[l].name} output`)),s)break;let o=a.apply();o&&(a.onBeforeRenderObservable.notifyObservers(o),this._prepareBuffers(),n.bindBuffers(this._vertexBuffers,this._indexBuffer,o),n.drawElementsType(0,0,6),a.onAfterRenderObservable.notifyObservers(o))}n.setDepthBuffer(!0),n.setDepthWrite(!0),n.setAlphaMode(0)}dispose(){let s=this._vertexBuffers[c.PositionKind];s&&(s.dispose(),this._vertexBuffers[c.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}});var m,O=g(()=>{"use strict";D();y();m=class r{set opaqueSortCompareFn(s){s?this._opaqueSortCompareFn=s:this._opaqueSortCompareFn=r.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(s){s?this._alphaTestSortCompareFn=s:this._alphaTestSortCompareFn=r.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(s){s?this._transparentSortCompareFn=s:this._transparentSortCompareFn=r.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(s,e,t=null,i=null,f=null){this.index=s,this._opaqueSubMeshes=new _(256),this._transparentSubMeshes=new _(256),this._alphaTestSubMeshes=new _(256),this._depthOnlySubMeshes=new _(256),this._particleSystems=new _(256),this._spriteManagers=new _(256),this._empty=!0,this._edgesRenderers=new b(16),this.disableDepthPrePass=!1,this._scene=e,this.opaqueSortCompareFn=t,this.alphaTestSortCompareFn=i,this.transparentSortCompareFn=f}render(s,e,t,i,f=!0,p=!0,n=!0,l=!0,d){if(s){s(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}let a=this._scene.getEngine();f&&this._depthOnlySubMeshes.length!==0&&(a.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),a.setColorWrite(!0)),p&&this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),n&&this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);let o=a.getStencilBuffer();if(a.setStencilBuffer(!1),e&&this._renderSprites(),t&&this._renderParticles(i),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),l&&(d||this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency)){if(a.setStencilBuffer(o),d)d(this._transparentSubMeshes);else if(this._scene.useOrderIndependentTransparency){let h=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);h.length&&this._renderTransparent(h)}else this._renderTransparent(this._transparentSubMeshes);a.setAlphaMode(0)}if(a.setStencilBuffer(!1),p&&this._edgesRenderers.length){for(let h=0;h<this._edgesRenderers.length;h++)this._edgesRenderers.data[h].render();a.setAlphaMode(0)}a.setStencilBuffer(o)}_renderOpaqueSorted(s){r._RenderSorted(s,this._opaqueSortCompareFn,this._scene.activeCamera,!1,this.disableDepthPrePass)}_renderAlphaTestSorted(s){r._RenderSorted(s,this._alphaTestSortCompareFn,this._scene.activeCamera,!1,this.disableDepthPrePass)}_renderTransparentSorted(s){r._RenderSorted(s,this._transparentSortCompareFn,this._scene.activeCamera,!0,this.disableDepthPrePass)}static _RenderSorted(s,e,t,i,f){let p=0,n,l=t?t.globalPosition:r._ZeroVector;if(i)for(;p<s.length;p++)n=s.data[p],n._alphaIndex=n.getMesh().alphaIndex,n._distanceToCamera=R.Distance(n.getBoundingInfo().boundingSphere.centerWorld,l);let d=s.length===s.data.length?s.data:s.data.slice(0,s.length);e&&d.sort(e);let a=d[0].getMesh().getScene();for(p=0;p<d.length;p++)if(n=d[p],!(a._activeMeshesFrozenButKeepClipping&&!n.isInFrustum(a._frustumPlanes))){if(i){let o=n.getMaterial();if(o&&o.needDepthPrePass&&!f){let h=o.getScene().getEngine();h.setColorWrite(!1),h.setAlphaMode(0),n.render(!1),h.setColorWrite(!0)}}n.render(i)}}static defaultTransparentSortCompare(s,e){return s._alphaIndex>e._alphaIndex?1:s._alphaIndex<e._alphaIndex?-1:r.backToFrontSortCompare(s,e)}static backToFrontSortCompare(s,e){return s._distanceToCamera<e._distanceToCamera?1:s._distanceToCamera>e._distanceToCamera?-1:0}static frontToBackSortCompare(s,e){return s._distanceToCamera<e._distanceToCamera?-1:s._distanceToCamera>e._distanceToCamera?1:0}static PainterSortCompare(s,e){let t=s.getMesh(),i=e.getMesh();return t.material&&i.material?t.material.uniqueId-i.material.uniqueId:t.uniqueId-i.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(s,e,t){e===void 0&&(e=s.getMesh()),t===void 0&&(t=s.getMaterial()),t!=null&&(t.needAlphaBlendingForMesh(e)?this._transparentSubMeshes.push(s):t.needAlphaTestingForMesh(e)?(t.needDepthPrePass&&!this.disableDepthPrePass&&this._depthOnlySubMeshes.push(s),this._alphaTestSubMeshes.push(s)):(t.needDepthPrePass&&!this.disableDepthPrePass&&this._depthOnlySubMeshes.push(s),this._opaqueSubMeshes.push(s)),e._renderingGroup=this,e._edgesRenderer&&e.isEnabled()&&e.isVisible&&e._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(e._edgesRenderer),this._empty=!1)}dispatchSprites(s){this._spriteManagers.push(s),this._empty=!1}dispatchParticles(s){this._particleSystems.push(s),this._empty=!1}_renderParticles(s){if(this._particleSystems.length===0)return;let e=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._particleSystems.length;t++){let i=this._particleSystems.data[t];if((e&&e.layerMask&i.layerMask)===0)continue;let f=i.emitter;(!f.position||!s||s.indexOf(f)!==-1)&&this._scene._activeParticles.addCount(i.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;let s=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let e=0;e<this._spriteManagers.length;e++){let t=this._spriteManagers.data[e];(s&&s.layerMask&t.layerMask)!==0&&t.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}};m._ZeroVector=R.Zero()});var C,X,P=g(()=>{"use strict";O();C=class{},X=(()=>{class r{get disableDepthPrePass(){return this._disableDepthPrePass}set disableDepthPrePass(e){this._disableDepthPrePass=e;for(let t of this._renderingGroups)t.disableDepthPrePass=e}get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(let e of this._scene.meshes)if(e.subMeshes)for(let t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(let e of this._scene.spriteManagers)e._wasDispatched=!1;for(let e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._disableDepthPrePass=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new C,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=r.MIN_RENDERINGGROUPS;t<r.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}get renderingGroups(){return this._renderingGroups}getRenderingGroup(e){let t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,f,p=!0,n=!0,l=!0,d=!0,a){let o=this._renderingGroupInfo;if(o.scene=this._scene,o.camera=this._scene.activeCamera,o.renderingManager=this,this._scene.spriteManagers&&f)for(let h=0;h<this._scene.spriteManagers.length;h++){let S=this._scene.spriteManagers[h];this.dispatchSprites(S)}for(let h=r.MIN_RENDERINGGROUPS;h<r.MAX_RENDERINGGROUPS;h++){this._depthStencilBufferAlreadyCleaned=h===r.MIN_RENDERINGGROUPS;let S=this._renderingGroups[h];if(!S||S._empty)continue;let G=1<<h;if(o.renderingGroupId=h,this._scene.onBeforeRenderingGroupObservable.notifyObservers(o,G),r.AUTOCLEAR){let u=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(h):this._autoClearDepthStencil[h];u&&u.autoClear&&this._clearDepthStencilBuffer(u.depth,u.stencil)}for(let u of this._scene._beforeRenderingGroupDrawStage)u.action(h);S.render(e,f,i,t,p,n,l,d,a);for(let u of this._scene._afterRenderingGroupDrawStage)u.action(h);this._scene.onAfterRenderingGroupObservable.notifyObservers(o,G)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=r.MIN_RENDERINGGROUPS;e<r.MAX_RENDERINGGROUPS;e++){let t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=r.MIN_RENDERINGGROUPS;e<r.MAX_RENDERINGGROUPS;e++){let t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=r.MIN_RENDERINGGROUPS;e<r.MAX_RENDERINGGROUPS;e++){let t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new m(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]),this._renderingGroups[e].disableDepthPrePass=this._disableDepthPrePass)}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,f=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=f,this._renderingGroups[e]){let p=this._renderingGroups[e];p.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],p.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],p.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,f=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:f}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}return r.MAX_RENDERINGGROUPS=4,r.MIN_RENDERINGGROUPS=0,r.AUTOCLEAR=!0,r})()});var x,v=g(()=>{"use strict";I();x=class r{static GetPlanes(s){let e=[];for(let t=0;t<6;t++)e.push(new B(0,0,0,0));return r.GetPlanesToRef(s,e),e}static GetNearPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]+t[2],e.normal.y=t[7]+t[6],e.normal.z=t[11]+t[10],e.d=t[15]+t[14],e.normalize()}static GetFarPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]-t[2],e.normal.y=t[7]-t[6],e.normal.z=t[11]-t[10],e.d=t[15]-t[14],e.normalize()}static GetLeftPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]+t[0],e.normal.y=t[7]+t[4],e.normal.z=t[11]+t[8],e.d=t[15]+t[12],e.normalize()}static GetRightPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]-t[0],e.normal.y=t[7]-t[4],e.normal.z=t[11]-t[8],e.d=t[15]-t[12],e.normalize()}static GetTopPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]-t[1],e.normal.y=t[7]-t[5],e.normal.z=t[11]-t[9],e.d=t[15]-t[13],e.normalize()}static GetBottomPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]+t[1],e.normal.y=t[7]+t[5],e.normal.z=t[11]+t[9],e.d=t[15]+t[13],e.normalize()}static GetPlanesToRef(s,e){r.GetNearPlaneToRef(s,e[0]),r.GetFarPlaneToRef(s,e[1]),r.GetLeftPlaneToRef(s,e[2]),r.GetRightPlaneToRef(s,e[3]),r.GetTopPlaneToRef(s,e[4]),r.GetBottomPlaneToRef(s,e[5])}static IsPointInFrustum(s,e){for(let t=0;t<6;t++)if(e[t].dotCoordinate(s)<0)return!1;return!0}}});export{_ as a,b,D as c,F as d,E as e,m as f,O as g,C as h,X as i,P as j,x as k,v as l};
