import{a as ii,b as tn}from"./chunk-VFC5K5ZR.js";import{a as gt,b as wr}from"./chunk-YQJKR3JJ.js";import{a as ir,b as rr,d as sr}from"./chunk-W4CEKQI7.js";import{a as $n}from"./chunk-A2Q4EYXK.js";import{a as zn}from"./chunk-5BTRONOV.js";import{a as Vn}from"./chunk-UDNH2VER.js";import{a as Wn}from"./chunk-SEV7IZPG.js";import{a as kn}from"./chunk-YD7SUAXC.js";import{a as Nn}from"./chunk-4WKELFDE.js";import{a as Gn}from"./chunk-WXYTA4XG.js";import{a as On}from"./chunk-F5YF7352.js";import{a as er,b as fn}from"./chunk-QZRFFCXE.js";import{a as Ie,b as ni}from"./chunk-EELPIEAV.js";import{$ as En,A as vn,C as mr,D as Cn,K as An,L as Dn,M as Tn,N as Bn,O as Rn,P as Pn,Q as Fn,R as Ln,S as gr,T as _r,U as br,V as xr,W as yr,X as Ir,Y as Sr,Z as Mr,_ as vr,b as ar,d as mn,k as fr,la as Cr,m as In,pa as Un,s as pr,t as Sn,u as Mn}from"./chunk-I37SS3RD.js";import{a as mt,b as tr}from"./chunk-FLMKHUIX.js";import{a as or,b as gn,l as hr,m as dr,n as yn}from"./chunk-O64X2WXU.js";import{c as nr,d as pn}from"./chunk-NWJN3XMT.js";import{a as Ji,i as dn,j as ai,k as m,l as Pe}from"./chunk-RIAPI5OR.js";import{a as ji,b as hn}from"./chunk-EJMOGHUZ.js";import{e as He,f as en}from"./chunk-JB6X5724.js";import{a as Jt,b as ye,d as Gi}from"./chunk-EEF6RJTE.js";import{a as Y,b as ei,f as Ge,k as pt,p as Wi,s as Be,u as ti}from"./chunk-J2REHNP7.js";import{b as wn}from"./chunk-HFHHSAGS.js";import{c as he,f as Xi}from"./chunk-XGXGTYYM.js";import{f as Ni,g as ki,i as rn}from"./chunk-3GZP4BR5.js";import{D as Ki,E as an,F as qi,G as on,H as Yi,I as un,J as Hi,K as ln,N as Zi,O as cn,S as K,T as Re,V as H,W as Ve,d as ri,e as sn,f as $i,g as si,i as zi,l as nn}from"./chunk-WFRBO4E6.js";import{a as N,b as Vi}from"./chunk-2DQSP5HC.js";import{a as oi,b as _n,c as ur,d as bn}from"./chunk-RAQ2TJFV.js";import{A as _e,d as me,e as Pi,f as ge,h as jt,v as x,w as Ye,x as O,y as F,z as S}from"./chunk-DYR6BFEB.js";import{a as Fi,b as Li,d as Ei}from"./chunk-A2QYPOYP.js";import{c as Ui,d as Js}from"./chunk-YZFDUSX3.js";import{m as ft,z as Oi}from"./chunk-W4M4SCHI.js";import{d as re,e as lr,g as cr,i as xn}from"./chunk-CEUF5PRR.js";import{a as C,b as te}from"./chunk-MEUTOEEX.js";import{c as j,d as dt}from"./chunk-2AUPWM7R.js";import{a as We,b as Qi}from"./chunk-RR3YIVG4.js";import{a as z,b as qe,e as A}from"./chunk-FAF55DAL.js";var B,be=A(()=>{"use strict";Oi();B=class{static ComputeNumMipmapLevels(e,t){return ft(Math.max(e,t))+1}static GetTextureTypeFromFormat(e){switch(e){case"r8unorm":case"r8uint":case"rg8unorm":case"rg8uint":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8uint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"rgb9e5ufloat":case"rg11b10ufloat":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc5-rg-unorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc4-r-unorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-rg11unorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":case"stencil8":return 0;case"r8snorm":case"r8sint":case"rg8snorm":case"rg8sint":case"rgba8snorm":case"rgba8sint":case"bc6h-rgb-float":case"bc5-rg-snorm":case"bc4-r-snorm":case"eac-r11snorm":case"eac-rg11snorm":return 3;case"r16uint":case"r16unorm":case"rg16unorm":case"rgba16unorm":case"rg16uint":case"rgba16uint":case"depth16unorm":return 5;case"r16sint":case"r16snorm":case"rg16snorm":case"rgba16snorm":case"rg16sint":case"rgba16sint":return 4;case"r16float":case"rg16float":case"rgba16float":return 2;case"r32uint":case"rg32uint":case"rgba32uint":return 7;case"r32sint":case"rg32sint":case"rgba32sint":return 7;case"r32float":case"rg32float":case"rgba32float":case"depth32float":case"depth32float-stencil8":case"depth24plus":case"depth24plus-stencil8":return 1}return 0}static GetBlockInformationFromFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return{width:1,height:1,length:1};case"r16uint":case"r16sint":case"r16unorm":case"r16snorm":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":return{width:1,height:1,length:2};case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rg16unorm":case"rg16snorm":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb9e5ufloat":case"rgb10a2uint":case"rgb10a2unorm":case"rg11b10ufloat":return{width:1,height:1,length:4};case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba16unorm":case"rgba16snorm":return{width:1,height:1,length:8};case"rgba32uint":case"rgba32sint":case"rgba32float":return{width:1,height:1,length:16};case"stencil8":throw"No fixed size for Stencil8 format!";case"depth16unorm":return{width:1,height:1,length:2};case"depth24plus":throw"No fixed size for Depth24Plus format!";case"depth24plus-stencil8":throw"No fixed size for Depth24PlusStencil8 format!";case"depth32float":return{width:1,height:1,length:4};case"depth32float-stencil8":return{width:1,height:1,length:5};case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc5-rg-unorm":case"bc5-rg-snorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":return{width:4,height:4,length:16};case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":return{width:4,height:4,length:8};case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":return{width:4,height:4,length:8};case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-rg11unorm":case"eac-rg11snorm":return{width:4,height:4,length:16};case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":return{width:4,height:4,length:16};case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":return{width:5,height:4,length:16};case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":return{width:5,height:5,length:16};case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":return{width:6,height:5,length:16};case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":return{width:6,height:6,length:16};case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":return{width:8,height:5,length:16};case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":return{width:8,height:6,length:16};case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":return{width:8,height:8,length:16};case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":return{width:10,height:5,length:16};case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":return{width:10,height:6,length:16};case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":return{width:10,height:8,length:16};case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":return{width:10,height:10,length:16};case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":return{width:12,height:10,length:16};case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static IsHardwareTexture(e){return!!e.release}static IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return e.close!==void 0}static IsImageBitmapArray(e){return Array.isArray(e)&&e[0].close!==void 0}static IsCompressedFormat(e){switch(e){case"bc7-rgba-unorm-srgb":case"bc7-rgba-unorm":case"bc6h-rgb-float":case"bc6h-rgb-ufloat":case"bc5-rg-snorm":case"bc5-rg-unorm":case"bc4-r-snorm":case"bc4-r-unorm":case"bc3-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc1-rgba-unorm-srgb":case"bc1-rgba-unorm":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return"depth16unorm";case 16:return"depth24plus";case 13:return"depth24plus-stencil8";case 14:return"depth32float";case 18:return"depth32float-stencil8";case 19:return"stencil8";case 36492:return i?"bc7-rgba-unorm-srgb":"bc7-rgba-unorm";case 36495:return"bc6h-rgb-ufloat";case 36494:return"bc6h-rgb-float";case 33779:return i?"bc3-rgba-unorm-srgb":"bc3-rgba-unorm";case 33778:return i?"bc2-rgba-unorm-srgb":"bc2-rgba-unorm";case 33777:case 33776:return i?"bc1-rgba-unorm-srgb":"bc1-rgba-unorm";case 37808:return i?"astc-4x4-unorm-srgb":"astc-4x4-unorm";case 36196:case 37492:return i?"etc2-rgb8unorm-srgb":"etc2-rgb8unorm";case 37496:return i?"etc2-rgba8unorm-srgb":"etc2-rgba8unorm"}switch(e){case 3:switch(t){case 6:return"r8snorm";case 7:return"rg8snorm";case 4:throw"RGB format not supported in WebGPU";case 8:return"r8sint";case 9:return"rg8sint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8sint";default:return"rgba8snorm"}case 0:switch(t){case 6:return"r8unorm";case 7:return"rg8unorm";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?"rgba8unorm-srgb":"rgba8unorm";case 12:return i?"bgra8unorm-srgb":"bgra8unorm";case 8:return"r8uint";case 9:return"rg8uint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8uint";case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return"rgba8unorm"}case 4:switch(t){case 8:return"r16sint";case 9:return"rg16sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba16sint";default:return"rgba16sint"}case 5:switch(t){case 8:return"r16uint";case 9:return"rg16uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba16uint";default:return"rgba16uint"}case 6:switch(t){case 8:return"r32sint";case 9:return"rg32sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba32sint";default:return"rgba32sint"}case 7:switch(t){case 8:return"r32uint";case 9:return"rg32uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba32uint";default:return"rgba32uint"}case 1:switch(t){case 6:return"r32float";case 7:return"rg32float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return"rgba32float";default:return"rgba32float"}case 2:switch(t){case 6:return"r16float";case 7:return"rg16float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return"rgba16float";default:return"rgba16float"}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:switch(t){case 5:return"rg11b10ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV";default:return"rg11b10ufloat"}case 14:switch(t){case 5:return"rgb9e5ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV";default:return"rgb9e5ufloat"}case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:return"rgb10a2unorm";case 11:return"rgb10a2uint";default:return"rgb10a2unorm"}}return i?"rgba8unorm-srgb":"rgba8unorm"}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":case"bc4-r-unorm":case"bc4-r-snorm":case"r16uint":case"r16sint":case"depth16unorm":case"r16float":case"r16unorm":case"r16snorm":case"r32uint":case"r32sint":case"r32float":case"depth32float":case"stencil8":case"depth24plus":case"eac-r11unorm":case"eac-r11snorm":return 1;case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth32float-stencil8":case"bc5-rg-unorm":case"bc5-rg-snorm":case"rg16uint":case"rg16sint":case"rg16float":case"rg16unorm":case"rg16snorm":case"rg32uint":case"rg32sint":case"rg32float":case"depth24plus-stencil8":case"eac-rg11unorm":case"eac-rg11snorm":return 2;case"rgb9e5ufloat":case"rg11b10ufloat":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":return 3;case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgba16unorm":case"rgba16snorm":case"rgb10a2uint":case"rgb10a2unorm":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba32uint":case"rgba32sint":case"rgba32float":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case"stencil8":case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static HasDepthAspect(e){switch(e){case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static GetDepthFormatOnly(e){switch(e){case"depth16unorm":return"depth16unorm";case"depth24plus":return"depth24plus";case"depth24plus-stencil8":return"depth24plus";case"depth32float":return"depth32float";case"depth32float-stencil8":return"depth32float"}return e}static GetSample(e){return e>1?4:1}}});var P,de=A(()=>{"use strict";Ve();te();be();wr();P=class extends H{constructor(){super(...arguments),this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.dbgVerboseLogsForFirstFrames=!1,this._currentRenderPass=null,this._snapshotRenderingMode=0,this._timestampIndex=0}get enableGPUTimingMeasurements(){return this._timestampQuery.enable}set enableGPUTimingMeasurements(e){this._timestampQuery.enable!==e&&(this.gpuTimeInFrameForMainPass=e?new gt:void 0,this._timestampQuery.enable=e)}_currentPassIsMainPass(){return this._currentRenderTarget===null}_endCurrentRenderPass(){if(!this._currentRenderPass)return 0;let e=this._currentPassIsMainPass()?2:1;return!this._snapshotRendering.endRenderPass(this._currentRenderPass)&&!this.compatibilityMode&&(this._bundleList.run(this._currentRenderPass),this._bundleList.reset()),this._currentRenderPass.end(),this._timestampQuery.endPass(this._timestampIndex,this._currentRenderTarget&&this._currentRenderTarget.gpuTimeInFrame?this._currentRenderTarget.gpuTimeInFrame:this.gpuTimeInFrameForMainPass),this._timestampIndex+=2,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&C.Log("frame #"+this._count+" - "+(e===2?"main":"render target")+" end pass"+(e===1?" - internalTexture.uniqueId="+this._currentRenderTarget?.texture?.uniqueId:""))),this._currentRenderPass=null,e}_generateMipmaps(e,t){t=t??this._renderEncoder;let i=e._hardwareTexture;if(!i)return;t===this._renderEncoder&&this._endCurrentRenderPass();let r=B.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&C.Log("frame #"+this._count+" - generate mipmaps - width="+e.width+", height="+e.height+", isCube="+e.isCube+", command encoder="+(t===this._renderEncoder?"render":"copy"))),e.isCube?this._textureHelper.generateCubeMipmaps(i,r,t):this._textureHelper.generateMipmaps(i,r,0,t)}}});var Qn,Kn,qn,R,Yn,Hn,Zn,Xn,jn,Jn,ea,ta,ia,ra,sa,na,aa,oa,ua,la,ca,ha,da,fa,pa,ma,ga,_a,ba,xa,ya,Ia,Sa,Ma,va,Ca,wa,Aa,Da,Ta,Ba,Ne=A(()=>{"use strict";Qn=(function(s){return s.LowPower="low-power",s.HighPerformance="high-performance",s})(Qn||{}),Kn=(function(s){return s.CoreFeaturesAndLimits="core-features-and-limits",s.DepthClipControl="depth-clip-control",s.Depth32FloatStencil8="depth32float-stencil8",s.TextureCompressionBC="texture-compression-bc",s.TextureCompressionBCSliced3D="texture-compression-bc-sliced-3d",s.TextureCompressionETC2="texture-compression-etc2",s.TextureCompressionASTC="texture-compression-astc",s.TextureCompressionASTCSliced3D="texture-compression-astc-sliced-3d",s.TimestampQuery="timestamp-query",s.IndirectFirstInstance="indirect-first-instance",s.ShaderF16="shader-f16",s.RG11B10UFloatRenderable="rg11b10ufloat-renderable",s.BGRA8UnormStorage="bgra8unorm-storage",s.Float32Filterable="float32-filterable",s.Float32Blendable="float32-blendable",s.ClipDistances="clip-distances",s.DualSourceBlending="dual-source-blending",s.Subgroups="subgroups",s.TextureFormatsTier1="texture-formats-tier1",s.TextureFormatsTier2="texture-formats-tier2",s})(Kn||{}),qn=(function(s){return s.Unmapped="unmapped",s.Pending="pending",s.Mapped="mapped",s})(qn||{}),R=(function(s){return s[s.MapRead=1]="MapRead",s[s.MapWrite=2]="MapWrite",s[s.CopySrc=4]="CopySrc",s[s.CopyDst=8]="CopyDst",s[s.Index=16]="Index",s[s.Vertex=32]="Vertex",s[s.Uniform=64]="Uniform",s[s.Storage=128]="Storage",s[s.Indirect=256]="Indirect",s[s.QueryResolve=512]="QueryResolve",s})(R||{}),Yn=(function(s){return s[s.Read=1]="Read",s[s.Write=2]="Write",s})(Yn||{}),Hn=(function(s){return s.E1d="1d",s.E2d="2d",s.E3d="3d",s})(Hn||{}),Zn=(function(s){return s[s.CopySrc=1]="CopySrc",s[s.CopyDst=2]="CopyDst",s[s.TextureBinding=4]="TextureBinding",s[s.StorageBinding=8]="StorageBinding",s[s.RenderAttachment=16]="RenderAttachment",s})(Zn||{}),Xn=(function(s){return s.E1d="1d",s.E2d="2d",s.E2dArray="2d-array",s.Cube="cube",s.CubeArray="cube-array",s.E3d="3d",s})(Xn||{}),jn=(function(s){return s.All="all",s.StencilOnly="stencil-only",s.DepthOnly="depth-only",s})(jn||{}),Jn=(function(s){return s.R8Unorm="r8unorm",s.R8Snorm="r8snorm",s.R8Uint="r8uint",s.R8Sint="r8sint",s.R16Uint="r16uint",s.R16Sint="r16sint",s.R16Float="r16float",s.RG8Unorm="rg8unorm",s.RG8Snorm="rg8snorm",s.RG8Uint="rg8uint",s.RG8Sint="rg8sint",s.R16Unorm="r16unorm",s.R16Snorm="r16snorm",s.R32Uint="r32uint",s.R32Sint="r32sint",s.R32Float="r32float",s.RG16Uint="rg16uint",s.RG16Sint="rg16sint",s.RG16Float="rg16float",s.RGBA8Unorm="rgba8unorm",s.RGBA8UnormSRGB="rgba8unorm-srgb",s.RGBA8Snorm="rgba8snorm",s.RGBA8Uint="rgba8uint",s.RGBA8Sint="rgba8sint",s.BGRA8Unorm="bgra8unorm",s.BGRA8UnormSRGB="bgra8unorm-srgb",s.RG16Unorm="rg16unorm",s.RG16Snorm="rg16snorm",s.RGB9E5UFloat="rgb9e5ufloat",s.RGB10A2UINT="rgb10a2uint",s.RGB10A2Unorm="rgb10a2unorm",s.RG11B10UFloat="rg11b10ufloat",s.RG32Uint="rg32uint",s.RG32Sint="rg32sint",s.RG32Float="rg32float",s.RGBA16Uint="rgba16uint",s.RGBA16Sint="rgba16sint",s.RGBA16Float="rgba16float",s.RGBA16Unorm="rgba16unorm",s.RGBA16Snorm="rgba16snorm",s.RGBA32Uint="rgba32uint",s.RGBA32Sint="rgba32sint",s.RGBA32Float="rgba32float",s.Stencil8="stencil8",s.Depth16Unorm="depth16unorm",s.Depth24Plus="depth24plus",s.Depth24PlusStencil8="depth24plus-stencil8",s.Depth32Float="depth32float",s.BC1RGBAUnorm="bc1-rgba-unorm",s.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",s.BC2RGBAUnorm="bc2-rgba-unorm",s.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",s.BC3RGBAUnorm="bc3-rgba-unorm",s.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",s.BC4RUnorm="bc4-r-unorm",s.BC4RSnorm="bc4-r-snorm",s.BC5RGUnorm="bc5-rg-unorm",s.BC5RGSnorm="bc5-rg-snorm",s.BC6HRGBUFloat="bc6h-rgb-ufloat",s.BC6HRGBFloat="bc6h-rgb-float",s.BC7RGBAUnorm="bc7-rgba-unorm",s.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",s.ETC2RGB8Unorm="etc2-rgb8unorm",s.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",s.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",s.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",s.ETC2RGBA8Unorm="etc2-rgba8unorm",s.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",s.EACR11Unorm="eac-r11unorm",s.EACR11Snorm="eac-r11snorm",s.EACRG11Unorm="eac-rg11unorm",s.EACRG11Snorm="eac-rg11snorm",s.ASTC4x4Unorm="astc-4x4-unorm",s.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",s.ASTC5x4Unorm="astc-5x4-unorm",s.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",s.ASTC5x5Unorm="astc-5x5-unorm",s.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",s.ASTC6x5Unorm="astc-6x5-unorm",s.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",s.ASTC6x6Unorm="astc-6x6-unorm",s.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",s.ASTC8x5Unorm="astc-8x5-unorm",s.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",s.ASTC8x6Unorm="astc-8x6-unorm",s.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",s.ASTC8x8Unorm="astc-8x8-unorm",s.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",s.ASTC10x5Unorm="astc-10x5-unorm",s.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",s.ASTC10x6Unorm="astc-10x6-unorm",s.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",s.ASTC10x8Unorm="astc-10x8-unorm",s.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",s.ASTC10x10Unorm="astc-10x10-unorm",s.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",s.ASTC12x10Unorm="astc-12x10-unorm",s.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",s.ASTC12x12Unorm="astc-12x12-unorm",s.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",s.Depth32FloatStencil8="depth32float-stencil8",s})(Jn||{}),ea=(function(s){return s.ClampToEdge="clamp-to-edge",s.Repeat="repeat",s.MirrorRepeat="mirror-repeat",s})(ea||{}),ta=(function(s){return s.Nearest="nearest",s.Linear="linear",s})(ta||{}),ia=(function(s){return s.Nearest="nearest",s.Linear="linear",s})(ia||{}),ra=(function(s){return s.Never="never",s.Less="less",s.Equal="equal",s.LessEqual="less-equal",s.Greater="greater",s.NotEqual="not-equal",s.GreaterEqual="greater-equal",s.Always="always",s})(ra||{}),sa=(function(s){return s[s.Vertex=1]="Vertex",s[s.Fragment=2]="Fragment",s[s.Compute=4]="Compute",s})(sa||{}),na=(function(s){return s.Uniform="uniform",s.Storage="storage",s.ReadOnlyStorage="read-only-storage",s})(na||{}),aa=(function(s){return s.Filtering="filtering",s.NonFiltering="non-filtering",s.Comparison="comparison",s})(aa||{}),oa=(function(s){return s.Float="float",s.UnfilterableFloat="unfilterable-float",s.Depth="depth",s.Sint="sint",s.Uint="uint",s})(oa||{}),ua=(function(s){return s.WriteOnly="write-only",s.ReadOnly="read-only",s.ReadWrite="read-write",s})(ua||{}),la=(function(s){return s.Error="error",s.Warning="warning",s.Info="info",s})(la||{}),ca=(function(s){return s.Validation="validation",s.Internal="internal",s})(ca||{}),ha=(function(s){return s.Auto="auto",s})(ha||{}),da=(function(s){return s.PointList="point-list",s.LineList="line-list",s.LineStrip="line-strip",s.TriangleList="triangle-list",s.TriangleStrip="triangle-strip",s})(da||{}),fa=(function(s){return s.CCW="ccw",s.CW="cw",s})(fa||{}),pa=(function(s){return s.None="none",s.Front="front",s.Back="back",s})(pa||{}),ma=(function(s){return s[s.Red=1]="Red",s[s.Green=2]="Green",s[s.Blue=4]="Blue",s[s.Alpha=8]="Alpha",s[s.All=15]="All",s})(ma||{}),ga=(function(s){return s.Zero="zero",s.One="one",s.Src="src",s.OneMinusSrc="one-minus-src",s.SrcAlpha="src-alpha",s.OneMinusSrcAlpha="one-minus-src-alpha",s.Dst="dst",s.OneMinusDst="one-minus-dst",s.DstAlpha="dst-alpha",s.OneMinusDstAlpha="one-minus-dst-alpha",s.SrcAlphaSaturated="src-alpha-saturated",s.Constant="constant",s.OneMinusConstant="one-minus-constant",s.Src1="src1",s.OneMinusSrc1="one-minus-src1",s.Src1Alpha="src1-alpha",s.OneMinusSrc1Alpha="one-minus-src1-alpha",s})(ga||{}),_a=(function(s){return s.Add="add",s.Subtract="subtract",s.ReverseSubtract="reverse-subtract",s.Min="min",s.Max="max",s})(_a||{}),ba=(function(s){return s.Keep="keep",s.Zero="zero",s.Replace="replace",s.Invert="invert",s.IncrementClamp="increment-clamp",s.DecrementClamp="decrement-clamp",s.IncrementWrap="increment-wrap",s.DecrementWrap="decrement-wrap",s})(ba||{}),xa=(function(s){return s.Uint16="uint16",s.Uint32="uint32",s})(xa||{}),ya=(function(s){return s.Uint8="uint8",s.Uint8x2="uint8x2",s.Uint8x4="uint8x4",s.Sint8="sint8",s.Sint8x2="sint8x2",s.Sint8x4="sint8x4",s.Unorm8="unorm8",s.Unorm8x2="unorm8x2",s.Unorm8x4="unorm8x4",s.Snorm8="snorm8",s.Snorm8x2="snorm8x2",s.Snorm8x4="snorm8x4",s.Uint16="uint16",s.Uint16x2="uint16x2",s.Uint16x4="uint16x4",s.Sint16="sint16",s.Sint16x2="sint16x2",s.Sint16x4="sint16x4",s.Unorm16="unorm16",s.Unorm16x2="unorm16x2",s.Unorm16x4="unorm16x4",s.Snorm16="snorm16",s.Snorm16x2="snorm16x2",s.Snorm16x4="snorm16x4",s.Float16="float16",s.Float16x2="float16x2",s.Float16x4="float16x4",s.Float32="float32",s.Float32x2="float32x2",s.Float32x3="float32x3",s.Float32x4="float32x4",s.Uint32="uint32",s.Uint32x2="uint32x2",s.Uint32x3="uint32x3",s.Uint32x4="uint32x4",s.Sint32="sint32",s.Sint32x2="sint32x2",s.Sint32x3="sint32x3",s.Sint32x4="sint32x4",s.UNORM10x10x10x2="unorm10-10-10-2",s.UNORM8x4BGRA="unorm8x4-bgra",s})(ya||{}),Ia=(function(s){return s.Vertex="vertex",s.Instance="instance",s})(Ia||{}),Sa=(function(s){return s.Beginning="beginning",s.End="end",s})(Sa||{}),Ma=(function(s){return s.Beginning="beginning",s.End="end",s})(Ma||{}),va=(function(s){return s.Load="load",s.Clear="clear",s})(va||{}),Ca=(function(s){return s.Store="store",s.Discard="discard",s})(Ca||{}),wa=(function(s){return s.Occlusion="occlusion",s.Timestamp="timestamp",s})(wa||{}),Aa=(function(s){return s.Opaque="opaque",s.Premultiplied="premultiplied",s})(Aa||{}),Da=(function(s){return s.Standard="standard",s.Extended="extended",s})(Da||{}),Ta=(function(s){return s.Unknown="unknown",s.Destroyed="destroyed",s})(Ta||{}),Ba=(function(s){return s.Validation="validation",s.OutOfMemory="out-of-memory",s.Internal="internal",s})(Ba||{})});var q,Xe=A(()=>{"use strict";q=(()=>{class s{constructor(){this.shaderLanguage=0}_addUniformToLeftOverUBO(t,i,r){let n=0;[t,i,n]=this._getArraySize(t,i,r);for(let a=0;a<this._webgpuProcessingContext.leftOverUniforms.length;a++)if(this._webgpuProcessingContext.leftOverUniforms[a].name===t)return;this._webgpuProcessingContext.leftOverUniforms.push({name:t,type:i,length:n})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";let t=s.LeftOvertUBOName,i=this._webgpuProcessingContext.availableBuffers[t];return i||(i={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[t]=i,this._addBufferBindingDescription(t,i,"uniform",!0),this._addBufferBindingDescription(t,i,"uniform",!1)),this._generateLeftOverUBOCode(t,i)}_collectBindingNames(){for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){let i=this._webgpuProcessingContext.bindGroupLayoutEntries[t];if(i===void 0){this._webgpuProcessingContext.bindGroupLayoutEntries[t]=[];continue}for(let r=0;r<i.length;r++){let n=this._webgpuProcessingContext.bindGroupLayoutEntries[t][r],a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[t][n.binding].name,o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[t][n.binding].nameInArrayOfTexture;n&&(n.texture||n.externalTexture||n.storageTexture?this._webgpuProcessingContext.textureNames.push(o):n.sampler?this._webgpuProcessingContext.samplerNames.push(a):n.buffer&&this._webgpuProcessingContext.bufferNames.push(a))}}}_preCreateBindGroupEntries(){let t=this._webgpuProcessingContext.bindGroupEntries;for(let i=0;i<this._webgpuProcessingContext.bindGroupLayoutEntries.length;i++){let r=this._webgpuProcessingContext.bindGroupLayoutEntries[i],n=[];for(let a=0;a<r.length;a++){let o=this._webgpuProcessingContext.bindGroupLayoutEntries[i][a];o.sampler||o.texture||o.storageTexture||o.externalTexture?n.push({binding:o.binding,resource:void 0}):o.buffer&&n.push({binding:o.binding,resource:{buffer:void 0,offset:0,size:0}})}t[i]=n}}_addTextureBindingDescription(t,i,r,n,a,o){let{groupIndex:u,bindingIndex:l}=i.textures[r];if(this._webgpuProcessingContext.bindGroupLayoutEntries[u]||(this._webgpuProcessingContext.bindGroupLayoutEntries[u]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[u]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[u][l]){let c;n===null?c=this._webgpuProcessingContext.bindGroupLayoutEntries[u].push({binding:l,visibility:0,externalTexture:{}}):a?c=this._webgpuProcessingContext.bindGroupLayoutEntries[u].push({binding:l,visibility:0,storageTexture:{access:"write-only",format:a,viewDimension:n}}):c=this._webgpuProcessingContext.bindGroupLayoutEntries[u].push({binding:l,visibility:0,texture:{sampleType:i.sampleType,viewDimension:n,multisampled:!1}});let h=i.isTextureArray?t+r:t;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[u][l]={name:t,index:c-1,nameInArrayOfTexture:h}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[u][l].index,o?this._webgpuProcessingContext.bindGroupLayoutEntries[u][l].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[u][l].visibility|=2}_addSamplerBindingDescription(t,i,r){let{groupIndex:n,bindingIndex:a}=i.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[n]||(this._webgpuProcessingContext.bindGroupLayoutEntries[n]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][a]){let o=this._webgpuProcessingContext.bindGroupLayoutEntries[n].push({binding:a,visibility:0,sampler:{type:i.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][a]={name:t,index:o-1}}a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][a].index,r?this._webgpuProcessingContext.bindGroupLayoutEntries[n][a].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[n][a].visibility|=2}_addBufferBindingDescription(t,i,r,n){let{groupIndex:a,bindingIndex:o}=i.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[a]||(this._webgpuProcessingContext.bindGroupLayoutEntries[a]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o]){let u=this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,buffer:{type:r}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o]={name:t,index:u-1}}o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o].index,n?this._webgpuProcessingContext.bindGroupLayoutEntries[a][o].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[a][o].visibility|=2}}return s.LeftOvertUBOName="LeftOver",s.InternalsUBOName="Internals",s.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,uvec2:2,vec3:3,ivec3:3,uvec3:3,vec4:4,ivec4:4,uvec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16,mat2x2f:4,mat3x3f:12,mat4x4f:16,vec2i:2,vec3i:3,vec4i:4,vec2u:2,vec3u:3,vec4u:4,vec2f:2,vec3f:3,vec4f:4,vec2h:1,vec3h:2,vec4h:2},s._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},s._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},s._GpuTextureViewDimensionByWebGPUTextureType={textureCube:"cube",textureCubeArray:"cube-array",texture2D:"2d",texture2DArray:"2d-array",texture3D:"3d"},s._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},s._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1},s})()});var _t,Ar=A(()=>{"use strict";ni();Xe();_t=class{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this.bindGroupLayouts={},this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t,this.vertexBufferKindToType={}}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,r,n,a,o,u){let l=this.engine;l._doNotHandleContextLost&&(e._fragmentSourceCode="",e._vertexSourceCode="");let c=this.shaderProcessingContext.availableTextures,h;for(h=0;h<n.length;h++){let _=n[h],p=c[n[h]];p==null||p==null?(n.splice(h,1),h--):a[_]=h}for(let _ of l.getAttributes(this,o))u.push(_);this.buildUniformLayout();let f=[],d=[];for(h=0;h<o.length;h++){let _=u[h];_>=0&&(f.push(o[h]),d.push(_))}this.shaderProcessingContext.attributeNamesFromEffect=f,this.shaderProcessingContext.attributeLocationsFromEffect=d}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer?.dispose(),this.uniformBuffer=new Ie(this.engine,void 0,void 0,"leftOver-"+this._name);for(let e of this.shaderProcessingContext.leftOverUniforms){let t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),i=q.UniformSizes[t];this.uniformBuffer.addUniform(e.name,i,e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}setEngine(e){this.engine=e}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt3(e,t,i,r)}setInt4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt4(e,t,i,r,n)}setIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt3(e,t,i,r)}setUInt4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt4(e,t,i,r,n)}setUIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat3(e,t,i,r)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat4(e,t,i,r,n)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){return this.sources?.vertex}_getFragmentShaderCode(){return this.sources?.fragment}}});var Dr,fe,je=A(()=>{"use strict";Dr={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4},fe=(()=>{class s{static get KnownUBOs(){return s._SimplifiedKnownBindings?s._SimplifiedKnownUBOs:s._KnownUBOs}constructor(t,i=!1){this.vertexBufferKindToNumberOfComponents={},this.shaderLanguage=t,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],i||this._findStartingGroupBinding()}_findStartingGroupBinding(){let t=s.KnownUBOs,i=[];for(let r in t){let n=t[r].binding;n.groupIndex!==-1&&(i[n.groupIndex]===void 0?i[n.groupIndex]=n.bindingIndex:i[n.groupIndex]=Math.max(i[n.groupIndex],n.bindingIndex))}this.freeGroupIndex=i.length-1,this.freeGroupIndex===0?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=i[i.length-1]+1}getAttributeNextLocation(t,i=0){let r=this._attributeNextLocation;return this._attributeNextLocation+=(Dr[t]??1)*(i||1),r}getVaryingNextLocation(t,i=0){let r=this._varyingNextLocation;return this._varyingNextLocation+=(Dr[t]??1)*(i||1),r}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(t){if(this.freeBindingIndex>65536-t&&(this.freeGroupIndex++,this.freeBindingIndex=0),this.freeGroupIndex===4)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";let i={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=t,i}}return s._SimplifiedKnownBindings=!0,s._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},s._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}},s})()});function Je(s,e,t,i){let r=i,n=0,a="";for(;r<t.length;){let o=t.charAt(r);if(a)o===a?a==='"'||a==="'"?t.charAt(r-1)!=="\\"&&(a=""):a="":a==="*/"&&o==="*"&&r+1<t.length&&(t.charAt(r+1)==="/"&&(a=""),a===""&&r++);else switch(o){case s:n++;break;case e:n--;break;case'"':case"'":case"`":a=o;break;case"/":if(r+1<t.length){let u=t.charAt(r+1);u==="/"?a=`
`:u==="*"&&(a="*/")}break}if(r++,n===0)break}return n===0?r-1:-1}function ui(s,e){for(;e<s.length;){let t=s[e];if(t!==" "&&t!==`
`&&t!=="\r"&&t!=="	"&&t!==`
`&&t!=="\xA0")break;e++}return e}function bt(s){let e=s.charCodeAt(0);return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||e==95}function et(s){let e=0,t="",i=!1,r=[];for(;e<s.length;){let n=s.charAt(e);if(t)n===t?t==='"'||t==="'"?(s.charAt(e-1)!=="\\"&&(t=""),r.push(n)):(t="",i=!1):t==="*/"&&n==="*"&&e+1<s.length?(s.charAt(e+1)==="/"&&(t=""),t===""&&(i=!1,e++)):i||r.push(n);else{switch(n){case'"':case"'":case"`":t=n;break;case"/":if(e+1<s.length){let a=s.charAt(e+1);a==="/"?(t=`
`,i=!0):a==="*"&&(t="*/",i=!0)}break}i||r.push(n)}e++}return r.join("")}function Tr(s,e,t,i){for(;e>=0&&s.charAt(e)!==t&&(!i||s.charAt(e)!==i);)e--;return e}function Br(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function tt(s,e,t,i){let r=s.indexOf(e);if(r<0)return s;if(t){for(;r++<s.length&&s.charAt(r)!="{";);if(r<s.length){let n=s.substring(0,r+1),a=s.substring(r+1);s=n+t+a}}if(i){let n=s.lastIndexOf("}");s=s.substring(0,n),s+=i+`
}`}return s}var xt=A(()=>{"use strict"});var yt,Rr=A(()=>{"use strict";je();te();Xe();xt();yt=class extends q{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=0,this.parseGLES3=!0}_getArraySize(e,t,i){let r=0,n=e.indexOf("["),a=e.indexOf("]");if(n>0&&a>0){let o=e.substring(n+1,a);r=+o,isNaN(r)&&(r=+i[o.trim()]),e=e.substring(0,n)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){let i=`// Internals UBO
uniform ${q.InternalsUBOName} {
float yFactor_;
float textureOutputHeight_;
};
`,r=e.indexOf("// Internals UBO")!==-1;return t?(this._fragmentIsGLES3=e.indexOf("#version 3")!==-1,this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),r?e:i+`##INJECTCODE##
`+e):(this._vertexIsGLES3=e.indexOf("#version 3")!==-1,this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),r?e:i+e)}varyingCheck(e,t){let i=/(flat\s)?\s*\bout\b/,r=/(flat\s)?\s*\bin\b/,n=/(flat\s)?\s*\bvarying\b/;return(t&&this._fragmentIsGLES3?r:!t&&this._vertexIsGLES3?i:n).test(e)}varyingProcessor(e,t,i){this._preProcessors=i;let r=/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,n=/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,a=/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,u=(t&&this._fragmentIsGLES3?n:!t&&this._vertexIsGLES3?r:a).exec(e);if(u!==null){let l=u[1]??"",c=u[2],h=u[3],f;t?(f=this._webgpuProcessingContext.availableVaryings[h],this._missingVaryings[f]="",f===void 0&&C.Warn(`Invalid fragment shader: The varying named "${h}" is not declared in the vertex shader! This declaration will be ignored.`)):(f=this._webgpuProcessingContext.getVaryingNextLocation(c,this._getArraySize(h,c,i)[2]),this._webgpuProcessingContext.availableVaryings[h]=f,this._missingVaryings[f]=`layout(location = ${f}) ${l} in ${c} ${h};`),e=e.replace(u[0],f===void 0?"":`layout(location = ${f}) ${l} ${t?"in":"out"} ${c} ${h};`)}return e}attributeProcessor(e,t){this._preProcessors=t;let i=/\s*in\s+(\S+)\s+(\S+)\s*;/gm,r=/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm,a=(this._vertexIsGLES3?i:r).exec(e);if(a!==null){let o=a[1],u=a[2],l=this._webgpuProcessingContext.getAttributeNextLocation(o,this._getArraySize(u,o,t)[2]);this._webgpuProcessingContext.availableAttributes[u]=l,this._webgpuProcessingContext.orderedAttributes[l]=u;let c=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[u];if(c!==void 0){let h=c<0?c===-1?"int":"ivec"+-c:c===1?"uint":"uvec"+c,f=`_int_${u}_`;e=e.replace(a[0],`layout(location = ${l}) in ${h} ${f}; ${o} ${u} = ${o}(${f});`)}else e=e.replace(a[0],`layout(location = ${l}) in ${o} ${u};`)}return e}uniformProcessor(e,t,i){this._preProcessors=i;let n=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(n!==null){let a=n[1],o=n[2];if(a.indexOf("sampler")===0||a.indexOf("sampler")===1){let u=0;[o,a,u]=this._getArraySize(o,a,i);let l=this._webgpuProcessingContext.availableTextures[o];if(!l){l={autoBindSampler:!0,isTextureArray:u>0,isStorageTexture:!1,textures:[],sampleType:"float"};for(let D=0;D<(u||1);++D)l.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}let c=q._SamplerTypeByWebGLSamplerType[a]??"sampler",h=!!q._IsComparisonSamplerByWebGPUSamplerType[c],f=h?"comparison":"filtering",d=o+"Sampler",_=this._webgpuProcessingContext.availableSamplers[d];_||(_={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:f});let p=a.charAt(0)==="u"?"u":a.charAt(0)==="i"?"i":"";p&&(a=a.substring(1));let g=h?"depth":p==="u"?"uint":p==="i"?"sint":"float";l.sampleType=g;let b=u>0,y=_.binding.groupIndex,M=_.binding.bindingIndex,w=q._SamplerFunctionByWebGLSamplerType[a],I=q._TextureTypeByWebGLSamplerType[a],v=q._GpuTextureViewDimensionByWebGPUTextureType[I];if(!b)u=1,e=`layout(set = ${y}, binding = ${M}) uniform ${c} ${d};
                        layout(set = ${l.textures[0].groupIndex}, binding = ${l.textures[0].bindingIndex}) uniform ${p}${I} ${o}Texture;
                        #define ${o} ${p}${w}(${o}Texture, ${d})`;else{let D=[];D.push(`layout(set = ${y}, binding = ${M}) uniform ${p}${c} ${d};`),e=`
`;for(let T=0;T<u;++T){let W=l.textures[T].groupIndex,E=l.textures[T].bindingIndex;D.push(`layout(set = ${W}, binding = ${E}) uniform ${I} ${o}Texture${T};`),e+=`${T>0?`
`:""}#define ${o}${T} ${p}${w}(${o}Texture${T}, ${d})`}e=D.join(`
`)+e,this._textureArrayProcessing.push(o)}this._webgpuProcessingContext.availableTextures[o]=l,this._webgpuProcessingContext.availableSamplers[d]=_,this._addSamplerBindingDescription(d,_,!t);for(let D=0;D<u;++D)this._addTextureBindingDescription(o,l,D,v,null,!t)}else this._addUniformToLeftOverUBO(o,a,i),e=""}return e}uniformBufferProcessor(e,t){let r=/uniform\s+(\w+)/gm.exec(e);if(r!==null){let n=r[1],a=this._webgpuProcessingContext.availableBuffers[n];if(!a){let o=fe.KnownUBOs[n],u;o&&o.binding.groupIndex!==-1?u=o.binding:u=this._webgpuProcessingContext.getNextFreeUBOBinding(),a={binding:u},this._webgpuProcessingContext.availableBuffers[n]=a}this._addBufferBindingDescription(n,a,"uniform",!t),e=e.replace("uniform",`layout(set = ${a.binding.groupIndex}, binding = ${a.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,r,n,a){let o=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,u=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(u,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){let l=e.indexOf("gl_FragCoord")>=0,c=`
                glFragCoord_ = gl_FragCoord;
                if (yFactor_ == 1.) {
                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;
                }
            `,h=l?`vec4 glFragCoord_;
`:"",f=e.search(/layout *\(location *= *0\) *out/g)!==-1;if(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/gl_FragCoord/g,"glFragCoord_"),!this._fragmentIsGLES3)e=e.replace(/void\s+?main\s*\(/g,(o||f?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else{let d=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);d!==null&&(e=e.substring(0,d.index)+"layout(location = 0) "+e.substring(d.index))}e=e.replace(/dFdy/g,"(-yFactor_)*dFdy"),e=e.replace("##INJECTCODE##",h),l&&(e=tt(e,"void main",c))}else if("VERTEXOUTPUT_INVARIANT"in a&&(e=`invariant gl_Position;
`+e),e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex"),e=e.replace(/gl_VertexID/g,"gl_VertexIndex"),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;if(!i){let l=e.lastIndexOf("}");e=e.substring(0,l),e+=`gl_Position.y *= yFactor_;
`,e+="}"}return e}_applyTextureArrayProcessing(e,t){let i=new RegExp(t+"\\s*\\[(.+)?\\]","gm"),r=i.exec(e);for(;r!==null;){let n=r[1],a=+n;this._preProcessors&&isNaN(a)&&(a=+this._preProcessors[n.trim()]),e=e.replace(r[0],t+a),r=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {
    `;for(let r of this._webgpuProcessingContext.leftOverUniforms)r.length>0?i+=`    ${r.type} ${r.name}[${r.length}];
`:i+=`    ${r.type} ${r.name};
`;return i+=`};

`,i}finalizeShaders(e,t){for(let r=0;r<this._textureArrayProcessing.length;++r){let n=this._textureArrayProcessing[r];e=this._applyTextureArrayProcessing(e,n),t=this._applyTextureArrayProcessing(t,n)}for(let r=0;r<this._missingVaryings.length;++r){let n=this._missingVaryings[r];n&&n.length>0&&(t=n+`
`+t)}let i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}}});var Pr,Ra,Pa,Fa,It,Fr=A(()=>{"use strict";je();te();Xe();xt();Wn();kn();Vn();Nn();wn();$n();Gn();On();zn();Pr="fragmentOutputs.fragDepth",Ra="uniforms",Pa="internals",Fa={texture_1d:"1d",texture_2d:"2d",texture_2d_array:"2d-array",texture_3d:"3d",texture_cube:"cube",texture_cube_array:"cube-array",texture_multisampled_2d:"2d",texture_depth_2d:"2d",texture_depth_2d_array:"2d-array",texture_depth_cube:"cube",texture_depth_cube_array:"cube-array",texture_depth_multisampled_2d:"2d",texture_storage_1d:"1d",texture_storage_2d:"2d",texture_storage_2d_array:"2d-array",texture_storage_3d:"3d",texture_external:null},It=class extends q{constructor(){super(...arguments),this.shaderLanguage=1,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0,this.pureMode=!1}_getArraySize(e,t,i){let r=0,n=t.lastIndexOf(">");if(t.indexOf("array")>=0&&n>0){let a=n;for(;a>0&&t.charAt(a)!==" "&&t.charAt(a)!==",";)a--;let o=t.substring(a+1,n);for(r=+o,isNaN(r)&&(r=+i[o.trim()]);a>0&&(t.charAt(a)===" "||t.charAt(a)===",");)a--;t=t.substring(t.indexOf("<")+1,a+1)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=!1,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){let t=this.pureMode?"":`struct ${q.InternalsUBOName} {
  yFactor_: f32,
  textureOutputHeight_: f32,
};
var<uniform> ${Pa} : ${q.InternalsUBOName};
`;return e.indexOf(t)!==-1?e:t+et(e)}varyingCheck(e){return/(flat|linear|perspective)?\s*(center|centroid|sample)?\s*\bvarying\b/.test(e)}varyingProcessor(e,t,i){let n=/\s*(flat|linear|perspective)?\s*(center|centroid|sample)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(n!==null){let a=n[1]??"perspective",o=n[2]??"center",u=n[4],l=n[3],c=a==="flat"?`@interpolate(${a})`:`@interpolate(${a}, ${o})`,h;t?(h=this._webgpuProcessingContext.availableVaryings[l],h===void 0&&C.Warn(`Invalid fragment shader: The varying named "${l}" is not declared in the vertex shader! This declaration will be ignored.`)):(h=this._webgpuProcessingContext.getVaryingNextLocation(u,this._getArraySize(l,u,i)[2]),this._webgpuProcessingContext.availableVaryings[l]=h,this._varyingsWGSL.push(`  @location(${h}) ${c} ${l} : ${u},`),this._varyingNamesWGSL.push(l)),e=""}return e}attributeProcessor(e,t){let r=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(r!==null){let n=r[2],a=r[1],o=this._webgpuProcessingContext.getAttributeNextLocation(n,this._getArraySize(a,n,t)[2]);this._webgpuProcessingContext.availableAttributes[a]=o,this._webgpuProcessingContext.orderedAttributes[o]=a;let u=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[a];if(u!==void 0){let l=u<0?u===-1?"i32":"vec"+-u+"<i32>":u===1?"u32":"vec"+u+"<u32>",c=`_int_${a}_`;this._attributesInputWGSL.push(`@location(${o}) ${c} : ${l},`),this._attributesWGSL.push(`${a} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${a} = ${n}(vertexInputs_.${c});`),this._hasNonFloatAttribute=!0}else this._attributesInputWGSL.push(`@location(${o}) ${a} : ${n},`),this._attributesWGSL.push(`${a} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${a} = vertexInputs_.${a};`);e=""}return e}uniformProcessor(e,t,i){let r=this.uniformRegexp.exec(e);if(r!==null){let n=r[2],a=r[1];this._addUniformToLeftOverUBO(a,n,i),e=""}return e}textureProcessor(e,t,i){let r=this.textureRegexp.exec(e);if(r!==null){let n=r[1],a=r[2],o=!!r[3],u=r[4],l=u.indexOf("storage")>0,c=r[6],h=l?c.substring(0,c.indexOf(",")).trim():null,f=o?this._getArraySize(n,a,i)[2]:0,d=this._webgpuProcessingContext.availableTextures[n];if(d)f=d.textures.length;else{d={isTextureArray:f>0,isStorageTexture:l,textures:[],sampleType:"float"},f=f||1;for(let b=0;b<f;++b)d.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[n]=d;let _=u.indexOf("depth")>0,p=Fa[u],g=_?"depth":c==="u32"?"uint":c==="i32"?"sint":"float";if(d.sampleType=g,p===void 0)throw`Can't get the texture dimension corresponding to the texture function "${u}"!`;for(let b=0;b<f;++b){let{groupIndex:y,bindingIndex:M}=d.textures[b];b===0&&(e=`@group(${y}) @binding(${M}) ${e}`),this._addTextureBindingDescription(n,d,b,p,h,!t)}}return e}_convertDefinesToConst(e){let t="";for(let i in e){let r=e[i];i.startsWith("__")||(!isNaN(parseInt(r))||!isNaN(parseFloat(r))?t+=`const ${i} = ${r};
`:i&&r===""&&(t+=`const ${i} = true;
`))}return t}postProcessor(e,t,i,r,n,a,o){let u=[];for(let l in o)o[l]!=="true"&&u.push(l);u.sort((l,c)=>l.length-c.length>0?-1:l.length===c.length?0:1);for(let l of u){let c=e.indexOf("#define "+l),h=e.indexOf(`
`,c);h===-1&&(h=e.length);let f=e.substring(c+8+l.length+1,h);e=e.replace(new RegExp(l,"g"),f)}return e=this._convertDefinesToConst(a)+e,"VERTEXOUTPUT_INVARIANT"in a&&(e=`#define VERTEXOUTPUT_INVARIANT
`+e),e}finalizeShaders(e,t){let i=[],r=t.indexOf("fragmentInputs.position")>=0&&!this.pureMode?`
            if (internals.yFactor_ == 1.) {
                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;
            }
        `:"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);let n=this._buildLeftOverUBO();e=n+e,t=n+t,e=e.replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let a=`struct VertexInputs {
  @builtin(vertex_index) vertexIndex : u32,
  @builtin(instance_index) instanceIndex : u32,
`;this._attributesInputWGSL.length>0&&(a+=this._attributesInputWGSL.join(`
`)),a+=`
};
var<private> vertexInputs`+(this._hasNonFloatAttribute?"_":"")+` : VertexInputs;
`,this._hasNonFloatAttribute&&(a+=`struct VertexInputs_ {
  vertexIndex : u32, instanceIndex : u32,
`,a+=this._attributesWGSL.join(`
`),a+=`
};
var<private> vertexInputs : VertexInputs_;
`);let o=`struct FragmentInputs {
  @builtin(position)`+(e.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0?" @invariant":"")+` position : vec4<f32>,
`;this._varyingsWGSL.length>0&&(o+=this._varyingsWGSL.join(`
`)),o+=`
};
var<private> vertexOutputs : FragmentInputs;
`,e=a+o+e;let u=`
  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;
`;this._hasNonFloatAttribute&&(u+=`vertexInputs.vertexIndex = vertexInputs_.vertexIndex;
vertexInputs.instanceIndex = vertexInputs_.instanceIndex;
`,u+=this._attributesConversionCodeWGSL.join(`
`),u+=`
`);let l=this.pureMode?"  return vertexOutputs;":`  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;
  return vertexOutputs;`,c=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")!==-1;e=(c?`diagnostic(off, derivative_uniformity);
`:"")+`diagnostic(off, chromium.unreachable_code);
`+tt(e,"fn main",u,l),t=t.replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),this.pureMode||(t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy"));let h=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
  @builtin(front_facing) frontFacing : bool,
`;this._varyingsWGSL.length>0&&(h+=this._varyingsWGSL.join(`
`)),h+=`
};
var<private> fragmentInputs : FragmentInputs;
`;let f=`struct FragmentOutputs {
`,d="fragmentOutputs\\.fragData",_=t.match(new RegExp(d+"0","g")),p=0;if(_){f+=` @location(${p}) fragData0 : vec4<f32>,
`,p++;for(let I=1;I<8;I++)_=t.match(new RegExp(d+I,"g")),_&&(f+=` @location(${p}) fragData${p} : vec4<f32>,
`,p++);t.indexOf("MRT_AND_COLOR")!==-1&&(f+=`  @location(${p}) color : vec4<f32>,
`,p++)}let g=/oitDepthSampler/;_=t.match(g),_&&(f+=` @location(${p++}) depth : vec2<f32>,
`,f+=` @location(${p++}) frontColor : vec4<f32>,
`,f+=` @location(${p++}) backColor : vec4<f32>,
`),p===0&&(t.indexOf("DUAL_SOURCE_BLENDING")!==-1?(i.push("dual_source_blending"),f+=`  @location(0) @blend_src(0) color : vec4<f32>,
`,f+=`  @location(0) @blend_src(1) color2 : vec4<f32>,
`):f+=`  @location(0) color : vec4<f32>,
`,p++);let b=!1,y=0;for(;!b&&(y=t.indexOf(Pr,y),!(y<0));){let I=y;for(b=!0;y>1&&t.charAt(y)!==`
`;){if(t.charAt(y)==="/"&&t.charAt(y-1)==="/"){b=!1;break}y--}y=I+Pr.length}b&&(f+=`  @builtin(frag_depth) fragDepth: f32,
`),f+=`};
var<private> fragmentOutputs : FragmentOutputs;
`,t=h+f+t;let M=`  fragmentInputs = input;
  `+r,w="  return fragmentOutputs;";return c=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")!==-1,i.length>0&&(t="enable "+i.join(`;
enable `)+`;
`+t),t=(c?`diagnostic(off, derivative_uniformity);
`:"")+`diagnostic(off, chromium.unreachable_code);
`+tt(t,"fn main",M,w),this._collectBindingNames(),this._preCreateBindGroupEntries(),this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",r=`struct ${e} {
`;for(let n of this._webgpuProcessingContext.leftOverUniforms){let a=n.type.replace(/^(.*?)(<.*>)?$/,"$1"),o=q.UniformSizes[a];if(n.length>0)if(o<=2){let u=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${u} {
                        @size(16)
                        el: ${a},
                    }`,this._stridedUniformArrays.push(n.name),r+=` @align(16) ${n.name} : array<${u}, ${n.length}>,
`}else r+=` ${n.name} : array<${n.type}, ${n.length}>,
`;else r+=`  ${n.name} : ${n.type},
`}return r+=`};
`,r=`${i}
${r}`,r+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> ${Ra} : ${e};
`,r}_processSamplers(e,t){let i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){let r=i.exec(e);if(r===null)break;let n=r[1],a=r[2],o=n.length-7,u=n.lastIndexOf("Sampler")===o?n.substring(0,o):null,l=a==="sampler_comparison"?"comparison":"filtering";if(u){let _=this._webgpuProcessingContext.availableTextures[u];_&&(_.autoBindSampler=!0)}let c=this._webgpuProcessingContext.availableSamplers[n];c||(c={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:l},this._webgpuProcessingContext.availableSamplers[n]=c),this._addSamplerBindingDescription(n,c,t);let h=e.substring(0,r.index),f=`@group(${c.binding.groupIndex}) @binding(${c.binding.bindingIndex}) `,d=e.substring(r.index);e=h+f+d,i.lastIndex+=f.length}return e}_processCustomBuffers(e,t){let i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){let r=i.exec(e);if(r===null)break;let n=r[1],a=r[3],o=r[4],u=r[5],l=this._webgpuProcessingContext.availableBuffers[o];if(!l){let p=n==="uniform"?fe.KnownUBOs[u]:null,g;p?(o=u,g=p.binding,g.groupIndex===-1&&(g=this._webgpuProcessingContext.availableBuffers[o]?.binding,g||(g=this._webgpuProcessingContext.getNextFreeUBOBinding()))):g=this._webgpuProcessingContext.getNextFreeUBOBinding(),l={binding:g},this._webgpuProcessingContext.availableBuffers[o]=l}this._addBufferBindingDescription(o,this._webgpuProcessingContext.availableBuffers[o],a==="read_write"?"storage":n==="storage"?"read-only-storage":"uniform",t);let c=l.binding.groupIndex,h=l.binding.bindingIndex,f=e.substring(0,r.index),d=`@group(${c}) @binding(${h}) `,_=e.substring(r.index);e=f+d+_,i.lastIndex+=d.length}return e}_processStridedUniformArrays(e){for(let t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*?)\\]`,"g"),`${t}[$1].el`);return e}}});var Se,li=A(()=>{"use strict";Oi();be();Se=class{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e,t=0){return this._webgpuMSAATexture[t]||this._createMSAATexture(e,t),this._webgpuMSAATexture[t]}releaseMSAATextures(){for(let e of this._webgpuMSAATexture)e&&this._engine._textureHelper.releaseTexture(e);this._webgpuMSAATexture.length=0}constructor(e,t=null){this._engine=e,this._originalFormatIsRGB=!1,this.format="rgba8unorm",this.originalFormat="rgba8unorm",this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=t,this._webgpuMSAATexture=[],this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,r,n,a,o,u){let l="2d",c=1;r?(l=i?"cube-array":"cube",c=6*(u||1)):n?(l="3d",c=1):i&&(l="2d-array",c=u);let h=B.GetDepthFormatOnly(this.format),f=B.HasDepthAndStencilAspects(this.format)?"depth-only":"all";this.createView({label:`TextureView${n?"3D":r?"Cube":"2D"}${i?"_Array"+c:""}_${a}x${o}_${t?"wmips":"womips"}_${this.format}_${l}`,format:h,dimension:l,mipLevelCount:t?ft(Math.max(a,o))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:c,aspect:f})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){let i=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=i}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture.length=0,this.view=null,this.viewForWriting=null}release(){this._webgpuTexture?.destroy(),this.releaseMSAATextures(),this._copyInvertYTempTexture?.destroy(),this.reset()}_createMSAATexture(e,t){if(!this._webgpuTexture)throw new Error("Cannot create GPU MSAA texture because underlying GPU texture is not created yet.");this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),this._webgpuMSAATexture[t]=this._engine._textureHelper.createMSAATexture(this._webgpuTexture,this.originalFormat,e)}}});var La,Ea,Er,Ua,Oa,Ga,Wa,Va,Na,ka,$a,za,Qa,se,it,Lr,ne,St,Mt=A(()=>{"use strict";Ne();li();be();nn();La=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    varying vTex: vec2f;

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.vTex = tex[input.vertexIndex];
        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,Ea=`
    var imgSampler: sampler;
    var img: texture_2d<f32>;

    varying vTex: vec2f;

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = textureSample(img, imgSampler, input.vTex);
    }
    `,Er=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        #ifdef INVERTY
            vertexOutputs.vTextureSize = vec2f(textureDimensions(img, 0));
        #endif
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,Ua=`
    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(input.vTextureSize.y - input.position.y)), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,Oa=Er,Ga=`
    var img: texture_2d<f32>;
    uniform ofstX: f32;
    uniform ofstY: f32;
    uniform width: f32;
    uniform height: f32;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        if (input.position.x < uniforms.ofstX || input.position.x >= uniforms.ofstX + uniforms.width) {
            discard;
        }
        if (input.position.y < uniforms.ofstY || input.position.y >= uniforms.ofstY + uniforms.height) {
            discard;
        }
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(uniforms.ofstY + uniforms.height - (input.position.y - uniforms.ofstY))), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,Wa=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,Va=`
    uniform color: vec4f;

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = uniforms.color;
    }
    `,Na=`
    struct VertexOutput {
        @builtin(position) Position : vec4<f32>,
        @location(0) fragUV : vec2<f32>
    }

    @vertex
    fn main(
        @builtin(vertex_index) VertexIndex : u32
    ) -> VertexOutput {
        var pos = array<vec2<f32>, 4>(
            vec2(-1.0,  1.0),
            vec2( 1.0,  1.0),
            vec2(-1.0, -1.0),
            vec2( 1.0, -1.0)
        );
        var tex = array<vec2<f32>, 4>(
            vec2(0.0, 0.0),
            vec2(1.0, 0.0),
            vec2(0.0, 1.0),
            vec2(1.0, 1.0)
        );

        var output: VertexOutput;

        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);
        output.fragUV = tex[VertexIndex];

        return output;
    }
    `,ka=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);
    }
    `,$a=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));
    }
    `,za=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,Qa=`
    var msaaDepthTexture: texture_depth_multisampled_2d;

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
    #ifdef USE_MIN
        let numSamples = textureNumSamples(msaaDepthTexture);
        var depth = 1.0;

        for (var i = 0u; i < numSamples; i = i + 1u) {
            depth = min(depth, textureLoad(msaaDepthTexture, vec2u(input.position.xy), i));
        }
        
        fragmentOutputs.color = vec4f(depth);
    #else
        fragmentOutputs.color = vec4f(textureLoad(msaaDepthTexture, vec2u(input.position.xy), 0)); // do like WebGL, take the first sample
    #endif
    }
    `,se=(function(s){return s[s.MipMap=0]="MipMap",s[s.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",s[s.Clear=2]="Clear",s[s.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst",s[s.ResolveDepth=4]="ResolveDepth",s})(se||{}),it=(function(s){return s[s.DontInvertY=0]="DontInvertY",s[s.InvertY=1]="InvertY",s})(it||{}),Lr=[{vertex:La,fragment:Ea},{vertex:Er,fragment:Ua},{vertex:Wa,fragment:Va},{vertex:Oa,fragment:Ga},{vertex:za,fragment:Qa}],ne={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38,r16unorm:39,rg16unorm:40,rgba16unorm:41,r16snorm:42,rg16snorm:43,rgba16snorm:44},St=class{constructor(e,t,i,r){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._engine=e,this._device=t,this._bufferManager=i,r.indexOf("rg11b10ufloat-renderable")!==-1){let n=Object.keys(ne);ne.rg11b10ufloat=ne[n[n.length-1]]+1}this._mipmapSampler=t.createSampler({minFilter:"linear"}),this._videoSampler=t.createSampler({minFilter:"linear"}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,R.Uniform|R.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline("rgba8unorm"),this._getVideoPipeline("rgba8unorm")}_getPipeline(e,t=se.MipMap,i){let r=t===se.MipMap?1:t===se.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===se.Clear?8:t===se.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):t===se.ResolveDepth?64:0;this._pipelines[e]||(this._pipelines[e]=[]);let n=this._pipelines[e][r];if(!n){let a="";(t===se.InvertYPremultiplyAlpha||t===se.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(a+=`#define INVERTY
`),i.premultiplyAlpha&&(a+=`#define PREMULTIPLYALPHA
`));let o=this._compiledShaders[r];if(!o){let l=Lr[t].vertex,c=Lr[t].fragment,h={defines:a.split(`
`),indexParameters:null,isFragment:!1,shouldUseHighPrecisionShader:!0,processor:this._engine._getShaderProcessor(1),supportsUniformBuffers:!0,shadersRepository:"",includesShadersStore:{},version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._engine._getShaderProcessingContext(1,!0),isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};$i(h),h.processor.pureMode=!0,si(l,h,p=>{l=p},this._engine),h.isFragment=!0,si(c,h,p=>{c=p},this._engine);let f=zi(l,c,h);h.processor.pureMode=!1;let d=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVertexShader_${r}`,code:f.vertexCode}),_=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalFragmentShader_${r}`,code:f.fragmentCode});o=this._compiledShaders[r]=[d,_]}let u=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalPipeline_${e}_${r}`,layout:"auto",vertex:{module:o[0],entryPoint:"main"},fragment:{module:o[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});n=this._pipelines[e][r]=[u,u.getBindGroupLayout(0)]}return n}_getVideoPipeline(e,t=it.DontInvertY){let i=t===it.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let r=this._videoPipelines[e][i];if(!r){let n=this._videoCompiledShaders[i];if(!n){let o=this._device.createShaderModule({code:Na,label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_VertexShader`}),u=this._device.createShaderModule({code:i===0?ka:$a,label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_FragmentShader_${i===0?"DontInvertY":"InvertY"}`});n=this._videoCompiledShaders[i]=[o,u]}let a=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVideoPipeline_${e}_${i===0?"DontInvertY":"InvertY"}`,layout:"auto",vertex:{module:n[0],entryPoint:"main"},fragment:{module:n[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});r=this._videoPipelines[e][i]=[a,a.getBindGroupLayout(0)]}return r}setCommandEncoder(e){this._commandEncoderForCreation=e}copyVideoToTexture(e,t,i,r=!1,n){let a=n===void 0,[o,u]=this._getVideoPipeline(i,r?it.InvertY:it.DontInvertY);a&&(n=this._device.createCommandEncoder({})),n.pushDebugGroup(`copy video to texture (invertY=${r})`);let l=t._hardwareTexture,c={label:`BabylonWebGPUDevice${this._engine.uniqueId}_copyVideoToTexture_${i}_${r?"InvertY":"DontInvertY"}${t.label?"_"+t.label:""}`,colorAttachments:[{view:l.underlyingResource.createView({format:i,dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"}),loadOp:"load",storeOp:"store"}]},h=n.beginRenderPass(c),f={layout:u,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},d=this._device.createBindGroup(f);h.setPipeline(o),h.setBindGroup(0,d),h.draw(4,1,0,0),h.end(),n.popDebugGroup(),a&&(this._device.queue.submit([n.finish()]),n=null)}invertYPreMultiplyAlpha(e,t,i,r,n=!1,a=!1,o=0,u=0,l=1,c=0,h=0,f=0,d=0,_,p){let g=f!==0,b=_===void 0,[y,M]=this._getPipeline(r,g?se.InvertYPremultiplyAlphaWithOfst:se.InvertYPremultiplyAlpha,{invertY:n,premultiplyAlpha:a});o=Math.max(o,0),b&&(_=this._device.createCommandEncoder({}));let w;if(B.IsHardwareTexture(e)?(w=e.underlyingResource,n&&!a&&l===1&&o===0||(e=void 0)):(w=e,e=void 0),!w)return;_.pushDebugGroup(`internal process texture "${w.label}" (invertY=${n} premultiplyAlpha=${a})`),g&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([c,h,f,d]),0,16);let I=e,v=I?._copyInvertYTempTexture??this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,r,1,_,21,void 0,"TempTextureForCopyWithInvertY"),D=I?._copyInvertYRenderPassDescr??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_invertYPreMultiplyAlpha_${r}_${n?"InvertY":"DontInvertY"}_${a?"PremultiplyAlpha":"DontPremultiplyAlpha"}`,colorAttachments:[{view:v.createView({format:r,dimension:"2d",baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:"load",storeOp:"store"}]},T=_.beginRenderPass(D),W=g?I?._copyInvertYBindGroupWithOfst:I?._copyInvertYBindGroup;if(!W){let E={layout:M,entries:[{binding:0,resource:w.createView({format:r,dimension:"2d",baseMipLevel:u,mipLevelCount:1,arrayLayerCount:l,baseArrayLayer:o})}]};g&&E.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),W=this._device.createBindGroup(E)}T.setPipeline(y),T.setBindGroup(0,W),T.draw(4,1,0,0),T.end(),_.copyTextureToTexture({texture:v},{texture:w,mipLevel:u,origin:{x:0,y:0,z:o}},{width:f||t,height:d||i,depthOrArrayLayers:1}),I?(I._copyInvertYTempTexture=v,I._copyInvertYRenderPassDescr=D,g?I._copyInvertYBindGroupWithOfst=W:I._copyInvertYBindGroup=W):this._deferredReleaseTextures.push([v,null]),_.popDebugGroup(),b&&(this._device.queue.submit([_.finish()]),_=null)}createTexture(e,t=!1,i=!1,r=!1,n=!1,a=!1,o="rgba8unorm",u=1,l,c=-1,h=0,f){u=B.GetSample(u);let d=e.layers||1,_={width:e.width,height:e.height,depthOrArrayLayers:d},p=ne[o]?16:0,g=B.IsCompressedFormat(o),b=t?B.ComputeNumMipmapLevels(e.width,e.height):1,y=c>=0?c:7;h|=t&&!g?1|p:0,!g&&!a&&(h|=p|2);let M=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_Texture${a?"3D":"2D"}_${f?f+"_":""}${_.width}x${_.height}x${_.depthOrArrayLayers}_${t?"wmips":"womips"}_${o}_samples${u}`,size:_,dimension:a?"3d":"2d",format:o,usage:y|h,sampleCount:u,mipLevelCount:b});return B.IsImageBitmap(e)&&(this.updateTexture(e,M,e.width,e.height,d,o,0,0,r,n,0,0),t&&i&&this.generateMipmaps(M,b,0,l)),M}createCubeTexture(e,t=!1,i=!1,r=!1,n=!1,a="rgba8unorm",o=1,u,l=-1,c=0,h){o=B.GetSample(o);let f=B.IsImageBitmapArray(e)?e[0].width:e.width,d=B.IsImageBitmapArray(e)?e[0].height:e.height,_=B.IsImageBitmapArray(e)?1:e.layers,p=ne[a]?16:0,g=B.IsCompressedFormat(a),b=t?B.ComputeNumMipmapLevels(f,d):1,y=l>=0?l:7;c|=t&&!g?1|p:0,g||(c|=p|2);let M=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureCube_${h?h+"_":""}${f}x${d}x${_}_${t?"wmips":"womips"}_${a}_samples${o}`,size:{width:f,height:d,depthOrArrayLayers:6*_},dimension:"2d",format:a,usage:y|c,sampleCount:o,mipLevelCount:b});return B.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,M,f,d,a,r,n,0,0),t&&i&&this.generateCubeMipmaps(M,b,u)),M}generateCubeMipmaps(e,t,i){let r=i===void 0,n=B.IsHardwareTexture(e)?e.underlyingResource:e;r&&(i=this._device.createCommandEncoder({})),i.pushDebugGroup(`create cube mipmaps for "${n.label}" (${t} levels)`);for(let a=0;a<n.depthOrArrayLayers;++a)this.generateMipmaps(e,t,a,i);i.popDebugGroup(),r&&(this._device.queue.submit([i.finish()]),i=null)}generateMipmaps(e,t,i=0,r){let n=r===void 0;i=Math.max(i,0),n&&(r=this._device.createCommandEncoder({}));let a;if(B.IsHardwareTexture(e)?(a=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(a=e,e=void 0),!a)return;r.pushDebugGroup(`create mipmaps for "${a.label}" (face #${i} - ${t} levels)`);let o=a.format,[u,l]=this._getPipeline(o),c=a.dimension==="3d",h=e;for(let f=1;f<t;++f){let d=h?._mipmapGenRenderPassDescr[i]?.[f-1]??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_generateMipmaps_${o}_faceIndex${i}_level${f}`,colorAttachments:[{view:a.createView({format:o,dimension:c?"3d":"2d",baseMipLevel:f,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:i}),loadOp:"load",storeOp:"store"}]};h&&(h._mipmapGenRenderPassDescr[i]=h._mipmapGenRenderPassDescr[i]||[],h._mipmapGenRenderPassDescr[i][f-1]=d);let _=r.beginRenderPass(d),p=h?._mipmapGenBindGroup[i]?.[f-1]??this._device.createBindGroup({layout:l,entries:[{binding:0,resource:a.createView({format:o,dimension:c?"3d":"2d",baseMipLevel:f-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:i})},{binding:1,resource:this._mipmapSampler}]});h&&(h._mipmapGenBindGroup[i]=h._mipmapGenBindGroup[i]||[],h._mipmapGenBindGroup[i][f-1]=p),_.setPipeline(u),_.setBindGroup(0,p),_.draw(4,1,0,0),_.end()}r.popDebugGroup(),n&&(this._device.queue.submit([r.finish()]),r=null)}createGPUTextureForInternalTexture(e,t,i,r,n){e._hardwareTexture||(e._hardwareTexture=new Se(this._engine)),t===void 0&&(t=e.width),i===void 0&&(i=e.height),r===void 0&&(r=e.depth),e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=r;let a=e._hardwareTexture,o=((n??0)&1)!==0;if(a.format=a.originalFormat=B.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),e.samples>1)switch(a.format){case"depth16unorm":a.format="r16unorm";break;case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":a.format="r32float";break}a.textureUsages=e._source===5||e.source===6?21:e._source===12?20:-1,a.textureAdditionalUsages=o?8:0;let u=e.generateMipMaps,l=r||1,c;if(e._maxLodLevel!==null?c=e._maxLodLevel:c=u?B.ComputeNumMipmapLevels(t,i):1,e.isCube){let h=this.createCubeTexture({width:t,height:i,layers:l},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,a.format,1,this._commandEncoderForCreation,a.textureUsages,a.textureAdditionalUsages,e.label);a.set(h);let f=B.GetDepthFormatOnly(a.format),d=B.HasDepthAndStencilAspects(a.format)?"depth-only":"all",_=e.is2DArray?"cube-array":"cube";a.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureViewCube${e.is2DArray?"_Array"+l:""}_${t}x${i}_${u?"wmips":"womips"}_${f}_${_}_${d}_${e.label??"noname"}`,format:f,dimension:_,mipLevelCount:c,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6*l,aspect:d},o)}else{let h=this.createTexture({width:t,height:i,layers:l},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,a.format,1,this._commandEncoderForCreation,a.textureUsages,a.textureAdditionalUsages,e.label);a.set(h);let f=e.is3D?1:l,d=B.GetDepthFormatOnly(a.format),_=B.HasDepthAndStencilAspects(a.format)?"depth-only":"all",p=e.is2DArray?"2d-array":e.is3D?"3d":"2d";a.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureView${e.is3D?"3D":"2D"}${e.is2DArray?"_Array"+f:""}_${t}x${i}${e.is3D?"x"+l:""}_${u?"wmips":"womips"}_${d}_${p}_${_}_${e.label??"noname"}`,format:d,dimension:p,mipLevelCount:c,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:f,aspect:_},o)}return a}createMSAATexture(e,t,i){return this.createTexture({width:e.width,height:e.height,layers:1},!1,!1,!1,!1,!1,t,i,this._commandEncoderForCreation,20,0,e.label?e.label+" (MSAA)":"MSAA")}resolveMSAADepthTexture(e,t,i){let r=t.format,n=i===void 0,[a,o]=this._getPipeline(r,se.ResolveDepth);n&&(i=this._device.createCommandEncoder({})),i.pushDebugGroup(`resolve MSAA Depth texture "${e.label}" to "${t.label}"`);let u={label:`BabylonWebGPUDevice${this._engine.uniqueId}_resolveMSAADepthTexture${e.label?"_"+e.label:""}`,colorAttachments:[{view:t,loadOp:"load",storeOp:"store"}]},l=i.beginRenderPass(u),c={layout:o,entries:[{binding:0,resource:e.createView({format:B.GetDepthFormatOnly(e.format),dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"depth-only"})}]},h=this._device.createBindGroup(c);l.setPipeline(a),l.setBindGroup(0,h),l.draw(4,1,0,0),l.end(),i.popDebugGroup(),n&&(this._device.queue.submit([i.finish()]),i=null)}updateCubeTextures(e,t,i,r,n,a=!1,o=!1,u=0,l=0){let c=[0,3,1,4,2,5];for(let h=0;h<c.length;++h){let f=e[c[h]];this.updateTexture(f,t,i,r,1,n,h,0,a,o,u,l)}}updateTexture(e,t,i,r,n,a,o=0,u=0,l=!1,c=!1,h=0,f=0,d){let _=B.IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,p=B.GetBlockInformationFromFormat(a),g=B.IsInternalTexture(t)?t._hardwareTexture:t,b={texture:_,origin:{x:h,y:f,z:Math.max(o,0)},mipLevel:u,premultipliedAlpha:c},y={width:Math.ceil(i/p.width)*p.width,height:Math.ceil(r/p.height)*p.height,depthOrArrayLayers:n||1};if(e.byteLength!==void 0){e=e;let M=Math.ceil(i/p.width)*p.length;if(Math.ceil(M/256)*256===M){let I=this._device.createCommandEncoder({}),v=this._bufferManager.createRawBuffer(e.byteLength,R.MapWrite|R.CopySrc,!0,"TempBufferForUpdateTexture"+(_?"_"+_.label:"")),D=v.getMappedRange();new Uint8Array(D).set(e),v.unmap(),I.copyBufferToTexture({buffer:v,offset:0,bytesPerRow:M,rowsPerImage:y.height/p.height},b,y),this._device.queue.submit([I.finish()]),this._bufferManager.releaseBuffer(v)}else this._device.queue.writeTexture(b,e,{offset:0,bytesPerRow:M,rowsPerImage:y.height/p.height},y);if(l||c)if(B.IsInternalTexture(t)){let I=h===0&&f===0&&i===t.width&&r===t.height;this.invertYPreMultiplyAlpha(g,t.width,t.height,a,l,c,o,u,n||1,h,f,I?0:i,I?0:r,void 0,d)}else throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!"}else e=e,this._device.queue.copyExternalImageToTexture({source:e,flipY:l},b,y)}readPixels(e,t,i,r,n,a,o=0,u=0,l=null,c=!1){let h=B.GetBlockInformationFromFormat(a),f=Math.ceil(r/h.width)*h.length,d=Math.ceil(f/256)*256,_=d*n,p=this._bufferManager.createRawBuffer(_,R.MapRead|R.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),g=this._device.createCommandEncoder({});return g.copyTextureToBuffer({texture:e,mipLevel:u,origin:{x:t,y:i,z:Math.max(o,0)}},{buffer:p,offset:0,bytesPerRow:d},{width:r,height:n,depthOrArrayLayers:1}),this._device.queue.submit([g.finish()]),this._bufferManager.readDataFromBuffer(p,_,r,n,f,d,B.GetTextureTypeFromFormat(a),0,l,!0,c)}releaseTexture(e){if(B.IsInternalTexture(e)){let t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){let[t,i]=this._deferredReleaseTextures[e];t&&(B.IsHardwareTexture(t)?t.release():t.destroy()),i?.dispose()}this._deferredReleaseTextures.length=0}}});var vt,Ur=A(()=>{"use strict";hn();vt=class extends ji{set buffer(e){this._buffer=e}constructor(e,t=0){super(),this.engineId=-1,this.capacity=t,e&&(this._buffer=e)}get underlyingResource(){return this._buffer}}});var Ct,Or=A(()=>{"use strict";Ur();Un();sn();Ne();Ct=class s{static _IsGPUBuffer(e){return e.underlyingResource===void 0}static _FlagsToString(e,t=""){let i=t;for(let r=0;r<=9;++r)e&1<<r&&(i&&(i+="_"),i+=R[1<<r]);return i}constructor(e,t){this._deferredReleaseBuffers=[],this._engine=e,this._device=t}createRawBuffer(e,t,i=!1,r){let n=e.byteLength!==void 0?e.byteLength+3&-4:e+3&-4,a={label:"BabylonWebGPUDevice"+this._engine.uniqueId+"_"+s._FlagsToString(t,r??"Buffer")+"_size"+n,mappedAtCreation:i,size:n,usage:t};return this._device.createBuffer(a)}createBuffer(e,t,i){let r=e.byteLength!==void 0,n=new vt,a="DataBufferUniqueId="+n.uniqueId;return n.buffer=this.createRawBuffer(e,t,void 0,i?a+"-"+i:a),n.references=1,n.capacity=r?e.byteLength:e,n.engineId=this._engine.uniqueId,r&&this.setSubData(n,0,e),n}setRawData(e,t,i,r,n){r+=i.byteOffset,this._device.queue.writeBuffer(e,t,i.buffer,r,n)}setSubData(e,t,i,r=0,n=0){let a=e.underlyingResource;n=n||i.byteLength-r;let o=t&3;r-=o,t-=o;let u=n;if(n=n+o+3&-4,i.buffer.byteLength-i.byteOffset<n){let c=new Uint8Array(n);c.set(new Uint8Array(i.buffer,i.byteOffset+r,u)),i=c,r=0}this.setRawData(a,t,i,r,n)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i?e=Math.min(e,i.length):i=new Float32Array(e);let r=new Uint16Array(t);for(;e--;)i[e]=Cr(r[e]);return i}readDataFromBuffer(e,t,i,r,n,a,o=0,u=0,l=null,c=!0,h=!1){let f=o===1?2:o===2?1:0,d=this._engine.uniqueId;return new Promise((_,p)=>{e.mapAsync(1,u,t).then(()=>{let g=e.getMappedRange(u,t),b=l;if(h)b===null?b=ri(o,t,!0,g):b=ri(o,b.buffer,void 0,g);else if(b===null)switch(f){case 0:b=new Uint8Array(t),b.set(new Uint8Array(g));break;case 1:b=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,g);break;case 2:b=new Float32Array(t/4),b.set(new Float32Array(g));break}else switch(f){case 0:b=new Uint8Array(b.buffer),b.set(new Uint8Array(g,0,Math.min(b.byteLength,t)));break;case 1:b=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,g,l);break;case 2:b=new Float32Array(b.buffer),b.set(new Float32Array(g,0,b.byteLength/4));break}if(n!==a){f===1&&!h&&(n*=2,a*=2);let y=new Uint8Array(b.buffer),M=n,w=0;for(let I=1;I<r;++I){w=I*a;for(let v=0;v<n;++v)y[M++]=y[w++]}f!==0&&!h?b=new Float32Array(y.buffer,0,M/4):b=new Uint8Array(y.buffer,0,M)}e.unmap(),c&&this.releaseBuffer(e),_(b)},g=>{this._engine.isDisposed||this._engine.uniqueId!==d?_(new Uint8Array):p(g)})})}releaseBuffer(e){return s._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,e.references===0?(this._deferredReleaseBuffers.push(e.underlyingResource),!0):!1)}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}});var Ka,qa,Ya,ke,ci=A(()=>{"use strict";Ka=[0,0,3,7,0,2,6,2,4,1,5,3,1],qa=[0,64,32,96,16,80,48,112,8],Ya=[0,128,128,0,0,0,0,128,0,0,0,0,128],ke=class s{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){let t=e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;return Ka[e.samplingMode]+qa[(e._comparisonFunction||514)-512+1]+Ya[e.samplingMode]+((e._cachedWrapU??1)<<8)+((e._cachedWrapV??1)<<10)+((e._cachedWrapR??1)<<12)+((e.useMipMaps?1:0)<<14)+(t<<15)}static _GetSamplerFilterDescriptor(e,t){let i,r,n,a,o,u=e.useMipMaps;switch(e.samplingMode){case 11:i="linear",r="linear",n="nearest",u||(a=o=0);break;case 3:case 3:i="linear",r="linear",u?n="linear":(n="nearest",a=o=0);break;case 8:i="nearest",r="nearest",u?n="linear":(n="nearest",a=o=0);break;case 4:i="nearest",r="nearest",n="nearest",u||(a=o=0);break;case 5:i="nearest",r="linear",n="nearest",u||(a=o=0);break;case 6:i="nearest",r="linear",u?n="linear":(n="nearest",a=o=0);break;case 7:i="nearest",r="linear",n="nearest",a=o=0;break;case 1:case 1:i="nearest",r="nearest",n="nearest",a=o=0;break;case 9:i="linear",r="nearest",n="nearest",u||(a=o=0);break;case 10:i="linear",r="nearest",u?n="linear":(n="nearest",a=o=0);break;case 2:case 2:i="linear",r="linear",t>1?n="linear":(n="nearest",a=o=0);break;case 12:i="linear",r="nearest",n="nearest",a=o=0;break;default:i="nearest",r="nearest",n="nearest",a=o=0;break}return t>1&&(a!==0||o!==0)?{magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",anisotropyEnabled:!0}:{magFilter:i,minFilter:r,mipmapFilter:n,lodMinClamp:a,lodMaxClamp:o}}static _GetWrappingMode(e){switch(e){case 1:return"repeat";case 0:return"clamp-to-edge";case 2:return"mirror-repeat"}return"repeat"}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e,t){let i=(e.useMipMaps||e.samplingMode===2)&&e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;e.samplingMode!==11&&e.samplingMode!==3&&e.samplingMode!==2&&(i=1);let r=this._GetSamplerFilterDescriptor(e,i);return qe(z(z({label:t},r),this._GetSamplerWrappingDescriptor(e)),{compare:e._comparisonFunction?s.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:r.anisotropyEnabled?i:1})}static GetCompareFunction(e){switch(e){case 519:return"always";case 514:return"equal";case 516:return"greater";case 518:return"greater-equal";case 513:return"less";case 515:return"less-equal";case 512:return"never";case 517:return"not-equal";default:return"less"}}getSampler(e,t=!1,i=0,r){if(this.disabled)return this._device.createSampler(s._GetSamplerDescriptor(e,r));t?i=0:i===0&&(i=s.GetSamplerHashCode(e));let n=t?void 0:this._samplers[i];return n||(n=this._device.createSampler(s._GetSamplerDescriptor(e,r)),t||(this._samplers[i]=n)),n}}});var Gr=A(()=>{"use strict";Pe()});function Za(s){switch(s){case m.BYTE:case m.SHORT:case m.INT:case m.FLOAT:return!0;case m.UNSIGNED_BYTE:case m.UNSIGNED_SHORT:case m.UNSIGNED_INT:return!1;default:throw new Error(`Invalid type '${s}'`)}}function Wr(s,e){let t=e.getEngine(),i=e._pipelineContext;if(!i?.vertexBufferKindToType)return;let r=null;for(let n in s){let a=s[n];if(!a||!Ha[n])continue;let o=a.normalized?m.FLOAT:a.type,u=i.vertexBufferKindToType[n];(o!==m.FLOAT&&u===void 0||u!==void 0&&u!==o)&&(r||(r=t._getShaderProcessingContext(e.shaderLanguage,!1)),i.vertexBufferKindToType[n]=o,o!==m.FLOAT&&(r.vertexBufferKindToNumberOfComponents[n]=m.DeduceStride(n),Za(o)&&(r.vertexBufferKindToNumberOfComponents[n]*=-1)))}if(r){let n=t._caps.parallelShaderCompile;t._caps.parallelShaderCompile=void 0,e._processShaderCodeAsync(null,t._features._checkNonFloatVertexBuffersDontRecreatePipelineContext,r),t._caps.parallelShaderCompile=n}}var Ha,Vr=A(()=>{"use strict";Gr();Ha={[m.PositionKind]:!0,[m.NormalKind]:!0,[m.TangentKind]:!0,[m.UVKind]:!0,[m.UV2Kind]:!0,[m.UV3Kind]:!0,[m.UV4Kind]:!0,[m.UV5Kind]:!0,[m.UV6Kind]:!0,[m.ColorKind]:!0,[m.ColorInstanceKind]:!0,[m.MatricesIndicesKind]:!0,[m.MatricesWeightsKind]:!0,[m.MatricesIndicesExtraKind]:!0,[m.MatricesWeightsExtraKind]:!0}});var V,wt,Nr,ae,Fe,kr,$r=A(()=>{"use strict";Pe();be();Mt();Vr();te();V=(function(s){return s[s.StencilReadMask=0]="StencilReadMask",s[s.StencilWriteMask=1]="StencilWriteMask",s[s.DepthBias=2]="DepthBias",s[s.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",s[s.DepthStencilState=4]="DepthStencilState",s[s.MRTAttachments=5]="MRTAttachments",s[s.RasterizationState=6]="RasterizationState",s[s.ColorStates1=7]="ColorStates1",s[s.ColorStates2=8]="ColorStates2",s[s.ColorStates3=9]="ColorStates3",s[s.ColorStates4=10]="ColorStates4",s[s.ShaderStage=11]="ShaderStage",s[s.TextureStage=12]="TextureStage",s[s.VertexState=13]="VertexState",s[s.NumStates=14]="NumStates",s})(V||{}),wt={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:14,32772:15,35065:16,35066:17,34185:18,35067:19},Nr={32774:0,32775:1,32776:2,32778:3,32779:4},ae={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7},Fe=[0,0,0,0],kr=(()=>{class s{constructor(t,i){this.mrtTextureCount=0,this._device=t,this._useTextureStage=!0,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=i,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=t.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=["bgra8unorm"],this.setColorFormat("bgra8unorm"),this.setMRT([]),this.setAlphaBlendEnabled([!1],1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat("depth24plus-stencil8"),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(t,i,r,n=0){if(r=B.GetSample(r),this.disabled){let o=s._GetTopology(t);return this._setVertexState(i),this._setTextureState(n),this._parameter.pipeline=this._createRenderPipeline(i,o,r),s.NumCacheMiss++,s._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(i.uniqueId),this._setRasterizationState(t,r),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(i),this._setTextureState(n),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,s.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return s.NumCacheHitWithHash++,this._parameter.pipeline;let a=s._GetTopology(t);return this._parameter.pipeline=this._createRenderPipeline(i,a,r),this._setRenderPipeline(this._parameter),s.NumCacheMiss++,s._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){s.NumPipelineCreationLastFrame=s._NumPipelineCreationCurrentFrame,s._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(t){this._alphaToCoverageEnabled=t}setFrontFace(t){this._frontFace=t}setCullEnabled(t){this._cullEnabled=t}setCullFace(t){this._cullFace=t}setClampDepth(t){this._clampDepth=t}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(t,i,r,n,a,o,u,l){this._depthWriteEnabled=u,this._depthTestEnabled=o,this._depthCompare=(l??519)-512,this._cullFace=r,this._cullEnabled=t,this._frontFace=i,this.setDepthBiasSlopeScale(n),this.setDepthBias(a)}setDepthBias(t){this._depthBias!==t&&(this._depthBias=t,this._states[V.DepthBias]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.DepthBias))}setDepthBiasSlopeScale(t){this._depthBiasSlopeScale!==t&&(this._depthBiasSlopeScale=t,this._states[V.DepthBiasSlopeScale]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.DepthBiasSlopeScale))}setColorFormat(t){this._webgpuColorFormat[0]=t,this._colorFormat=ne[t??""]}setMRTAttachments(t){this.mrtAttachments=t;let i=0;for(let r=0;r<t.length;++r)t[r]!==0&&(i+=1<<r);this._mrtEnabledMask!==i&&(this._mrtEnabledMask=i,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.MRTAttachments))}setMRT(t,i){if(i=i??t.length,i>8)throw new Error("Can't handle more than 8 attachments for a MRT in cache render pipeline!");this.mrtTextureArray=t,this.mrtTextureCount=i,this._mrtEnabledMask=65535;let r=0,n=0;for(let a=0;a<i;++a){let u=t[a]?._hardwareTexture;this._mrtFormats[a]=u?.format??this._webgpuColorFormat[0],r+=ne[this._mrtFormats[a]??""]*2**n,n+=6}this._mrtFormats.length=i,this._mrtAttachments!==r&&(this._mrtAttachments=r,this._states[V.MRTAttachments]=r,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.MRTAttachments))}setAlphaBlendEnabled(t,i){this._alphaBlendEnabled=t,this._numAlphaBlendTargetsEnabled=i}setAlphaBlendFactors(t,i){this._alphaBlendFuncParams=t,this._alphaBlendEqParams=i}setWriteMask(t){this._writeMask=t}setDepthStencilFormat(t){this._webgpuDepthStencilFormat=t,this._depthStencilFormat=t===void 0?0:ne[t]}setDepthTestEnabled(t){this._depthTestEnabled=t}setDepthWriteEnabled(t){this._depthWriteEnabled=t}setDepthCompare(t){this._depthCompare=(t??519)-512}setStencilEnabled(t){this._stencilEnabled=t}setStencilCompare(t){this._stencilFrontCompare=(t??519)-512}setStencilDepthFailOp(t){this._stencilFrontDepthFailOp=t===null?1:ae[t]}setStencilPassOp(t){this._stencilFrontPassOp=t===null?2:ae[t]}setStencilFailOp(t){this._stencilFrontFailOp=t===null?1:ae[t]}setStencilBackCompare(t){this._stencilBackCompare=(t??519)-512}setStencilBackDepthFailOp(t){this._stencilBackDepthFailOp=t===null?1:ae[t]}setStencilBackPassOp(t){this._stencilBackPassOp=t===null?2:ae[t]}setStencilBackFailOp(t){this._stencilBackFailOp=t===null?1:ae[t]}setStencilReadMask(t){this._stencilReadMask!==t&&(this._stencilReadMask=t,this._states[V.StencilReadMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.StencilReadMask))}setStencilWriteMask(t){this._stencilWriteMask!==t&&(this._stencilWriteMask=t,this._states[V.StencilWriteMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(t,i,r,n,a,o,u,l=null,c=null,h=null,f=null){this._stencilEnabled=t,this._stencilFrontCompare=(i??519)-512,this._stencilFrontDepthFailOp=r===null?1:ae[r],this._stencilFrontPassOp=n===null?2:ae[n],this._stencilFrontFailOp=a===null?1:ae[a],this._stencilBackCompare=(l??519)-512,this._stencilBackDepthFailOp=c===null?1:ae[c],this._stencilBackPassOp=h===null?2:ae[h],this._stencilBackFailOp=f===null?1:ae[f],this.setStencilReadMask(o),this.setStencilWriteMask(u)}setBuffers(t,i,r){this._vertexBuffers=t,this._overrideVertexBuffers=r,this.indexBuffer=i}static _GetTopology(t){switch(t){case 0:return"triangle-list";case 2:return"point-list";case 1:return"line-list";case 3:return"point-list";case 4:return"line-list";case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return"line-strip";case 7:return"triangle-strip";case 8:throw"TriangleFan is an unsupported fillmode in WebGPU";default:return"triangle-list"}}static _GetAphaBlendOperation(t){switch(t){case 32774:return"add";case 32778:return"subtract";case 32779:return"reverse-subtract";case 32775:return"min";case 32776:return"max";default:return"add"}}static _GetAphaBlendFactor(t){switch(t){case 0:return"zero";case 1:return"one";case 768:return"src";case 769:return"one-minus-src";case 770:return"src-alpha";case 771:return"one-minus-src-alpha";case 772:return"dst-alpha";case 773:return"one-minus-dst-alpha";case 774:return"dst";case 775:return"one-minus-dst";case 776:return"src-alpha-saturated";case 32769:case 32771:return"constant";case 32770:case 32772:return"one-minus-constant";case 35065:return"src1";case 35066:return"one-minus-src1";case 34185:return"src1-alpha";case 35067:return"one-minus-src1-alpha";default:return"one"}}static _GetCompareFunction(t){switch(t){case 0:return"never";case 1:return"less";case 2:return"equal";case 3:return"less-equal";case 4:return"greater";case 5:return"not-equal";case 6:return"greater-equal";case 7:return"always"}return"never"}static _GetStencilOpFunction(t){switch(t){case 0:return"zero";case 1:return"keep";case 2:return"replace";case 3:return"increment-clamp";case 4:return"decrement-clamp";case 5:return"invert";case 6:return"increment-wrap";case 7:return"decrement-wrap"}return"keep"}static _GetVertexInputDescriptorFormat(t){let i=t.type,r=t.normalized,n=t.getSize();switch(i){case m.BYTE:switch(n){case 1:case 2:return r?"snorm8x2":"sint8x2";case 3:case 4:return r?"snorm8x4":"sint8x4"}break;case m.UNSIGNED_BYTE:switch(n){case 1:case 2:return r?"unorm8x2":"uint8x2";case 3:case 4:return r?"unorm8x4":"uint8x4"}break;case m.SHORT:switch(n){case 1:case 2:return r?"snorm16x2":"sint16x2";case 3:case 4:return r?"snorm16x4":"sint16x4"}break;case m.UNSIGNED_SHORT:switch(n){case 1:case 2:return r?"unorm16x2":"uint16x2";case 3:case 4:return r?"unorm16x4":"uint16x4"}break;case m.INT:switch(n){case 1:return"sint32";case 2:return"sint32x2";case 3:return"sint32x3";case 4:return"sint32x4"}break;case m.UNSIGNED_INT:switch(n){case 1:return"uint32";case 2:return"uint32x2";case 3:return"uint32x3";case 4:return"uint32x4"}break;case m.FLOAT:switch(n){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4"}break}throw new Error(`Invalid Format '${t.getKind()}' - type=${i}, normalized=${r}, size=${n}`)}_getAphaBlendState(t){return this._alphaBlendEnabled[t]?{srcFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[t*4+2]),dstFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[t*4+3]),operation:s._GetAphaBlendOperation(this._alphaBlendEqParams[t*2+1])}:null}_getColorBlendState(t){return this._alphaBlendEnabled?{srcFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[t*4+0]),dstFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[t*4+1]),operation:s._GetAphaBlendOperation(this._alphaBlendEqParams[t*2+0])}:null}_setShaderStage(t){this._shaderId!==t&&(this._shaderId=t,this._states[V.ShaderStage]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.ShaderStage))}_setRasterizationState(t,i){let r=this._frontFace,n=this._cullEnabled?this._cullFace:0,a=this._clampDepth?1:0,o=this._alphaToCoverageEnabled?1:0,u=r-1+(n<<1)+(a<<3)+(o<<4)+(t<<5)+(i<<8);this._rasterizationState!==u&&(this._rasterizationState=u,this._states[V.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.RasterizationState))}_setColorStates(){Fe[0]=(this._writeMask?1:0)*2**53,Fe[1]=(this._depthWriteEnabled?1:0)*2**53,Fe[2]=(this._colorFormat&7)*2**50,Fe[3]=(this._colorFormat&56)*2**47;let t=0,i=!1;for(let r=0;r<8;r++){if(this._alphaBlendEnabled[r]){let n=r*4+0,a=r*4+1,o=r*4+2,u=r*4+3,l=r*2+0,c=r*2+1,h=this._alphaBlendEqParams[l]===null?0:Nr[this._alphaBlendEqParams[l]],f=this._alphaBlendEqParams[c]===null?0:Nr[this._alphaBlendEqParams[c]];Fe[t]+=((this._alphaBlendFuncParams[n]===null?1:wt[this._alphaBlendFuncParams[n]])<<0)+((this._alphaBlendFuncParams[a]===null?1:wt[this._alphaBlendFuncParams[a]])<<5)+((this._alphaBlendFuncParams[o]===null?1:wt[this._alphaBlendFuncParams[o]])<<10)+((this._alphaBlendFuncParams[u]===null?1:wt[this._alphaBlendFuncParams[u]])<<15)+(h+f*5)*(1<<20)}r&1&&(i=i||this._states[V.ColorStates1+t]!==Fe[t],this._states[V.ColorStates1+t]=Fe[t],t++)}i&&(this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.ColorStates1))}_setDepthStencilState(){let t=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9)+(this._stencilBackCompare<<12)+(this._stencilBackDepthFailOp<<15)+(this._stencilBackPassOp<<18)+(this._stencilBackFailOp<<21):2421327,i=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+t*1024;this._depthStencilState!==i&&(this._depthStencilState=i,this._states[V.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.DepthStencilState))}_setVertexState(t){let i=this._statesLength,r=V.VertexState,n=t._pipelineContext,a=n.shaderProcessingContext.attributeNamesFromEffect,o=n.shaderProcessingContext.attributeLocationsFromEffect,u,l=0;for(let c=0;c<a.length;c++){let h=o[c],f=(this._overrideVertexBuffers&&this._overrideVertexBuffers[a[c]])??this._vertexBuffers[a[c]];f||(f=this._emptyVertexBuffer,s.LogErrorIfNoVertexBuffer&&C.Error(`No vertex buffer is provided for the "${a[c]}" attribute. A default empty vertex buffer will be used, but this may generate errors in some browsers.`));let d=f.effectiveBuffer?.underlyingResource;if(f._validOffsetRange===void 0){let p=f.effectiveByteOffset,g=f.getSize(!0),b=f.effectiveByteStride;f._validOffsetRange=p+g<=this._kMaxVertexBufferStride&&b===0||b!==0&&p+g<=b}u&&u===d&&f._validOffsetRange||(this.vertexBuffers[l++]=f,u=f._validOffsetRange?d:null);let _=f.hashCode+(h<<7);this._isDirty=this._isDirty||this._states[r]!==_,this._states[r++]=_}this.vertexBuffers.length=l,this._statesLength=r,this._isDirty=this._isDirty||r!==i,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.VertexState))}_setTextureState(t){this._textureState!==t&&(this._textureState=t,this._states[V.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,V.TextureStage))}_createPipelineLayout(t){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(t);let i=[],r=t.shaderProcessingContext.bindGroupLayoutEntries;for(let n=0;n<r.length;n++){let a=r[n];i[n]=this._device.createBindGroupLayout({entries:a})}return t.bindGroupLayouts[0]=i,this._device.createPipelineLayout({bindGroupLayouts:i})}_createPipelineLayoutWithTextureStage(t){let i=t.shaderProcessingContext,r=i.bindGroupLayoutEntries,n=1;for(let o=0;o<r.length;o++){let u=r[o];for(let l=0;l<u.length;l++){let c=r[o][l];if(c.texture){let h=i.bindGroupLayoutEntryInfo[o][c.binding].name,f=i.availableTextures[h],d=f.autoBindSampler?i.availableSamplers[h+"Sampler"]:null,_=f.sampleType,p=d?.type??"filtering";if(this._textureState&n&&_!=="depth"&&(f.autoBindSampler&&(p="non-filtering"),_="unfilterable-float"),c.texture.sampleType=_,d){let g=i.bindGroupLayoutEntryInfo[d.binding.groupIndex][d.binding.bindingIndex].index;r[d.binding.groupIndex][g].sampler.type=p}n=n<<1}}}let a=[];for(let o=0;o<r.length;++o)a[o]=this._device.createBindGroupLayout({entries:r[o]});return t.bindGroupLayouts[this._textureState]=a,this._device.createPipelineLayout({bindGroupLayouts:a})}_getVertexInputDescriptor(t){let i=[],r=t._pipelineContext,n=r.shaderProcessingContext.attributeNamesFromEffect,a=r.shaderProcessingContext.attributeLocationsFromEffect,o,u;for(let l=0;l<n.length;l++){let c=a[l],h=(this._overrideVertexBuffers&&this._overrideVertexBuffers[n[l]])??this._vertexBuffers[n[l]];h||(h=this._emptyVertexBuffer);let f=h.effectiveBuffer?.underlyingResource,d=h.effectiveByteOffset,_=!h._validOffsetRange;if(!(o&&u&&o===f)||_){let p={arrayStride:h.effectiveByteStride,stepMode:h.getIsInstanced()?"instance":"vertex",attributes:[]};i.push(p),u=p.attributes,_&&(d=0,f=null)}u.push({shaderLocation:c,offset:d,format:s._GetVertexInputDescriptorFormat(h)}),o=f}return i}_createRenderPipeline(t,i,r){let n=t._pipelineContext,a=this._getVertexInputDescriptor(t),o=this._createPipelineLayout(n),u=[];if(this._vertexBuffers&&Wr(this._vertexBuffers,t),this._mrtAttachments>0)for(let _=0;_<this._mrtFormats.length;++_){let p=this._mrtFormats[_];if(p){let g={format:p,writeMask:(this._mrtEnabledMask&1<<_)!==0?this._writeMask:0},b=this._getAphaBlendState(_<this._numAlphaBlendTargetsEnabled?_:0),y=this._getColorBlendState(_<this._numAlphaBlendTargetsEnabled?_:0);b&&y&&(g.blend={alpha:b,color:y}),u.push(g)}else u.push(null)}else if(this._webgpuColorFormat[0]){let _={format:this._webgpuColorFormat[0],writeMask:this._writeMask},p=this._getAphaBlendState(0),g=this._getColorBlendState(0);p&&g&&(_.blend={alpha:p,color:g}),u.push(_)}else u.push(null);let l={compare:s._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)},c={compare:s._GetCompareFunction(this._stencilEnabled?this._stencilBackCompare:7),depthFailOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilBackDepthFailOp:1),failOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilBackFailOp:1),passOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilBackPassOp:1)},h=i==="triangle-list"||i==="triangle-strip",f;(i==="line-strip"||i==="triangle-strip")&&(f=!this.indexBuffer||this.indexBuffer.is32Bits?"uint32":"uint16");let d=this._webgpuDepthStencilFormat?B.HasStencilAspect(this._webgpuDepthStencilFormat):!1;return this._device.createRenderPipeline({label:`RenderPipeline_${u[0]?.format??"nooutput"}_${this._webgpuDepthStencilFormat??"nodepth"}_samples${r}_textureState${this._textureState}`,layout:o,vertex:{module:n.stages.vertexStage.module,entryPoint:n.stages.vertexStage.entryPoint,buffers:a},primitive:{topology:i,stripIndexFormat:f,frontFace:this._frontFace===1?"ccw":"cw",cullMode:this._cullEnabled?this._cullFace===2?"front":"back":"none"},fragment:n.stages.fragmentStage?{module:n.stages.fragmentStage.module,entryPoint:n.stages.fragmentStage.entryPoint,targets:u}:void 0,multisample:{count:r},depthStencil:this._webgpuDepthStencilFormat===void 0?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?s._GetCompareFunction(this._depthCompare):"always",format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&d?l:void 0,stencilBack:this._stencilEnabled&&d?c:void 0,stencilReadMask:this._stencilEnabled&&d?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&d?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:h?this._depthBiasClamp:0,depthBiasSlopeScale:h?this._depthBiasSlopeScale:0}})}}return s.LogErrorIfNoVertexBuffer=!1,s.NumCacheHitWithoutHash=0,s.NumCacheHitWithHash=0,s.NumCacheMiss=0,s.NumPipelineCreationLastFrame=0,s._NumPipelineCreationCurrentFrame=0,s})()});var rt,Me,hi=A(()=>{"use strict";$r();rt=class{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(let i in this.values){let r=this.values[i],[n,a]=r.count();e+=n,t+=a,e++}return[e,t]}},Me=class s extends kr{static GetNodeCounts(){let e=s._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,r){if(e.pipeline){let n=i.slice();n.length=r,t.push(n)}for(let n in e.values){let a=e.values[n];i[r]=parseInt(n),s._GetPipelines(a,t,i,r+1)}}static GetPipelines(){let e=[];return s._GetPipelines(s._Cache,e,[],0),e}static ResetCache(){s._Cache=new rt}reset(){this._nodeStack=[],this._nodeStack[0]=s._Cache,super.reset()}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let i=this._stateDirtyLowestIndex;i<this._statesLength;++i){let r=t.values[this._states[i]];r||(r=new rt,t.values[this._states[i]]=r),t=r,this._nodeStack[i+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}};Me._Cache=new rt});var At,zr=A(()=>{"use strict";ln();At=class extends Hi{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get backFunc(){return this._backFunc}set backFunc(e){this._backFunc!==e&&(this._backFunc=e,this._cache.setStencilBackCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail!==e&&(this._backOpStencilFail=e,this._cache.setStencilBackFailOp(e))}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail!==e&&(this._backOpDepthFail=e,this._cache.setStencilBackDepthFailOp(e))}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass!==e&&(this._backOpStencilDepthPass=e,this._cache.setStencilBackPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){let e=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.backFunc=e?this.stencilMaterial.backFunc:this.stencilGlobal.backFunc,this.backOpStencilFail=e?this.stencilMaterial.backOpStencilFail:this.stencilGlobal.backOpStencilFail,this.backOpDepthFail=e?this.stencilMaterial.backOpDepthFail:this.stencilGlobal.backOpDepthFail,this.backOpStencilDepthPass=e?this.stencilMaterial.backOpStencilDepthPass:this.stencilGlobal.backOpStencilDepthPass)}}});var Dt,Qr=A(()=>{"use strict";un();Dt=class extends Yi{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}});var $e,di=A(()=>{"use strict";Re();$e=class{static IsExternalTexture(e){return e.underlyingResource!==void 0}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this.format=4294967295,this._video=e,this.uniqueId=K._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}});var Kr,qr=A(()=>{"use strict";di();ci();Kr=(()=>{class s{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.useVertexPulling=!1,this.uniqueId=s._Counter++,this.updateId=0,this.textureState=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatOrDepthTextures=0,this._numExternalTextures=0}setSampler(t,i){let r=this.samplers[t],n=-1;r?n=r.hashCode:this.samplers[t]=r={sampler:i,hashCode:0},r.sampler=i,r.hashCode=i?ke.GetSamplerHashCode(i):0;let a=n!==r.hashCode;a&&this.updateId++,this.isDirty||(this.isDirty=a)}setTexture(t,i){let r=this.textures[t],n=-1;r?n=r.texture?.uniqueId??-1:this.textures[t]=r={texture:i,isFloatOrDepthTexture:!1,isExternalTexture:!1},r.isExternalTexture&&this._numExternalTextures--,r.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,i?(r.isFloatOrDepthTexture=i.type===1||i.format>=13&&i.format<=18,r.isExternalTexture=$e.IsExternalTexture(i),r.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,r.isExternalTexture&&this._numExternalTextures++):(r.isFloatOrDepthTexture=!1,r.isExternalTexture=!1),r.texture=i;let a=n!==(i?.uniqueId??-1);a&&this.updateId++,this.isDirty||(this.isDirty=a)}}return s._Counter=0,s})()});var Yr,Hr=A(()=>{"use strict";Ne();Yr=(()=>{class s{isDirty(t){return this._isDirty||this._materialContextUpdateId!==t}resetIsDirty(t){this._isDirty=!1,this._materialContextUpdateId=t}get enableIndirectDraw(){return this._enableIndirectDraw}set enableIndirectDraw(t){this._enableIndirectDrawInCompatMode=!0,this._enableIndirectDraw!==t&&(this._enableIndirectDraw=t,!t&&!this._useInstancing&&this.indirectDrawBuffer?(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0):t&&!this.indirectDrawBuffer&&(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(20,R.CopyDst|R.Indirect|R.Storage,void 0,"IndirectDrawBuffer"),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0))}get useInstancing(){return this._useInstancing}set useInstancing(t){if(this._useInstancing===t)return;this._useInstancing=t,this._currentInstanceCount=-1;let i=this._enableIndirectDrawInCompatMode;this.enableIndirectDraw=t,this._enableIndirectDrawInCompatMode=i}constructor(t,i){this._dummyIndexBuffer=i,this._enableIndirectDrawInCompatMode=!1,this._bufferManager=t,this.uniqueId=s._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this._enableIndirectDraw=!1,this._vertexPullingEnabled=!1,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0,this._vertexPullingEnabled=!1}setBuffer(t,i){this._isDirty||(this._isDirty=i?.uniqueId!==this.buffers[t]?.uniqueId),this.buffers[t]=i}setIndirectData(t,i,r,n=!1){!n&&i===this._currentInstanceCount||!this.indirectDrawBuffer||!this._indirectDrawData||(this._currentInstanceCount=i,this._indirectDrawData[0]=t,this._indirectDrawData[1]=i,this._indirectDrawData[2]=r,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}setVertexPulling(t,i,r,n,a){if(this._vertexPullingEnabled===t)return;this._vertexPullingEnabled=t,this._isDirty=!0;let o=i.shaderProcessingContext.bufferNames;if(a)for(let u in a){let l=a[u];if(!l||o.indexOf(u)===-1)continue;let c=l.effectiveBuffer;this.setBuffer(u,t?c:null)}for(let u in r){if(a&&u in a)continue;let l=r[u];if(!l||o.indexOf(u)===-1)continue;let c=l.effectiveBuffer;this.setBuffer(u,t?c:null)}o.indexOf("indices")!==-1&&this.setBuffer("indices",t?n??this._dummyIndexBuffer:null)}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0,this._enableIndirectDraw=!1}}return s._Counter=0,s})()});var Xa,ja,Le,ie,Zr=A(()=>{"use strict";te();Xa=1<<20,ja=2**35,Le=class{constructor(){this.values={}}},ie=class s{static get Statistics(){return{totalCreated:s.NumBindGroupsCreatedTotal,lastFrameCreated:s.NumBindGroupsCreatedLastFrame,lookupLastFrame:s.NumBindGroupsLookupLastFrame,noLookupLastFrame:s.NumBindGroupsNoLookupLastFrame}}static ResetCache(){s._Cache=new Le,s.NumBindGroupsCreatedTotal=0,s.NumBindGroupsCreatedLastFrame=0,s.NumBindGroupsLookupLastFrame=0,s.NumBindGroupsNoLookupLastFrame=0,s._NumBindGroupsCreatedCurrentFrame=0,s._NumBindGroupsLookupCurrentFrame=0,s._NumBindGroupsNoLookupCurrentFrame=0}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){s.NumBindGroupsCreatedLastFrame=s._NumBindGroupsCreatedCurrentFrame,s.NumBindGroupsLookupLastFrame=s._NumBindGroupsLookupCurrentFrame,s.NumBindGroupsNoLookupLastFrame=s._NumBindGroupsNoLookupCurrentFrame,s._NumBindGroupsCreatedCurrentFrame=0,s._NumBindGroupsLookupCurrentFrame=0,s._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){let r,n=s._Cache,a=this.disabled||i.forceBindGroupCreation;if(!a){if(!t.isDirty(i.updateId)&&!i.isDirty)return s._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(let u of e.shaderProcessingContext.bufferNames){let l=(t.buffers[u]?.uniqueId??0)+Xa,c=n.values[l];c||(c=new Le,n.values[l]=c),n=c}for(let u of e.shaderProcessingContext.samplerNames){let l=i.samplers[u]?.hashCode??0,c=n.values[l];c||(c=new Le,n.values[l]=c),n=c}for(let u of e.shaderProcessingContext.textureNames){let l=(i.textures[u]?.texture?.uniqueId??0)+ja,c=n.values[l];c||(c=new Le,n.values[l]=c),n=c}r=n.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,r)return t.bindGroups=r,s._NumBindGroupsLookupCurrentFrame++,r;r=[],t.bindGroups=r,a||(n.bindGroups=r),s.NumBindGroupsCreatedTotal++,s._NumBindGroupsCreatedCurrentFrame++;let o=e.bindGroupLayouts[i.textureState];for(let u=0;u<e.shaderProcessingContext.bindGroupLayoutEntries.length;u++){let l=e.shaderProcessingContext.bindGroupLayoutEntries[u],c=e.shaderProcessingContext.bindGroupEntries[u];for(let f=0;f<l.length;f++){let d=e.shaderProcessingContext.bindGroupLayoutEntries[u][f],_=e.shaderProcessingContext.bindGroupLayoutEntryInfo[u][d.binding],p=_.nameInArrayOfTexture??_.name;if(d.sampler){let g=i.samplers[p];if(g){let b=g.sampler;if(!b){this._engine.dbgSanityChecks&&C.Error(`Trying to bind a null sampler! entry=${JSON.stringify(d)}, name=${p}, bindingInfo=${JSON.stringify(g,(y,M)=>y==="texture"?"<no dump>":M)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}c[f].resource=this._cacheSampler.getSampler(b,!1,g.hashCode,b.label)}else C.Error(`Sampler "${p}" not found in the material context. Make sure you bound it. entry=${JSON.stringify(d)}, materialContext=${JSON.stringify(i,(b,y)=>b==="texture"||b==="sampler"?"<no dump>":y)}`,50)}else if(d.texture||d.storageTexture){let g=i.textures[p];if(g){if(this._engine.dbgSanityChecks&&g.texture===null){C.Error(`Trying to bind a null texture! name="${p}", entry=${JSON.stringify(d)}, bindingInfo=${JSON.stringify(g,(y,M)=>y==="texture"?"<no dump>":M)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}let b=g.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!b||d.texture&&!b.view||d.storageTexture&&!b.viewForWriting)){C.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(d)}, name=${p}, bindingInfo=${JSON.stringify(g,(y,M)=>y==="texture"?"<no dump>":M)}, isReady=${g.texture?.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}c[f].resource=d.storageTexture?b.viewForWriting:b.view}else C.Error(`Texture "${p}" not found in the material context. Make sure you bound it (something like effect.setTexture("${p}", texture)). entry=${JSON.stringify(d)}, materialContext=${JSON.stringify(i,(b,y)=>b==="texture"||b==="sampler"?"<no dump>":y)}`,50)}else if(d.externalTexture){let g=i.textures[p];if(g){if(this._engine.dbgSanityChecks&&g.texture===null){C.Error(`Trying to bind a null external texture! entry=${JSON.stringify(d)}, name=${p}, bindingInfo=${JSON.stringify(g,(y,M)=>y==="texture"?"<no dump>":M)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}let b=g.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!b){C.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(d)}, name=${p}, bindingInfo=${JSON.stringify(g,(y,M)=>y==="texture"?"<no dump>":M)}, isReady=${g.texture?.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}c[f].resource=this._device.importExternalTexture({source:b})}else C.Error(`External texture "${p}" not found in the material context. Make sure you bound it. entry=${JSON.stringify(d)}, materialContext=${JSON.stringify(i,(b,y)=>b==="texture"||b==="sampler"?"<no dump>":y)}`,50)}else if(d.buffer){let g=t.buffers[p];if(g){let b=g.underlyingResource;c[f].resource.buffer=b,c[f].resource.size=g.capacity}else C.Error(`Can't find buffer "${p}" in the draw context. Make sure you bound it. entry=${JSON.stringify(d)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}let h=o[u];r[u]=this._device.createBindGroup({layout:h,entries:c})}return r}};ie.NumBindGroupsCreatedTotal=0;ie.NumBindGroupsCreatedLastFrame=0;ie.NumBindGroupsLookupLastFrame=0;ie.NumBindGroupsNoLookupLastFrame=0;ie._Cache=new Le;ie._NumBindGroupsCreatedCurrentFrame=0;ie._NumBindGroupsLookupCurrentFrame=0;ie._NumBindGroupsNoLookupCurrentFrame=0});var Xr,Ja,jr=A(()=>{"use strict";Qi();Xr="clearQuadVertexShader",Ja=`uniform depthValue: f32;const pos=array(
vec2f(-1.0,1.0),
vec2f(1.0,1.0),
vec2f(-1.0,-1.0),
vec2f(1.0,-1.0)
);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.position=vec4f(pos[input.vertexIndex],uniforms.depthValue,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;We.ShadersStoreWGSL[Xr]||(We.ShadersStoreWGSL[Xr]=Ja)});var Jr,eo,es=A(()=>{"use strict";Qi();Jr="clearQuadPixelShader",eo=`uniform color: vec4f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=uniforms.color;}
`;We.ShadersStoreWGSL[Jr]||(We.ShadersStoreWGSL[Jr]=eo)});var Tt,ts=A(()=>{"use strict";hi();je();be();Mt();jr();es();Tt=class{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new Me(this._device,i),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"],void 0,void 0,void 0,void 0,void 0,void 0,1)}clear(e,t,i,r,n=1){let a,o=null,u,l=!!this._engine._currentRenderTarget;if(e)a=e;else{let g=0;this._keyTemp.length=0;for(let y=0;y<this._cacheRenderPipeline.colorFormats.length;++y)this._keyTemp[g++]=ne[this._cacheRenderPipeline.colorFormats[y]??""];let b=ne[this._depthTextureFormat??0];if(this._keyTemp[g]=(t?t.r+t.g*256+t.b*256*256+t.a*256*256*256:0)+(i?2**32:0)+(r?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(l?2**35:0)+(n>1?2**36:0)+b*2**37,u=this._keyTemp.join("_"),o=this._bundleCache[u],o)return o;a=this._device.createRenderBundleEncoder({label:"clearQuadRenderBundle",colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:B.GetSample(n)})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!r&&!!this._depthTextureFormat&&B.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(r?255:0),this._cacheRenderPipeline.setStencilCompare(r?519:512),this._cacheRenderPipeline.setStencilPassOp(r?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);let c=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,n),h=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),h.uniformBuffer.update();let f=l?this._engine._ubInvertY:this._engine._ubDontInvertY,d=h.uniformBuffer.getBuffer(),_=d.uniqueId+"-"+f.uniqueId,p=this._bindGroups[_];if(!p){let g=h.bindGroupLayouts[0];p=this._bindGroups[_]=[],p.push(this._device.createBindGroup({label:`clearQuadBindGroup0-${_}`,layout:g[0],entries:[]})),fe._SimplifiedKnownBindings||p.push(this._device.createBindGroup({label:`clearQuadBindGroup1-${_}`,layout:g[1],entries:[]})),p.push(this._device.createBindGroup({label:`clearQuadBindGroup${fe._SimplifiedKnownBindings?1:2}-${_}`,layout:g[fe._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:f.underlyingResource,size:f.capacity}},{binding:1,resource:{buffer:d.underlyingResource,size:d.capacity}}]}))}a.setPipeline(c);for(let g=0;g<p.length;++g)a.setBindGroup(g,p[g]);return a.draw(4,1,0,0),e||(o=a.finish(),this._bundleCache[u]=o),o}}});var Bt,Rt,st,Pt,Ft,Lt,fi,Et,pi=A(()=>{"use strict";be();Bt=class s{constructor(e,t,i,r){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(r)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new s(this.x,this.y,this.w,this.h)}},Rt=class s{constructor(e,t,i,r){this.x=e,this.y=t,this.w=i,this.h=r}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new s(this.x,this.y,this.w,this.h)}},st=class s{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new s(this.ref)}},Pt=class s{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new s(this.color)}},Ft=class s{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new s(this.query)}},Lt=class s{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new s}},fi=class s{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){let e=new s;return e.bundles=this.bundles,e}},Et=class s{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){let t=new fi;this._list[this._listLength++]=t,this._currentBundleList=t.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:B.GetSample(i)})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();let e=new s(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}});var ze,mi=A(()=>{"use strict";Ne();ze=class{get querySet(){return this._querySet}constructor(e,t,i,r,n,a=!0,o){this._dstBuffers=[],this._engine=e,this._device=r,this._bufferManager=n,this._count=t,this._canUseMultipleBuffers=a,this._querySet=r.createQuerySet({label:o??"QuerySet",type:i,count:t}),this._queryBuffer=n.createRawBuffer(8*t,R.QueryResolve|R.CopySrc,void 0,"QueryBuffer"),a||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,R.MapRead|R.CopyDst,void 0,"QueryBufferNoMultipleBuffers"))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&this._dstBuffers.length===0)return null;let i=this._device.createCommandEncoder(),r;return this._dstBuffers.length===0?r=this._bufferManager.createRawBuffer(8*this._count,R.MapRead|R.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(r=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,r,0,8*t),this._device.queue.submit([i.finish()]),r}async readValues(e=0,t=1){let i=this._getBuffer(e,t);if(i===null)return null;let r=this._engine.uniqueId;try{await i.mapAsync(1);let n=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,n}catch(n){if(this._engine.isDisposed||this._engine.uniqueId!==r)return null;throw n}}async readValue(e=0){let t=this._getBuffer(e,1);if(t===null)return null;let i=this._engine.uniqueId;try{await t.mapAsync(1);let r=new BigUint64Array(t.getMappedRange()),n=Number(r[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,n}catch(r){if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw r}}async readTwoValuesAndSubtract(e=0){let t=this._getBuffer(e,2);if(t===null)return null;let i=this._engine.uniqueId;try{await t.mapAsync(1);let r=new BigUint64Array(t.getMappedRange()),n=Number(r[1]-r[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,n}catch(r){if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw r}}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}});var Ut,gi,is=A(()=>{"use strict";tr();mi();te();Ut=class{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t,i){this._enabled=!1,this._gpuFrameTimeCounter=new mt,this._measureDurationState=0,this._engine=e,this._device=t,this._bufferManager=i}get enable(){return this._enabled}set enable(e){if(this._enabled!==e)if(this._enabled=e,this._measureDurationState=0,e)try{this._measureDuration=new gi(this._engine,this._device,this._bufferManager,2e3,"QuerySet_TimestampQuery")}catch(t){this._enabled=!1,C.Error(`Could not create a WebGPUDurationMeasure!
Error: `+t.message+`
Make sure timestamp query is supported and enabled in your browser.`);return}else this._measureDuration.dispose()}startFrame(e){this._enabled&&this._measureDurationState===0&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){this._measureDurationState===1&&(this._measureDurationState=2,this._measureDuration.stop(e).then(t=>{t!==null&&t>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(t,!0)),this._measureDurationState=0}))}startPass(e,t){this._enabled?this._measureDuration.startPass(e,t):e.timestampWrites=void 0}endPass(e,t){if(!this._enabled||!t)return;let i=this._engine.frameId;this._measureDuration.stopPass(e).then(r=>{t._addDuration(i,r!==null&&r>0?r:0)})}dispose(){this._measureDuration?.dispose()}},gi=class{constructor(e,t,i,r=2,n){this._count=r,this._querySet=new ze(e,r,"timestamp",t,i,!0,n)}start(e){e.writeTimestamp?.(this._querySet.querySet,0)}async stop(e){return e.writeTimestamp?.(this._querySet.querySet,1),e.writeTimestamp?await this._querySet.readTwoValuesAndSubtract(0):0}startPass(e,t){if(t+3>this._count)throw new Error("WebGPUDurationMeasure: index out of range ("+t+")");e.timestampWrites={querySet:this._querySet.querySet,beginningOfPassWriteIndex:t+2,endOfPassWriteIndex:t+3}}async stopPass(e){return await this._querySet.readTwoValuesAndSubtract(e+2)}dispose(){this._querySet.dispose()}}});var Ot,rs=A(()=>{"use strict";mi();Ot=class{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return!1;let t=this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet!==void 0;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,i,r=50,n=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=n,this._allocateNewIndices(r)}createQuery(){this._availableIndices.length===0&&this._allocateNewIndices();let e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){return Number(this._lastBuffer?.[e]??-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new ze(this._engine,this._currentTotalIndices,"occlusion",this._device,this._bufferManager,!1,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId}_delayQuerySetDispose(){let e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){this._querySet?.dispose(),this._availableIndices.length=0}}});var ss,ns=A(()=>{"use strict";te();xt();ss=(()=>{class s{get code(){return this._sourceCode}constructor(t,i=20){this.debug=!1,this._sourceCode=t,this._numMaxIterations=i,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&C.Log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&C.Log("End of inlining process.")}_collectFunctions(){let t=0;for(;t<this._sourceCode.length;){let i=this._sourceCode.indexOf(this.inlineToken,t);if(i<0)break;let r=this._sourceCode.indexOf("(",i+this.inlineToken.length);if(r<0){this.debug&&C.Warn(`Could not find the opening parenthesis after the token. startIndex=${t}`),t=i+this.inlineToken.length;continue}let n=s._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(i+this.inlineToken.length,r));if(!n){this.debug&&C.Warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(i+this.inlineToken.length,r)}`),t=i+this.inlineToken.length;continue}let[a,o]=[n[3],n[4]],u=Je("(",")",this._sourceCode,r);if(u<0){this.debug&&C.Warn(`Could not extract the parameters the function '${o}' (type=${a}). funcParamsStartIndex=${r}`),t=i+this.inlineToken.length;continue}let l=this._sourceCode.substring(r+1,u),c=ui(this._sourceCode,u+1);if(c===this._sourceCode.length){this.debug&&C.Warn(`Could not extract the body of the function '${o}' (type=${a}). funcParamsEndIndex=${u}`),t=i+this.inlineToken.length;continue}let h=Je("{","}",this._sourceCode,c);if(h<0){this.debug&&C.Warn(`Could not extract the body of the function '${o}' (type=${a}). funcBodyStartIndex=${c}`),t=i+this.inlineToken.length;continue}let f=this._sourceCode.substring(c,h+1),d=et(l).split(","),_=[];for(let b=0;b<d.length;++b){let y=d[b].trim(),M=y.lastIndexOf(" ");M>=0&&_.push(y.substring(M+1))}a!=="void"&&_.push("return"),this._functionDescr.push({name:o,type:a,parameters:_,body:f,callIndex:0}),t=h+1;let p=i>0?this._sourceCode.substring(0,i):"",g=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";this._sourceCode=p+g,t-=h+1-i}this.debug&&C.Log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=${this._functionDescr}`)}_processInlining(t=20){for(;t-->=0&&this._replaceFunctionCallsByCode(););return this.debug&&C.Log(`numMaxIterations is ${t} after inlining process`),t>=0}_replaceFunctionCallsByCode(){let t=!1;for(let i of this._functionDescr){let{name:r,type:n,parameters:a,body:o}=i,u=0;for(;u<this._sourceCode.length;){let l=this._sourceCode.indexOf(r,u);if(l<0)break;if(l===0||bt(this._sourceCode.charAt(l-1))){u=l+r.length;continue}let c=ui(this._sourceCode,l+r.length);if(c===this._sourceCode.length||this._sourceCode.charAt(c)!=="("){u=l+r.length;continue}let h=Je("(",")",this._sourceCode,c);if(h<0){this.debug&&C.Warn(`Could not extract the parameters of the function call. Function '${r}' (type=${n}). callParamsStartIndex=${c}`),u=l+r.length;continue}let f=this._sourceCode.substring(c+1,h),_=(w=>{let I=[],v=0,D=0;for(;v<w.length;){if(w.charAt(v)==="("){let T=Je("(",")",w,v);if(T<0)return null;v=T}else w.charAt(v)===","&&(I.push(w.substring(D,v)),D=v+1);v++}return D<v&&I.push(w.substring(D,v)),I})(et(f));if(_===null){this.debug&&C.Warn(`Invalid function call: can't extract the parameters of the function call. Function '${r}' (type=${n}). callParamsStartIndex=${c}, callParams=`+f),u=l+r.length;continue}let p=[];for(let w=0;w<_.length;++w){let I=_[w].trim();p.push(I)}let g=n!=="void"?r+"_"+i.callIndex++:null;if(g&&p.push(g+" ="),p.length!==a.length){this.debug&&C.Warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${r}' (type=${n}). function parameters=${a}, call parameters=${p}`),u=l+r.length;continue}u=h+1;let b=this._replaceNames(o,a,p),y=l>0?this._sourceCode.substring(0,l):"",M=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";if(g){let w=Tr(this._sourceCode,l-1,`
`,"{");y=this._sourceCode.substring(0,w+1);let I=this._sourceCode.substring(w+1,l);this._sourceCode=y+n+" "+g+`;
`+b+`
`+I+g+M,this.debug&&C.Log(`Replace function call by code. Function '${r}' (type=${n}). injectDeclarationIndex=${w}, call parameters=${p}`)}else this._sourceCode=y+b+M,u+=b.length-(h+1-l),this.debug&&C.Log(`Replace function call by code. Function '${r}' (type=${n}). functionCallIndex=${l}, call parameters=${p}`);t=!0}}return t}_replaceNames(t,i,r){for(let n=0;n<i.length;++n){let a=new RegExp(Br(i[n]),"g"),o=i[n].length,u=r[n];t=t.replace(a,(l,...c)=>{let h=c[0];return bt(t.charAt(h-1))||bt(t.charAt(h+o))?i[n]:u})}return t}}return s._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/,s})()});var ve,as=A(()=>{"use strict";te();Xi();ve=class s{async initTwgsl(e){if(!s._Twgsl){if(e=e||{},e=z(z({},s._TwgslDefaultOptions),e),e.twgsl){s._Twgsl=e.twgsl;return}if(e.jsPath&&e.wasmPath&&await he.LoadBabylonScriptAsync(e.jsPath),self.twgsl){s._Twgsl=await self.twgsl(he.GetBabylonScriptURL(e.wasmPath));return}throw new Error("twgsl is not available.")}}convertSpirV2WGSL(e,t=!1){let i=s._Twgsl.convertSpirV2WGSL(e,s.DisableUniformityAnalysis||t);return s.ShowWGSLShaderCode&&(C.Log(i),C.Log("***********************************************")),s.DisableUniformityAnalysis||t?`diagnostic(off, derivative_uniformity);
`+i:i}};ve._TwgslDefaultOptions={jsPath:`${he._DefaultCdnUrl}/twgsl/twgsl.js`,wasmPath:`${he._DefaultCdnUrl}/twgsl/twgsl.wasm`};ve.ShowWGSLShaderCode=!1;ve.DisableUniformityAnalysis=!1;ve._Twgsl=null});var Gt,os=A(()=>{"use strict";te();Gt=class{constructor(e,t,i){this._record=!1,this._play=!1,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=!1,this.showDebugLogs=!1,this._engine=e,this._mode=t,this._bundleList=i}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._log("enabled",`activate=${e}, mode=${this._mode}`),this._allBundleLists.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endRenderPass(e){if(!this._record&&!this._play)return!1;let t=null;return this._record?(t=this._bundleList.clone(),this._allBundleLists.push(t),this._bundleList.reset(),this._log("endRenderPass",`bundleList recorded at position #${this._allBundleLists.length-1}`)):this._playBundleListIndex>=this._allBundleLists.length?this._log("endRenderPass",`empty or out-of-sync bundleList (_allBundleLists.length=${this._allBundleLists.length}, playBundleListIndex=${this._playBundleListIndex})`):(this._log("endRenderPass",`run bundleList #${this._playBundleListIndex}`),t=this._allBundleLists[this._playBundleListIndex++]),t&&(t.run(e),this._mode===1&&this._engine._reportDrawCall(t.numDrawCalls)),!0}endFrame(){this._record&&(this._record=!1,this._play=!0,this._mode=this._modeSaved,this._log("endFrame","bundles recorded, switching to play mode")),this._playBundleListIndex=0}reset(){this._log("reset","called"),this._record&&(this._mode=this._modeSaved),this.enabled=!1,this.enabled=!0}_log(e,t){this.showDebugLogs&&C.Log(`[Frame: ${this._engine.frameId}] WebGPUSnapshotRendering:${e} - ${t}`)}}});var nt,us=A(()=>{"use strict";Pe();dn();nt=(()=>{let s=new Uint8Array(4),e=new Uint32Array(s.buffer);return!!((e[0]=1)&s[0])})();Object.defineProperty(m.prototype,"effectiveByteStride",{get:function(){return this._alignedBuffer&&this._alignedBuffer.byteStride||this.byteStride},enumerable:!0,configurable:!0});Object.defineProperty(m.prototype,"effectiveByteOffset",{get:function(){return this._alignedBuffer?0:this.byteOffset},enumerable:!0,configurable:!0});Object.defineProperty(m.prototype,"effectiveBuffer",{get:function(){return this._alignedBuffer&&this._alignedBuffer.getBuffer()||this._buffer.getBuffer()},enumerable:!0,configurable:!0});m.prototype._rebuild=function(){this._buffer?._rebuild(),this._alignedBuffer?._rebuild()};m.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose(),this._alignedBuffer?.dispose(),this._alignedBuffer=void 0,this._isDisposed=!0};m.prototype.getWrapperBuffer=function(){return this._alignedBuffer||this._buffer};m.prototype._alignBuffer=function(){let s=this._buffer.getData();if(!this.engine._features.forceVertexBufferStrideAndOffsetMultiple4Bytes||this.byteStride%4===0&&this.byteOffset%4===0||!s)return;let e=Ji(this.type),t=this.byteStride+3&-4,i=t/e,r=this._maxVerticesCount,a=r*t/e,o;if(Array.isArray(s)){let h=new Float32Array(s);o=new DataView(h.buffer,h.byteOffset,h.byteLength)}else s instanceof ArrayBuffer?o=new DataView(s,0,s.byteLength):o=new DataView(s.buffer,s.byteOffset,s.byteLength);let u;this.type===m.BYTE?u=new Int8Array(a):this.type===m.UNSIGNED_BYTE?u=new Uint8Array(a):this.type===m.SHORT?u=new Int16Array(a):this.type===m.UNSIGNED_SHORT?u=new Uint16Array(a):this.type===m.INT?u=new Int32Array(a):this.type===m.UNSIGNED_INT?u=new Uint32Array(a):u=new Float32Array(a);let l=this.getSize(),c=this.byteOffset;for(let h=0;h<r;++h){for(let f=0;f<l;++f)switch(this.type){case m.BYTE:u[h*i+f]=o.getInt8(c+f);break;case m.UNSIGNED_BYTE:u[h*i+f]=o.getUint8(c+f);break;case m.SHORT:u[h*i+f]=o.getInt16(c+f*2,nt);break;case m.UNSIGNED_SHORT:u[h*i+f]=o.getUint16(c+f*2,nt);break;case m.INT:u[h*i+f]=o.getInt32(c+f*4,nt);break;case m.UNSIGNED_INT:u[h*i+f]=o.getUint32(c+f*4,nt);break;case m.FLOAT:u[h*i+f]=o.getFloat32(c+f*4,nt);break}c+=this.byteStride}this._alignedBuffer?.dispose(),this._alignedBuffer=new ai(this.engine,u,!1,t,!1,this.getIsInstanced(),!0,this.instanceDivisor,(this._label??"VertexBuffer")+"_aligned")}});function to(){return Ee.length===0?null:Ee[Ee.length-1]}function Ue(s){if(s||(s=to()),s)return s;throw new Error("No audio engine.")}function rl(s,e={},t=null){return t=Ue(t),t.createBusAsync(s,e)}function sl(s,e={},t=null){return t=Ue(t),t.createMainBusAsync(s,e)}function nl(s,e={},t=null){return t=Ue(t),t.createMicrophoneSoundSourceAsync(s,e)}function al(s,e,t={},i=null){return i=Ue(i),i.createSoundAsync(s,e,t)}async function ol(s,e={},t=null){return t=Ue(t),await t.createSoundBufferAsync(s,e)}function ul(s,e,t={},i=null){return i=Ue(i),i.createSoundSourceAsync(s,e,t)}function ll(s,e,t={},i=null){return i=Ue(i),i.createStreamingSoundAsync(s,e,t)}var Ee,Wt,ls=A(()=>{"use strict";Ee=[];Wt=class{constructor(e){this._mainBuses=new Set,this._sounds=new Set,this._soundsArray=null,this._nodes=new Set,this._defaultMainBus=null,this._parameterRampDuration=.01,Ee.push(this),typeof e.parameterRampDuration=="number"&&(this.parameterRampDuration=e.parameterRampDuration)}get defaultMainBus(){return this._mainBuses.size===0?null:(this._defaultMainBus||(this._defaultMainBus=Array.from(this._mainBuses)[0]),this._defaultMainBus)}get parameterRampDuration(){return this._parameterRampDuration}set parameterRampDuration(e){this._parameterRampDuration=Math.max(0,e)}get sounds(){return this._soundsArray||(this._soundsArray=Array.from(this._sounds)),this._soundsArray}dispose(){Ee.includes(this)&&Ee.splice(Ee.indexOf(this),1);let e=this._nodes.values();for(let t=e.next();!t.done;t=e.next())t.value.dispose();this._mainBuses.clear(),this._nodes.clear(),this._sounds.clear(),this._disposeSoundsArray(),this._defaultMainBus=null}unlockAsync(){return this.resumeAsync()}_addMainBus(e){this._mainBuses.add(e),this._addNode(e)}_removeMainBus(e){this._mainBuses.delete(e),this._defaultMainBus=null,this._removeNode(e)}_addNode(e){this._nodes.add(e)}_removeNode(e){this._nodes.delete(e)}_addSound(e){this._disposeSoundsArray(),this._sounds.add(e),this._addNode(e)}_removeSound(e){this._disposeSoundsArray(),this._sounds.delete(e),this._removeNode(e)}_disposeSoundsArray(){this._soundsArray&&(this._soundsArray.length=0,this._soundsArray=null)}}});function hs(s){return s.listenerEnabled||s.listenerMinUpdateTime!==void 0||s.listenerPosition!==void 0||s.listenerRotation!==void 0||s.listenerRotationQuaternion!==void 0}var cs,Vt,_i=A(()=>{"use strict";_e();cs={position:x.Zero(),rotation:x.Zero(),rotationQuaternion:new O};Vt=class{}});var Nt,ds=A(()=>{"use strict";_n();_i();Nt=class extends Vt{constructor(){super(),this._attacherComponent=null,this._attacherComponent=new oi(this)}get isAttached(){return this._attacherComponent!==null&&this._attacherComponent.isAttached}attach(e,t=!1,i=3){this._attacherComponent||(this._attacherComponent=new oi(this)),this._attacherComponent.attach(e,t,i)}detach(){this._attacherComponent?.detach()}dispose(){this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(e){e.listenerMinUpdateTime!==void 0&&(this.minUpdateTime=e.listenerMinUpdateTime),e.listenerPosition&&(this.position=e.listenerPosition.clone()),e.listenerRotationQuaternion?this.rotationQuaternion=e.listenerRotationQuaternion.clone():e.listenerRotation?this.rotation=e.listenerRotation.clone():this.rotationQuaternion=cs.rotationQuaternion.clone(),this.update()}}});function Si(s,e,t){let i=s._audioContext.listener;return i.forwardX&&i.forwardY&&i.forwardZ&&i.positionX&&i.positionY&&i.positionZ&&i.upX&&i.upY&&i.upZ?new yi(s,e,t):new Ii(s,e,t)}var bi,xi,fs,ps,kt,yi,Ii,ms=A(()=>{"use strict";_e();ds();bn();lr();bi=F.Zero(),xi=new O,fs=x.Zero(),ps=x.Zero();kt=class extends Nt{constructor(e,t,i){super(),this._lastPosition=x.Zero(),this._lastRotation=x.Zero(),this._lastRotationQuaternion=new O,this.position=x.Zero(),this.rotation=x.Zero(),this.rotationQuaternion=new O,this._listener=e._audioContext.listener,this.engine=e,this._updaterComponent=new ur(this,t,i)}dispose(){super.dispose(),this._updaterComponent.dispose(),this._updaterComponent=null}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||(this._setWebAudioPosition(this.position),this._lastPosition.copyFrom(this.position))}_updateRotation(){if(!this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))xi.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);else if(!this._lastRotation.equalsWithEpsilon(this.rotation))O.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,xi),this._lastRotation.copyFrom(this.rotation);else return;F.FromQuaternionToRef(xi,bi),x.TransformNormalToRef(x.RightHandedForwardReadOnly,bi,fs),x.TransformNormalToRef(x.Up(),bi,ps),this._setWebAudioOrientation(fs,ps)}},yi=class extends kt{constructor(e,t,i){super(e,t,i);let r=e._audioContext.listener;this._forwardX=new re(e,r.forwardX),this._forwardY=new re(e,r.forwardY),this._forwardZ=new re(e,r.forwardZ),this._positionX=new re(e,r.positionX),this._positionY=new re(e,r.positionY),this._positionZ=new re(e,r.positionZ),this._upX=new re(e,r.upX),this._upY=new re(e,r.upY),this._upZ=new re(e,r.upZ)}_setWebAudioPosition(e){this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=e.x,this._positionY.targetValue=e.y,this._positionZ.targetValue=e.z)}_setWebAudioOrientation(e,t){this.isAttached&&(this._forwardX.isRamping||this._forwardY.isRamping||this._forwardZ.isRamping||this._upX.isRamping||this._upY.isRamping||this._upZ.isRamping)||(this._forwardX.targetValue=e.x,this._forwardY.targetValue=e.y,this._forwardZ.targetValue=e.z,this._upX.targetValue=t.x,this._upY.targetValue=t.y,this._upZ.targetValue=t.z)}},Ii=class extends kt{_setWebAudioPosition(e){this._listener.setPosition(e.x,e.y,e.z)}_setWebAudioOrientation(e,t){this._listener.setOrientation(e.x,e.y,e.z,t.x,t.y,t.z)}}});var $t,gs=A(()=>{"use strict";xn();$t=class extends cr{constructor(e){super(e,1)}}});var zt,_s=A(()=>{"use strict";gs();lr();zt=class extends $t{constructor(e){super(e),this._setGainNode(new GainNode(e._audioContext))}dispose(){super.dispose(),this._volume.dispose(),this._gainNode.disconnect(),this._destinationNode.disconnect()}get _inNode(){return this._gainNode}set _inNode(e){this._gainNode!==e&&this._setGainNode(e)}get volume(){return this._volume.targetValue}set volume(e){this._volume.targetValue=e}get _destinationNode(){return this.engine._audioDestination}getClassName(){return"_WebAudioMainOut"}setVolume(e,t=null){this._volume.setTargetValue(e,t)}_setGainNode(e){this._gainNode!==e&&(this._gainNode?.disconnect(),e.connect(this._destinationNode),this._volume=new re(this.engine,e.gain),this._gainNode=e)}}});var Qt,bs=A(()=>{"use strict";Js();Qt=class{constructor(e,t){this._button=null,this._enabled=!0,this._style=null,this._onStateChanged=()=>{this._button&&(this._engine.state==="running"?this._hide():this._show())},this._engine=e;let i=t||Ui.LastCreatedEngine?.getInputElement()?.parentElement||document.body,r=(i?.offsetTop||0)+20;this._style=document.createElement("style"),this._style.appendChild(document.createTextNode(`.babylonUnmute{position:absolute;top:${r}px;margin-left:20px;height:40px;width:60px;background-color:rgba(51,51,51,0.7);background-image:url("data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E");background-size:80%;background-repeat:no-repeat;background-position:center;background-position-y:4px;border:none;outline:none;transition:transform 0.125s ease-out;cursor:pointer;z-index:9999;}.babylonUnmute:hover{transform:scale(1.05)}`)),document.head.appendChild(this._style),this._button=document.createElement("button"),this._button.className="babylonUnmute",this._button.id="babylonUnmuteButton",this._button.addEventListener("click",()=>{this._engine.unlockAsync()}),i.appendChild(this._button),this._engine.stateChangedObservable.add(this._onStateChanged)}dispose(){this._button?.remove(),this._button=null,this._style?.remove(),this._style=null,this._engine.stateChangedObservable.removeCallback(this._onStateChanged)}get enabled(){return this._enabled}set enabled(e){this._enabled=e,e?this._engine.state!=="running"&&this._show():this._hide()}_show(){!this._button||!this._enabled||(this._button.style.display="block")}_hide(){this._button&&(this._button.style.display="none")}}});async function Ll(s={}){let e=new at(s);return await e._initAsync(s),e}var io,at,xs=A(()=>{"use strict";dt();ls();_i();ms();_s();bs();io={aac:"audio/aac",ac3:"audio/ac3",flac:"audio/flac",m4a:"audio/mp4",mp3:'audio/mpeg; codecs="mp3"',mp4:"audio/mp4",ogg:'audio/ogg; codecs="vorbis"',wav:"audio/wav",webm:'audio/webm; codecs="vorbis"'},at=class extends Wt{constructor(e={}){super(e),this._audioContextStarted=!1,this._destinationNode=null,this._invalidFormats=new Set,this._isUpdating=!1,this._listener=null,this._listenerAutoUpdate=!0,this._listenerMinUpdateTime=0,this._pauseCalled=!1,this._resumeOnInteraction=!0,this._resumeOnPause=!0,this._resumeOnPauseRetryInterval=1e3,this._resumeOnPauseTimerId=null,this._resumePromise=null,this._silentHtmlAudio=null,this._unmuteUI=null,this._updateObservable=null,this._validFormats=new Set,this._volume=1,this._isUsingOfflineAudioContext=!1,this.isReadyPromise=new Promise(t=>{this._resolveIsReadyPromise=t}),this.stateChangedObservable=new j,this.userGestureObservable=new j,this._initAudioContextAsync=async()=>{this._audioContext.addEventListener("statechange",this._onAudioContextStateChange),this._mainOut=new zt(this),this._mainOut.volume=this._volume,await this.createMainBusAsync("default")},this._onAudioContextStateChange=()=>{this.state==="running"&&(clearInterval(this._resumeOnPauseTimerId),this._audioContextStarted=!0,this._resumePromise=null),(this.state==="suspended"||this.state==="interrupted")&&this._audioContextStarted&&this._resumeOnPause&&!this._pauseCalled&&(clearInterval(this._resumeOnPauseTimerId),this._resumeOnPauseTimerId=setInterval(()=>{this.resumeAsync()},this._resumeOnPauseRetryInterval)),this.stateChangedObservable.notifyObservers(this.state)},this._onUserGestureAsync=async()=>{if(this._resumeOnInteraction&&await this._audioContext.resume(),!this._silentHtmlAudio){this._silentHtmlAudio=document.createElement("audio");let t=this._silentHtmlAudio;t.controls=!1,t.preload="auto",t.loop=!0,t.src="data:audio/wav;base64,UklGRjAAAABXQVZFZm10IBAAAAABAAEAgLsAAAB3AQACABAAZGF0YQwAAAAAAAEA/v8CAP//AQA=",t.play()}this.userGestureObservable.notifyObservers()},this._startUpdating=()=>{if(!this._isUpdating)if(this._isUpdating=!0,this.state==="running")this._update();else{let t=()=>{this.state==="running"&&(this._update(),this.stateChangedObservable.removeCallback(t))};this.stateChangedObservable.add(t)}},this._update=()=>{this._updateObservable?.hasObservers()?(this._updateObservable.notifyObservers(),requestAnimationFrame(this._update)):this._isUpdating=!1},typeof e.listenerAutoUpdate=="boolean"&&(this._listenerAutoUpdate=e.listenerAutoUpdate),typeof e.listenerMinUpdateTime=="number"&&(this._listenerMinUpdateTime=e.listenerMinUpdateTime),this._volume=e.volume??1,e.audioContext?(this._isUsingOfflineAudioContext=e.audioContext instanceof OfflineAudioContext,this._audioContext=e.audioContext):this._audioContext=new AudioContext,e.disableDefaultUI||(this._unmuteUI=new Qt(this,e.defaultUIParentElement))}async _initAsync(e){this._resumeOnInteraction=typeof e.resumeOnInteraction=="boolean"?e.resumeOnInteraction:!0,this._resumeOnPause=typeof e.resumeOnPause=="boolean"?e.resumeOnPause:!0,this._resumeOnPauseRetryInterval=e.resumeOnPauseRetryInterval??1e3,document.addEventListener("click",this._onUserGestureAsync),await this._initAudioContextAsync(),hs(e)&&(this._listener=Si(this,this._listenerAutoUpdate,this._listenerMinUpdateTime),this._listener.setOptions(e)),this._resolveIsReadyPromise()}get currentTime(){return this._audioContext.currentTime??0}get _inNode(){return this._audioContext.destination}get mainOut(){return this._mainOut}get listener(){return this._listener??(this._listener=Si(this,this._listenerAutoUpdate,this._listenerMinUpdateTime))}get state(){return this._isUsingOfflineAudioContext?"running":this._audioContext.state}get volume(){return this._volume}set volume(e){this._volume!==e&&(this._volume=e,this._mainOut&&(this._mainOut.volume=e))}get _audioDestination(){return this._destinationNode?this._destinationNode:this._destinationNode=this._audioContext.destination}set _audioDestination(e){this._destinationNode=e}get _unmuteUIEnabled(){return this._unmuteUI?this._unmuteUI.enabled:!1}set _unmuteUIEnabled(e){this._unmuteUI&&(this._unmuteUI.enabled=e)}async createBusAsync(e,t={}){let i=await import("./chunk-DNHH6KFV.js"),r=new i._WebAudioBus(e,this,t);return await r._initAsync(t),r}async createMainBusAsync(e,t={}){let i=await import("./chunk-OHMF54ER.js"),r=new i._WebAudioMainBus(e,this);return await r._initAsync(t),r}async createMicrophoneSoundSourceAsync(e,t){let i;try{i=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(r){throw new Error("Unable to access microphone: "+r)}return await this.createSoundSourceAsync(e,new MediaStreamAudioSourceNode(this._audioContext,{mediaStream:i}),z({outBusAutoDefault:!1},t))}async createSoundAsync(e,t,i={}){let r=await import("./chunk-XP6FGJSU.js"),n=new r._WebAudioStaticSound(e,this,i);return await n._initAsync(t,i),n}async createSoundBufferAsync(e,t={}){let i=await import("./chunk-XP6FGJSU.js"),r=new i._WebAudioStaticSoundBuffer(this);return await r._initAsync(e,t),r}async createSoundSourceAsync(e,t,i={}){let r=await import("./chunk-77ENO76I.js"),n=new r._WebAudioSoundSource(e,t,this,i);return await n._initAsync(i),n}async createStreamingSoundAsync(e,t,i={}){let r=await import("./chunk-FNLCOVWS.js"),n=new r._WebAudioStreamingSound(e,this,i);return await n._initAsync(t,i),n}dispose(){super.dispose(),this._listener?.dispose(),this._listener=null,this._audioContext.state!=="closed"&&!this._isUsingOfflineAudioContext&&this._audioContext.close(),document.removeEventListener("click",this._onUserGestureAsync),this._audioContext.removeEventListener("statechange",this._onAudioContextStateChange),this._silentHtmlAudio?.remove(),this._updateObservable?.clear(),this._updateObservable=null,this._unmuteUI?.dispose(),this._unmuteUI=null,this.stateChangedObservable.clear()}flagInvalidFormat(e){this._invalidFormats.add(e)}isFormatValid(e){if(this._validFormats.has(e))return!0;if(this._invalidFormats.has(e))return!1;let t=io[e];return t===void 0?!1:new Audio().canPlayType(t)===""?(this._invalidFormats.add(e),!1):(this._validFormats.add(e),!0)}async pauseAsync(){await this._audioContext.suspend(),this._pauseCalled=!0}resumeAsync(){return this._pauseCalled=!1,this._resumePromise?this._resumePromise:(this._resumePromise=this._audioContext.resume(),this.stateChangedObservable.notifyObservers(this.state),this._resumePromise)}setVolume(e,t=null){if(this._mainOut)this._mainOut.setVolume(e,t);else throw new Error("Main output not initialized yet.")}_addMainBus(e){super._addMainBus(e)}_removeMainBus(e){super._removeMainBus(e)}_addNode(e){super._addNode(e)}_removeNode(e){super._removeNode(e)}_addSound(e){super._addSound(e)}_removeSound(e){super._removeSound(e)}_addUpdateObserver(e){this._updateObservable||(this._updateObservable=new j),this._updateObservable.add(e),this._startUpdating()}_removeUpdateObserver(e){this._updateObservable&&this._updateObservable.removeCallback(e)}}});var Mi,ys=A(()=>{"use strict";xs();Ve();dt();H.AudioEngineFactory=(s,e,t)=>new Mi(s,e,t);Mi=class{get masterGain(){return this._masterGain}set masterGain(e){this._masterGain=this._v2.mainOut._inNode=e}get useCustomUnlockedButton(){return this._useCustomUnlockedButton}set useCustomUnlockedButton(e){this._useCustomUnlockedButton=e,this._v2._unmuteUIEnabled=!e}get audioContext(){return this._v2.state==="running"&&this._triggerRunningStateAsync(),this._v2._audioContext}constructor(e=null,t=null,i=null){this._tryToRun=!1,this._useCustomUnlockedButton=!1,this.canUseWebAudio=!0,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.onAudioUnlockedObservable=new j,this.onAudioLockedObservable=new j;let r=new at({audioContext:t||void 0,defaultUIParentElement:e?.parentElement?e.parentElement:void 0});r._unmuteUIEnabled=!1,this._masterGain=new GainNode(r._audioContext),r._audioDestination=i,r.stateChangedObservable.add(n=>{n==="running"?(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)):(this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this))}),r._initAsync({resumeOnInteraction:!1}).then(()=>{let n=r.defaultMainBus._outNode;n&&(n.disconnect(r.mainOut._inNode),n.connect(this._masterGain)),r.mainOut._inNode=this._masterGain,r.stateChangedObservable.notifyObservers(r.state)}),this.isMP3supported=r.isFormatValid("mp3"),this.isOGGsupported=r.isFormatValid("ogg"),this._v2=r}lock(){this._v2._audioContext.suspend(),this._useCustomUnlockedButton||(this._v2._unmuteUIEnabled=!0)}unlock(){if(this._v2._audioContext?.state==="running"){this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this));return}this._triggerRunningStateAsync()}_resumeAudioContextOnStateChange(){this._v2._audioContext?.addEventListener("statechange",()=>{this.unlocked&&this._v2._audioContext?.state!=="running"&&this._resumeAudioContextAsync()},{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContextAsync(){return this._v2._isUsingOfflineAudioContext?Promise.resolve():(this._v2._audioContext.state==="suspended"&&!this._useCustomUnlockedButton&&(this._v2._unmuteUIEnabled=!0),this._v2._audioContext.resume())}dispose(){this._v2.dispose(),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.masterGain.gain.value}setGlobalVolume(e){this.masterGain.gain.value=e}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._v2._audioContext.destination)}async _triggerRunningStateAsync(){if(this._tryToRun){this._v2._audioContext.resume();return}this._tryToRun=!0,await this._resumeAudioContextAsync(),this._tryToRun=!1,this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)}}});var Kt,Is=A(()=>{"use strict";di();Kt=class extends $e{constructor(e){super(e)}}});var Ss=A(()=>{"use strict";Ve();Tn();de();P.prototype.setAlphaMode=function(s,e=!1,t=0){let i=this._alphaState._alphaBlend[t];if(this._alphaMode[t]===s&&(s===0&&!i||s!==0&&i)){if(!e){let n=s===0;this.depthCullingState.depthMask!==n&&(this.setDepthWrite(n),this._cacheRenderPipeline.setDepthWriteEnabled(n))}return}let r=s===0;this._alphaState.setAlphaBlend(!r,t),this._alphaState.setAlphaMode(s,t),e||(this.setDepthWrite(r),this._cacheRenderPipeline.setDepthWriteEnabled(r)),this._alphaMode[t]=s,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};P.prototype.setAlphaEquation=function(s,e=0){H.prototype.setAlphaEquation.call(this,s,e),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}});function ot(s,e,t,i){let r,n=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),n=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let a=0;a<e;a++)for(let o=0;o<t;o++){let u=(o*e+a)*3,l=(o*e+a)*4;r[l+0]=s[u+0],r[l+1]=s[u+1],r[l+2]=s[u+2],r[l+3]=n}return r}var Ms=A(()=>{"use strict";Re();te();de();P.prototype.createRawTexture=function(s,e,t,i,r,n,a,o=null,u=0,l=0,c=!1){let h=new K(this,3);return h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=r,h.samplingMode=a,h.invertY=n,h._compression=o,h.type=u,h._creationFlags=l,h._useSRGBBuffer=c,this._doNotHandleContextLost||(h._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(h,e,t,void 0,l),this.updateRawTexture(h,s,i,n,o,u,c),this._internalTexturesCache.push(h),h};P.prototype.updateRawTexture=function(s,e,t,i,r=null,n=0,a=!1){if(s){if(this._doNotHandleContextLost||(s._bufferView=e,s.invertY=i,s._compression=r,s._useSRGBBuffer=a),e){let o=s._hardwareTexture;t===4&&(e=ot(e,s.width,s.height,n));let l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,s,s.width,s.height,s.depth,o.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0}};P.prototype.createRawCubeTexture=function(s,e,t,i,r,n,a,o=null){let u=new K(this,8);if(i===1&&!this._caps.textureFloatLinearFiltering?(r=!1,a=1,C.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===2&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,a=1,C.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===1&&!this._caps.textureFloatRender?(r=!1,C.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):i===2&&!this._caps.colorBufferFloat&&(r=!1,C.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")),u.isCube=!0,u._originalFormat=t,u.format=t===4?5:t,u.type=i,u.generateMipMaps=r,u.width=e,u.height=e,u.samplingMode=a,this._doNotHandleContextLost||(u._bufferViewArray=s),u.invertY=n,u._compression=o,u._cachedWrapU=0,u._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(u),t===4){let l=u._hardwareTexture;l._originalFormatIsRGB=!0}return s&&this.updateRawCubeTexture(u,s,t,i,n,o),u.isReady=!0,u};P.prototype.updateRawCubeTexture=function(s,e,t,i,r,n=null){s._bufferViewArray=e,s.invertY=r,s._compression=n;let a=s._hardwareTexture,o=a._originalFormatIsRGB,u=[0,2,4,1,3,5],l=[];for(let c=0;c<e.length;++c){let h=e[u[c]];o&&(h=ot(h,s.width,s.height,i)),l.push(new Uint8Array(h.buffer,h.byteOffset,h.byteLength))}this._textureHelper.updateCubeTextures(l,a.underlyingResource,s.width,s.height,a.format,r,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder),s.isReady=!0};P.prototype.createRawCubeTextureFromUrl=function(s,e,t,i,r,n,a,o,u=null,l=null,c=3,h=!1){let f=this.createRawCubeTexture(null,t,i,r,!n,h,c,null);e?.addPendingData(f),f.url=s,f.isReady=!1,this._internalTexturesCache.push(f);let d=(p,g)=>{e?.removePendingData(f),l&&p&&l(p.status+" "+p.statusText,g)},_=async p=>{let g=a(p);if(!g)return;let b=g instanceof Promise?await g:g,y=f.width;if(o){let M=i===4,w=o(b),I=f._hardwareTexture,v=[0,1,2,3,4,5];for(let D=0;D<w.length;D++){let T=y>>D,W=[];for(let E=0;E<6;E++){let Q=w[D][v[E]];M&&(Q=ot(Q,T,T,r)),W.push(new Uint8Array(Q.buffer,Q.byteOffset,Q.byteLength))}this._textureHelper.updateCubeTextures(W,I.underlyingResource,T,T,I.format,h,!1,0,0)}}else this.updateRawCubeTexture(f,b,i,r,h);f.isReady=!0,e?.removePendingData(f),u&&u()};return this._loadFile(s,p=>{_(p).catch(g=>{d(void 0,g)})},void 0,e?.offlineProvider,!0,d),f};P.prototype.createRawTexture3D=function(s,e,t,i,r,n,a,o,u=null,l=0,c=0){let f=new K(this,10);return f.baseWidth=e,f.baseHeight=t,f.baseDepth=i,f.width=e,f.height=t,f.depth=i,f.format=r,f.type=l,f.generateMipMaps=n,f.samplingMode=o,f.is3D=!0,f._creationFlags=c,this._doNotHandleContextLost||(f._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(f,e,t,void 0,c),this.updateRawTexture3D(f,s,r,a,u,l),this._internalTexturesCache.push(f),f};P.prototype.updateRawTexture3D=function(s,e,t,i,r=null,n=0){if(this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.invertY=i,s._compression=r),e){let a=s._hardwareTexture;t===4&&(e=ot(e,s.width,s.height,n));let u=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(u,s,s.width,s.height,s.depth,a.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0};P.prototype.createRawTexture2DArray=function(s,e,t,i,r,n,a,o,u=null,l=0,c=0){let f=new K(this,11);return f.baseWidth=e,f.baseHeight=t,f.baseDepth=i,f.width=e,f.height=t,f.depth=i,f.format=r,f.type=l,f.generateMipMaps=n,f.samplingMode=o,f.is2DArray=!0,f._creationFlags=c,this._doNotHandleContextLost||(f._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(f,e,t,i,c),this.updateRawTexture2DArray(f,s,r,a,u,l),this._internalTexturesCache.push(f),f};P.prototype.updateRawTexture2DArray=function(s,e,t,i,r=null,n=0){if(this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.invertY=i,s._compression=r),e){let a=s._hardwareTexture;t===4&&(e=ot(e,s.width,s.height,n));let u=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(u,s,s.width,s.height,s.depth,a.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0}});var vs=A(()=>{"use strict";de();P.prototype._readTexturePixels=function(s,e,t,i=-1,r=0,n=null,a=!0,o=!1,u=0,l=0){let c=s._hardwareTexture;return a&&this.flushFramebuffer(),this._textureHelper.readPixels(c.underlyingResource,u,l,e,t,c.format,i,r,n,o)};P.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"}});var Cs=A(()=>{"use strict";Re();be();de();P.prototype._createDepthStencilCubeTexture=function(s,e){let t=new K(this,e.generateStencil?12:14);t.isCube=!0,t.label=e.label;let i=z({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14},e);t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,s,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t);let r=t._hardwareTexture;return t.type=B.GetTextureTypeFromFormat(r.format),this._internalTexturesCache.push(t),t};P.prototype.createCubeTexture=function(s,e,t,i,r=null,n=null,a,o=null,u=!1,l=0,c=0,h=null,f,d=!1,_=null){return this.createCubeTextureBase(s,e,t,!!i,r,n,a,o,u,l,c,h,null,(p,g)=>{let b=g,y=b[0].width,M=y;this._setCubeMapTextureParams(p,!i),p.format=a??-1;let w=this._textureHelper.createGPUTextureForInternalTexture(p,y,M);this._textureHelper.updateCubeTextures(b,w.underlyingResource,y,M,w.format,!1,!1,0,0),i||this._generateMipmaps(p,this._uploadEncoder),p.isReady=!0,p.onLoadedObservable.notifyObservers(p),p.onLoadedObservable.clear(),r&&r()},!!d,_)};P.prototype._setCubeMapTextureParams=function(s,e,t){s.samplingMode=e?3:2,s._cachedWrapU=0,s._cachedWrapV=0,t&&(s._maxLodLevel=t)};P.prototype.generateMipMapsForCubemap=function(s){s.generateMipMaps&&(s._hardwareTexture?.underlyingResource||this._textureHelper.createGPUTextureForInternalTexture(s),this._generateMipmaps(s))}});var qt,ws=A(()=>{"use strict";Sn();wr();qt=class extends pr{constructor(e,t,i,r,n){super(e,t,i,r,n),r.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new gt)}}});var As=A(()=>{"use strict";Re();ws();yn();Mn();de();P.prototype._createHardwareRenderTargetWrapper=function(s,e,t){let i=new qt(s,e,t,this);return this._renderTargetWrapperCache.push(i),i};P.prototype.createRenderTargetTexture=function(s,e){let t=this._createHardwareRenderTargetWrapper(!1,!1,s),i={};e!==void 0&&typeof e=="object"?(i.generateMipMaps=e.generateMipMaps,i.generateDepthBuffer=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,i.generateStencilBuffer=i.generateDepthBuffer&&e.generateStencilBuffer,i.samplingMode=e.samplingMode===void 0?3:e.samplingMode,i.creationFlags=e.creationFlags??0,i.noColorAttachment=!!e.noColorAttachment,i.colorAttachment=e.colorAttachment,i.samples=e.samples,i.label=e.label,i.format=e.format,i.type=e.type):(i.generateMipMaps=e,i.generateDepthBuffer=!0,i.generateStencilBuffer=!1,i.samplingMode=3,i.creationFlags=0,i.noColorAttachment=!1);let r=i.colorAttachment||(i.noColorAttachment?null:this._createInternalTexture(s,i,!0,5));return t.label=i.label??"RenderTargetWrapper",t._samples=i.colorAttachment?.samples??i.samples??1,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=!!i.generateStencilBuffer,t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,!1,t._generateStencilBuffer,t.samples,i.generateStencilBuffer?13:14,i.label?i.label+"-DepthStencil":void 0),r&&!i.colorAttachment&&(e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r,void 0,void 0,void 0,i.creationFlags),e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1)),t};P.prototype._createDepthStencilTexture=function(s,e,t){let i=z({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14},e),r=dr(i.depthTextureFormat);t._depthStencilTextureWithStencil=r;let n=new K(this,r?12:14);return n.label=e.label,n.format=i.depthTextureFormat,n.type=hr(n.format),this._setupDepthStencilTexture(n,s,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(n),this._internalTexturesCache.push(n),n};P.prototype._setupDepthStencilTexture=function(s,e,t,i,r=1){let n=e.width??e,a=e.height??e,o=e.layers||0,u=e.depth||0;s.baseWidth=n,s.baseHeight=a,s.width=n,s.height=a,s.is2DArray=o>0,s.is3D=u>0,s.depth=o||u,s.isReady=!0,s.samples=r,s.generateMipMaps=!1,s.samplingMode=t?2:1,s.type=1,s._comparisonFunction=i,s._cachedWrapU=0,s._cachedWrapV=0};P.prototype.updateRenderTargetTextureSampleCount=function(s,e){return!s||!s.texture||s.samples===e||(e=Math.min(e,this.getCaps().maxMSAASamples),s.texture._hardwareTexture?.releaseMSAATextures(),s._depthStencilTexture&&(s._depthStencilTexture._hardwareTexture?.releaseMSAATextures(),s._depthStencilTexture.samples=e),s._samples=e,s.texture.samples=e),e}});var Ds=A(()=>{"use strict";de();P.prototype.setDepthStencilTexture=function(s,e,t,i){!t||!t.depthStencilTexture?this._setTexture(s,null,void 0,void 0,i):this._setTexture(s,t,!1,!0,i)}});var Ts=A(()=>{"use strict";de();Re();P.prototype.createRenderTargetCubeTexture=function(s,e){let t=this._createHardwareRenderTargetWrapper(!1,!0,s),i=z({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1},e);i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,t.label=i.label??"RenderTargetWrapper",t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer;let r=new K(this,5);return r.width=s,r.height=s,r.depth=0,r.isReady=!0,r.isCube=!0,r.samples=i.samples,r.generateMipMaps=i.generateMipMaps,r.samplingMode=i.samplingMode,r.type=i.type,r.format=i.format,this._internalTexturesCache.push(r),t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,i.samplingMode===void 0||i.samplingMode===2||i.samplingMode===2||i.samplingMode===3||i.samplingMode===3||i.samplingMode===5||i.samplingMode===6||i.samplingMode===7||i.samplingMode===11,t._generateStencilBuffer,t.samples),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1),t}});function vi(s,e,t){try{let i=s.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function fc(s=25){let e;return(t,i,r)=>{let n=performance.now();e===void 0||n-e>s?(e=n,setTimeout(()=>{vi(t,i,r)},0)):vi(t,i,r)}}function Bs(s,e,t,i,r){let n=()=>{let a,o=u=>{u.done?t(u.value):a===void 0?a=!0:n()};do a=void 0,!r||!r.aborted?e(s,o,i):i(new Error("Aborted")),a===void 0&&(a=!1);while(a)};n()}function Ci(s,e){let t;return Bs(s,vi,i=>t=i,i=>{throw i},e),t}async function ro(s,e,t){return await new Promise((i,r)=>{Bs(s,e,i,r,t)})}function Rs(s,e){return(...t)=>Ci(s(...t),e)}function pc(s,e,t){return(...i)=>ro(s(...i),e,t)}var Ps=A(()=>{"use strict"});var ut,Fs=A(()=>{"use strict";ut=class{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0,this._internalSubMeshId=0}}});var Qe,Ls=A(()=>{"use strict";jt();_e();Pi();Qe=class s{constructor(e,t,i){this.vectors=ge(8,x.Zero),this.center=x.Zero(),this.centerWorld=x.Zero(),this.extendSize=x.Zero(),this.extendSizeWorld=x.Zero(),this.directions=ge(3,x.Zero),this.vectorsWorld=ge(8,x.Zero),this.minimumWorld=x.Zero(),this.maximumWorld=x.Zero(),this.minimum=x.Zero(),this.maximum=x.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){let r=e.x,n=e.y,a=e.z,o=t.x,u=t.y,l=t.z,c=this.vectors;this.minimum.copyFromFloats(r,n,a),this.maximum.copyFromFloats(o,u,l),c[0].copyFromFloats(r,n,a),c[1].copyFromFloats(o,u,l),c[2].copyFromFloats(o,n,a),c[3].copyFromFloats(r,u,a),c[4].copyFromFloats(r,n,l),c[5].copyFromFloats(o,u,a),c[6].copyFromFloats(r,u,l),c[7].copyFromFloats(o,n,l),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||F.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){let t=s._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),r=i.length();i.normalizeFromLength(r);let n=r*e,a=i.scaleInPlace(n*.5),o=this.center.subtractToRef(a,t[1]),u=this.center.addToRef(a,t[2]);return this.reConstruct(o,u,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){let t=this.minimumWorld,i=this.maximumWorld,r=this.directions,n=this.vectorsWorld,a=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let o=0;o<8;++o)n[o].copyFrom(a[o]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let o=0;o<8;++o){let u=n[o];x.TransformCoordinatesToRef(a[o],e,u),t.minimizeInPlace(u),i.maximizeInPlace(u)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}x.FromArrayToRef(e.m,0,r[0]),x.FromArrayToRef(e.m,4,r[1]),x.FromArrayToRef(e.m,8,r[2]),this._worldMatrix=e}isInFrustum(e){return s.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return s.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){let t=this.minimumWorld,i=this.maximumWorld,r=t.x,n=t.y,a=t.z,o=i.x,u=i.y,l=i.z,c=e.x,h=e.y,f=e.z,d=-me;return!(o-c<d||d>c-r||u-h<d||d>h-n||l-f<d||d>f-a)}intersectsSphere(e){return s.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){let i=this.minimumWorld,r=this.maximumWorld,n=i.x,a=i.y,o=i.z,u=r.x,l=r.y,c=r.z,h=e.x,f=e.y,d=e.z,_=t.x,p=t.y,g=t.z;return!(u<h||n>_||l<f||a>p||c<d||o>g)}dispose(){this._drawWrapperFront?.dispose(),this._drawWrapperBack?.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,r){let n=s._TmpVector3[0];return x.ClampToRef(i,e,t,n),x.DistanceSquared(i,n)<=r*r}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){let r=t[i];for(let n=0;n<8;++n)if(r.dotCoordinate(e[n])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let r=!0,n=t[i];for(let a=0;a<8;++a)if(n.dotCoordinate(e[a])>=0){r=!1;break}if(r)return!1}return!0}};Qe._TmpVector3=ge(3,x.Zero)});var Ke,Es=A(()=>{"use strict";jt();_e();Ke=class s{constructor(e,t,i){this.center=x.Zero(),this.centerWorld=x.Zero(),this.minimum=x.Zero(),this.maximum=x.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);let r=x.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=r*.5,this._update(i||F.IdentityReadOnly)}scale(e){let t=this.radius*e,i=s._TmpVector3,r=i[0].setAll(t),n=this.center.subtractToRef(r,i[1]),a=this.center.addToRef(r,i[2]);return this.reConstruct(n,a,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{x.TransformCoordinatesToRef(this.center,e,this.centerWorld);let t=s._TmpVector3[0];x.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){let t=this.centerWorld,i=this.radiusWorld;for(let r=0;r<6;r++)if(e[r].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){let t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){let t=x.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){let i=x.DistanceSquared(e.centerWorld,t.centerWorld),r=e.radiusWorld+t.radiusWorld;return!(r*r<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);let r=new s(this._TmpVector3[0],this._TmpVector3[2]);return i?r._worldMatrix=i:r._worldMatrix=F.Identity(),r}};Ke._TmpVector3=ge(3,x.Zero)});var wi,Ai,Us,Z,oe,Di=A(()=>{"use strict";jt();_e();Ls();Es();wi={min:0,max:0},Ai={min:0,max:0},Us=(s,e,t)=>{let i=x.Dot(e.centerWorld,s),r=Math.abs(x.Dot(e.directions[0],s))*e.extendSize.x,n=Math.abs(x.Dot(e.directions[1],s))*e.extendSize.y,a=Math.abs(x.Dot(e.directions[2],s))*e.extendSize.z,o=r+n+a;t.min=i-o,t.max=i+o},Z=(s,e,t)=>(Us(s,e,wi),Us(s,t,Ai),!(wi.min>Ai.max||Ai.min>wi.max)),oe=class s{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new Qe(e,t,i),this.boundingSphere=new Ke(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){let i=s._TmpVector3[0].copyFrom(e).subtractInPlace(t),r=s._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this}encapsulate(e){let t=x.Minimize(this.minimum,e),i=x.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){let t=S.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);let i=S.Vector3[0];return x.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),x.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){let e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,s._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!Ke.Intersects(this.boundingSphere,e.boundingSphere)||!Qe.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;let i=this.boundingBox,r=e.boundingBox;return!(!Z(i.directions[0],i,r)||!Z(i.directions[1],i,r)||!Z(i.directions[2],i,r)||!Z(r.directions[0],i,r)||!Z(r.directions[1],i,r)||!Z(r.directions[2],i,r)||!Z(x.Cross(i.directions[0],r.directions[0]),i,r)||!Z(x.Cross(i.directions[0],r.directions[1]),i,r)||!Z(x.Cross(i.directions[0],r.directions[2]),i,r)||!Z(x.Cross(i.directions[1],r.directions[0]),i,r)||!Z(x.Cross(i.directions[1],r.directions[1]),i,r)||!Z(x.Cross(i.directions[1],r.directions[2]),i,r)||!Z(x.Cross(i.directions[2],r.directions[0]),i,r)||!Z(x.Cross(i.directions[2],r.directions[1]),i,r)||!Z(x.Cross(i.directions[2],r.directions[2]),i,r))}};oe._TmpVector3=ge(2,x.Zero)});var Yt,Os=A(()=>{"use strict";Pe();Fs();Di();sr();pn();Yt=class s{get materialDefines(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:this._getDrawWrapper()?.defines}set materialDefines(e){let t=this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0);t.defines=e}_getDrawWrapper(e,t=!1){e=e??this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new nr(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0,i=!1){t&&this._drawWrappers[e]?.dispose(i),this._drawWrappers[e]=void 0}get effect(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:this._getDrawWrapper()?.effect??null}get _drawWrapper(){return this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,r=!0){let n=this._drawWrapper;n.setEffect(e,t,r),i!==void 0&&(n.materialContext=i),e||(n.defines=null,n.materialContext=void 0)}resetDrawCache(e,t=!1){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e,!0,t);return}else for(let i of this._drawWrappers)i?.dispose(t);this._drawWrappers=[]}static AddToMesh(e,t,i,r,n,a,o,u=!0){return new s(e,t,i,r,n,a,o,u)}constructor(e,t,i,r,n,a,o,u=!0,l=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=r,this.indexCount=n,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=a,this._renderingMesh=o||a,l&&a.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=a.subMeshes.length-1,u&&(this.refreshBoundingInfo(),a.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){let e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){let t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId)??this._renderingMesh.material;if(t){if(this._isMultiMaterial(t)){let i=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==i&&(this._currentMaterial=i,this.resetDrawCache()),i}}else return e&&this._mesh.getScene()._hasDefaultMaterial?this._mesh.getScene().defaultMaterial:null;return t}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(m.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;let t=this._renderingMesh.getIndices(),i;if(this.indexStart===0&&this.indexCount===t.length){let r=this._renderingMesh.getBoundingInfo();i={minimum:r.minimum.clone(),maximum:r.maximum.clone()}}else i=ir(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new oe(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){let t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){let t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){let i=Math.floor(this.indexCount/3)*6,n=this.verticesStart+this.verticesCount>65535?new Uint32Array(i):new Uint16Array(i),a=0;if(e.length===0)for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=3)n[a++]=o,n[a++]=o+1,n[a++]=o+1,n[a++]=o+2,n[a++]=o+2,n[a++]=o;else for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=3)n[a++]=e[o],n[a++]=e[o+1],n[a++]=e[o+1],n[a++]=e[o+2],n[a++]=e[o+2],n[a++]=e[o];this._linesIndexBuffer=t.createIndexBuffer(n),this._linesIndexCount=n.length}return this._linesIndexBuffer}canIntersects(e){let t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,i,r,n){let a=this.getMaterial();if(!a)return null;let o=3,u=!1;switch(a.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,u=!0;break;default:break}return a.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,r):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,r):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,r,n):this._intersectTriangles(e,t,i,o,u,r,n)}_intersectLines(e,t,i,r,n){let a=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){let u=t[i[o]],l=t[i[o+1]],c=e.intersectionSegment(u,l,r);if(!(c<0)&&(n||!a||c<a.distance)&&(a=new ut(null,null,c),a.faceId=o/2,n))break}return a}_intersectUnIndexedLines(e,t,i,r,n){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=2){let u=t[o],l=t[o+1],c=e.intersectionSegment(u,l,r);if(!(c<0)&&(n||!a||c<a.distance)&&(a=new ut(null,null,c),a.faceId=o/2,n))break}return a}_intersectTriangles(e,t,i,r,n,a,o){let u=null,l=-1;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-r);c+=r){l++;let h=i[c],f=i[c+1],d=i[c+2];if(n&&d===4294967295){c+=2;continue}let _=t[h],p=t[f],g=t[d];if(!_||!p||!g||o&&!o(_,p,g,e,h,f,d))continue;let b=e.intersectsTriangle(_,p,g);if(b){if(b.distance<0)continue;if((a||!u||b.distance<u.distance)&&(u=b,u.faceId=l,a))break}}return u}_intersectUnIndexedTriangles(e,t,i,r,n){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){let u=t[o],l=t[o+1],c=t[o+2];if(n&&!n(u,l,c,e,-1,-1,-1))continue;let h=e.intersectsTriangle(u,l,c);if(h){if(h.distance<0)continue;if((r||!a||h.distance<a.distance)&&(a=h,a.faceId=o/3,r))break}}return a}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){let i=new s(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){let r=this.getBoundingInfo();if(!r)return i;i._boundingInfo=new oe(r.minimum,r.maximum)}return i}dispose(e=!1){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);let t=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(t,1),this.resetDrawCache(void 0,e)}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,r,n,a=!0){let o=Number.MAX_VALUE,u=-Number.MAX_VALUE,c=(n||r).getIndices();for(let h=t;h<t+i;h++){let f=c[h];f<o&&(o=f),f>u&&(u=f)}return new s(e,o,u-o+1,t,i,r,n,a)}}});var lt,J,Gs=A(()=>{"use strict";ei();_e();Pe();Vi();Gi();te();ti();Ps();rn();Os();lt=class{},J=class s{constructor(){this.uniqueId=0,this.metadata={},this._applyTo=Rs(this._applyToCoroutine.bind(this)),this.uniqueId=s._UniqueIdGenerator,s._UniqueIdGenerator++}set(e,t){switch(e.length||C.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case m.PositionKind:this.positions=e;break;case m.NormalKind:this.normals=e;break;case m.TangentKind:this.tangents=e;break;case m.UVKind:this.uvs=e;break;case m.UV2Kind:this.uvs2=e;break;case m.UV3Kind:this.uvs3=e;break;case m.UV4Kind:this.uvs4=e;break;case m.UV5Kind:this.uvs5=e;break;case m.UV6Kind:this.uvs6=e;break;case m.ColorKind:this.colors=e;break;case m.MatricesIndicesKind:this.matricesIndices=e;break;case m.MatricesWeightsKind:this.matricesWeights=e;break;case m.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case m.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){if(this.positions&&(e.setVerticesData(m.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(m.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(m.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(m.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(m.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(m.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(m.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(m.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(m.UV6Kind,this.uvs6,t),i&&(yield)),this.colors){let r=this.positions&&this.colors.length===this.positions.length?3:4;e.setVerticesData(m.ColorKind,this.colors,t,r),this.hasVertexAlpha&&e.hasVertexAlpha!==void 0&&(e.hasVertexAlpha=!0),i&&(yield)}if(this.matricesIndices&&(e.setVerticesData(m.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(m.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(m.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(m.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){let r=e;r.subMeshes=[];for(let n of this.materialInfos)new Yt(n.materialIndex,n.verticesStart,n.verticesCount,n.indexStart,n.indexCount,r)}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(m.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(m.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(m.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(m.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(m.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(m.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(m.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(m.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(m.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(m.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(m.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(m.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(m.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(m.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,r=e.length){let n=S.Vector3[0],a=S.Vector3[1];for(let o=i;o<i+r;o+=3)x.FromArrayToRef(e,o,n),x.TransformCoordinatesToRef(n,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector3Normals(e,t,i=0,r=e.length){let n=S.Vector3[0],a=S.Vector3[1];for(let o=i;o<i+r;o+=3)x.FromArrayToRef(e,o,n),x.TransformNormalToRef(n,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector4Normals(e,t,i=0,r=e.length){let n=S.Vector4[0],a=S.Vector4[1];for(let o=i;o<i+r;o+=4)Ye.FromArrayToRef(e,o,n),Ye.TransformNormalToRef(n,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z,e[o+3]=a.w}static _FlipFaces(e,t=0,i=e.length){for(let r=t;r<t+i;r+=3){let n=e[r+1];e[r+1]=e[r+2],e[r+2]=n}}transform(e){let t=e.determinant()<0;return this.positions&&s._TransformVector3Coordinates(this.positions,e),this.normals&&s._TransformVector3Normals(this.normals,e),this.tangents&&s._TransformVector4Normals(this.tangents,e),t&&this.indices&&s._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];let e=[];for(let t of this.materialInfos){let i=new s;if(this.positions&&(i.positions=this.positions.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.normals&&(i.normals=this.normals.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.tangents&&(i.tangents=this.tangents.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.colors&&(i.colors=this.colors.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.uvs&&(i.uvs=this.uvs.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs2&&(i.uvs2=this.uvs2.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs3&&(i.uvs3=this.uvs3.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs4&&(i.uvs4=this.uvs4.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs5&&(i.uvs5=this.uvs5.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs6&&(i.uvs6=this.uvs6.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.indices){i.indices=[];for(let n=t.indexStart;n<t.indexStart+t.indexCount;n++)i.indices.push(this.indices[n]-t.verticesStart)}let r=new lt;r.indexStart=0,r.indexCount=i.indices?i.indices.length:0,r.materialIndex=t.materialIndex,r.verticesStart=0,r.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[r],e.push(i)}return e}merge(e,t=!1,i=!1,r=!1,n=!1){let a=Array.isArray(e)?e.map(o=>({vertexData:o})):[{vertexData:e}];return Ci(this._mergeCoroutine(void 0,a,t,!1,i,r,n))}*_mergeCoroutine(e,t,i=!1,r,n,a=!1,o=!1){this._validate();let u=t.map(d=>d.vertexData),l=this;if(o)for(let d of u)d&&(d._validate(),!this.normals&&d.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&d.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&d.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&d.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&d.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&d.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&d.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&d.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&d.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&d.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&d.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&d.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&d.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(let d of u)if(d){if(o)this.normals&&!d.normals&&(d.normals=new Float32Array(d.positions.length)),this.tangents&&!d.tangents&&(d.tangents=new Float32Array(d.positions.length/3*4)),this.uvs&&!d.uvs&&(d.uvs=new Float32Array(d.positions.length/3*2)),this.uvs2&&!d.uvs2&&(d.uvs2=new Float32Array(d.positions.length/3*2)),this.uvs3&&!d.uvs3&&(d.uvs3=new Float32Array(d.positions.length/3*2)),this.uvs4&&!d.uvs4&&(d.uvs4=new Float32Array(d.positions.length/3*2)),this.uvs5&&!d.uvs5&&(d.uvs5=new Float32Array(d.positions.length/3*2)),this.uvs6&&!d.uvs6&&(d.uvs6=new Float32Array(d.positions.length/3*2)),this.colors&&!d.colors&&(d.colors=new Float32Array(d.positions.length/3*4),d.colors.fill(1)),this.matricesIndices&&!d.matricesIndices&&(d.matricesIndices=new Float32Array(d.positions.length/3*4)),this.matricesWeights&&!d.matricesWeights&&(d.matricesWeights=new Float32Array(d.positions.length/3*4)),this.matricesIndicesExtra&&!d.matricesIndicesExtra&&(d.matricesIndicesExtra=new Float32Array(d.positions.length/3*4)),this.matricesWeightsExtra&&!d.matricesWeightsExtra&&(d.matricesWeightsExtra=new Float32Array(d.positions.length/3*4));else if(d._validate(),!this.normals!=!d.normals||!this.tangents!=!d.tangents||!this.uvs!=!d.uvs||!this.uvs2!=!d.uvs2||!this.uvs3!=!d.uvs3||!this.uvs4!=!d.uvs4||!this.uvs5!=!d.uvs5||!this.uvs6!=!d.uvs6||!this.colors!=!d.colors||!this.matricesIndices!=!d.matricesIndices||!this.matricesWeights!=!d.matricesWeights||!this.matricesIndicesExtra!=!d.matricesIndicesExtra||!this.matricesWeightsExtra!=!d.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes")}if(a){let d=0,_=0,p=0,g=[],b=null,y=[];for(let w of this.splitBasedOnMaterialID())y.push({vertexData:w,transform:e});for(let w of t)if(w.vertexData)for(let I of w.vertexData.splitBasedOnMaterialID())y.push({vertexData:I,transform:w.transform});y.sort((w,I)=>{let v=w.vertexData.materialInfos?w.vertexData.materialInfos[0].materialIndex:0,D=I.vertexData.materialInfos?I.vertexData.materialInfos[0].materialIndex:0;return v>D?1:v===D?0:-1});for(let w of y){let I=w.vertexData;if(I.materialInfos?d=I.materialInfos[0].materialIndex:d=0,b&&b.materialIndex===d)b.indexCount+=I.indices.length,b.verticesCount+=I.positions.length/3;else{let v=new lt;v.materialIndex=d,v.indexStart=_,v.indexCount=I.indices.length,v.verticesStart=p,v.verticesCount=I.positions.length/3,g.push(v),b=v}_+=I.indices.length,p+=I.positions.length/3}let M=y.splice(0,1)[0];l=M.vertexData,e=M.transform,u=y.map(w=>w.vertexData),t=y,this.materialInfos=g}let c=u.reduce((d,_)=>d+(_.indices?.length??0),l.indices?.length??0),f=n||u.some(d=>d.indices===l.indices)?l.indices?.slice():l.indices;if(c>0){let d=f?.length??0;if(f||(f=new Array(c)),f.length!==c){if(Array.isArray(f))f.length=c;else{let p=i||f instanceof Uint32Array?new Uint32Array(c):new Uint16Array(c);p.set(f),f=p}e&&e.determinant()<0&&s._FlipFaces(f,0,d)}let _=l.positions?l.positions.length/3:0;for(let{vertexData:p,transform:g}of t)if(p.indices){for(let b=0;b<p.indices.length;b++)f[d+b]=p.indices[b]+_;g&&g.determinant()<0&&s._FlipFaces(f,d,p.indices.length),_+=p.positions.length/3,d+=p.indices.length,r&&(yield)}}return this.indices=f,this.positions=s._MergeElement(m.PositionKind,l.positions,e,t.map(d=>[d.vertexData.positions,d.transform])),r&&(yield),l.normals&&(this.normals=s._MergeElement(m.NormalKind,l.normals,e,t.map(d=>[d.vertexData.normals,d.transform])),r&&(yield)),l.tangents&&(this.tangents=s._MergeElement(m.TangentKind,l.tangents,e,t.map(d=>[d.vertexData.tangents,d.transform])),r&&(yield)),l.uvs&&(this.uvs=s._MergeElement(m.UVKind,l.uvs,e,t.map(d=>[d.vertexData.uvs,d.transform])),r&&(yield)),l.uvs2&&(this.uvs2=s._MergeElement(m.UV2Kind,l.uvs2,e,t.map(d=>[d.vertexData.uvs2,d.transform])),r&&(yield)),l.uvs3&&(this.uvs3=s._MergeElement(m.UV3Kind,l.uvs3,e,t.map(d=>[d.vertexData.uvs3,d.transform])),r&&(yield)),l.uvs4&&(this.uvs4=s._MergeElement(m.UV4Kind,l.uvs4,e,t.map(d=>[d.vertexData.uvs4,d.transform])),r&&(yield)),l.uvs5&&(this.uvs5=s._MergeElement(m.UV5Kind,l.uvs5,e,t.map(d=>[d.vertexData.uvs5,d.transform])),r&&(yield)),l.uvs6&&(this.uvs6=s._MergeElement(m.UV6Kind,l.uvs6,e,t.map(d=>[d.vertexData.uvs6,d.transform])),r&&(yield)),l.colors&&(this.colors=s._MergeElement(m.ColorKind,l.colors,e,t.map(d=>[d.vertexData.colors,d.transform])),(l.hasVertexAlpha!==void 0||t.some(d=>d.vertexData.hasVertexAlpha!==void 0))&&(this.hasVertexAlpha=l.hasVertexAlpha||t.some(d=>d.vertexData.hasVertexAlpha)),r&&(yield)),l.matricesIndices&&(this.matricesIndices=s._MergeElement(m.MatricesIndicesKind,l.matricesIndices,e,t.map(d=>[d.vertexData.matricesIndices,d.transform])),r&&(yield)),l.matricesWeights&&(this.matricesWeights=s._MergeElement(m.MatricesWeightsKind,l.matricesWeights,e,t.map(d=>[d.vertexData.matricesWeights,d.transform])),r&&(yield)),l.matricesIndicesExtra&&(this.matricesIndicesExtra=s._MergeElement(m.MatricesIndicesExtraKind,l.matricesIndicesExtra,e,t.map(d=>[d.vertexData.matricesIndicesExtra,d.transform])),r&&(yield)),l.matricesWeightsExtra&&(this.matricesWeightsExtra=s._MergeElement(m.MatricesWeightsExtraKind,l.matricesWeightsExtra,e,t.map(d=>[d.vertexData.matricesWeightsExtra,d.transform]))),this}static _MergeElement(e,t,i,r){let n=r.filter(u=>u[0]!==null&&u[0]!==void 0);if(!t&&n.length==0)return t;if(!t)return this._MergeElement(e,n[0][0],n[0][1],n.slice(1));let a=n.reduce((u,l)=>u+l[0].length,t.length),o=e===m.PositionKind?s._TransformVector3Coordinates:e===m.NormalKind?s._TransformVector3Normals:e===m.TangentKind?s._TransformVector4Normals:()=>{};if(t instanceof Float32Array){let u=new Float32Array(a);u.set(t),i&&o(u,i,0,t.length);let l=t.length;for(let[c,h]of n)u.set(c,l),h&&o(u,h,l,c.length),l+=c.length;return u}else{let u=new Array(a);for(let c=0;c<t.length;c++)u[c]=t[c];i&&o(u,i,0,t.length);let l=t.length;for(let[c,h]of n){for(let f=0;f<c.length;f++)u[l+f]=c[f];h&&o(u,h,l,c.length),l+=c.length}return u}}_validate(){if(!this.positions)throw new ki("Positions are required",Ni.MeshInvalidPositionsError);let e=(r,n)=>{let a=m.DeduceStride(r);if(n.length%a!==0)throw new Error("The "+r+"s array count must be a multiple of "+a);return n.length/a},t=e(m.PositionKind,this.positions),i=(r,n)=>{let a=e(r,n);if(a!==t)throw new Error("The "+r+"s element count ("+a+") does not match the positions count ("+t+")")};this.normals&&i(m.NormalKind,this.normals),this.tangents&&i(m.TangentKind,this.tangents),this.uvs&&i(m.UVKind,this.uvs),this.uvs2&&i(m.UV2Kind,this.uvs2),this.uvs3&&i(m.UV3Kind,this.uvs3),this.uvs4&&i(m.UV4Kind,this.uvs4),this.uvs5&&i(m.UV5Kind,this.uvs5),this.uvs6&&i(m.UV6Kind,this.uvs6),this.colors&&i(m.ColorKind,this.colors),this.matricesIndices&&i(m.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(m.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(m.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(m.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){let e=this.serialize();return s.Parse(e)}serialize(){let e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors),e.hasVertexAlpha=this.hasVertexAlpha),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndicesExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtraExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=this.indices?Array.from(this.indices):[],this.materialInfos){e.materialInfos=[];for(let t of this.materialInfos){let i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i)}}return e}static ExtractFromMesh(e,t,i){return s._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return s._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){let r=new s;if(e.isVerticesDataPresent(m.PositionKind)&&(r.positions=e.getVerticesData(m.PositionKind,t,i)),e.isVerticesDataPresent(m.NormalKind)&&(r.normals=e.getVerticesData(m.NormalKind,t,i)),e.isVerticesDataPresent(m.TangentKind)&&(r.tangents=e.getVerticesData(m.TangentKind,t,i)),e.isVerticesDataPresent(m.UVKind)&&(r.uvs=e.getVerticesData(m.UVKind,t,i)),e.isVerticesDataPresent(m.UV2Kind)&&(r.uvs2=e.getVerticesData(m.UV2Kind,t,i)),e.isVerticesDataPresent(m.UV3Kind)&&(r.uvs3=e.getVerticesData(m.UV3Kind,t,i)),e.isVerticesDataPresent(m.UV4Kind)&&(r.uvs4=e.getVerticesData(m.UV4Kind,t,i)),e.isVerticesDataPresent(m.UV5Kind)&&(r.uvs5=e.getVerticesData(m.UV5Kind,t,i)),e.isVerticesDataPresent(m.UV6Kind)&&(r.uvs6=e.getVerticesData(m.UV6Kind,t,i)),e.isVerticesDataPresent(m.ColorKind)){let n=e.geometry||e,a=n.getVertexBuffer(m.ColorKind),o=n.getVerticesData(m.ColorKind,t,i);if(a.getSize()===3){let u=new Float32Array(o.length*4/3);for(let l=0,c=0;l<o.length;l+=3,c+=4)u[c]=o[l],u[c+1]=o[l+1],u[c+2]=o[l+2],u[c+3]=1;r.colors=u}else if(a.getSize()===4)r.colors=o;else throw new Error(`Unexpected number of color components: ${a.getSize()}`)}return e.isVerticesDataPresent(m.MatricesIndicesKind)&&(r.matricesIndices=e.getVerticesData(m.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(m.MatricesWeightsKind)&&(r.matricesWeights=e.getVerticesData(m.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(m.MatricesIndicesExtraKind)&&(r.matricesIndicesExtra=e.getVerticesData(m.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(m.MatricesWeightsExtraKind)&&(r.matricesWeightsExtra=e.getVerticesData(m.MatricesWeightsExtraKind,t,i)),r.indices=e.getIndices(t,i),r}static CreateRibbon(e){throw N("ribbonBuilder")}static CreateBox(e){throw N("boxBuilder")}static CreateTiledBox(e){throw N("tiledBoxBuilder")}static CreateTiledPlane(e){throw N("tiledPlaneBuilder")}static CreateSphere(e){throw N("sphereBuilder")}static CreateCylinder(e){throw N("cylinderBuilder")}static CreateTorus(e){throw N("torusBuilder")}static CreateLineSystem(e){throw N("linesBuilder")}static CreateDashedLines(e){throw N("linesBuilder")}static CreateGround(e){throw N("groundBuilder")}static CreateTiledGround(e){throw N("groundBuilder")}static CreateGroundFromHeightMap(e){throw N("groundBuilder")}static CreatePlane(e){throw N("planeBuilder")}static CreateDisc(e){throw N("discBuilder")}static CreatePolygon(e,t,i,r,n,a,o){throw N("polygonBuilder")}static CreateIcoSphere(e){throw N("icoSphereBuilder")}static CreatePolyhedron(e){throw N("polyhedronBuilder")}static CreateCapsule(e={orientation:x.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw N("capsuleBuilder")}static CreateTorusKnot(e){throw N("torusKnotBuilder")}static ComputeNormals(e,t,i,r){let n=0,a=0,o=0,u=0,l=0,c=0,h=0,f=0,d=0,_=0,p=0,g=0,b=0,y=0,M=0,w=0,I=0,v=0,D=0,T=0,W=!1,E=!1,Q=!1,ue=!1,le=1,k=0,ce=null;r&&(W=!!r.facetNormals,E=!!r.facetPositions,Q=!!r.facetPartitioning,le=r.useRightHandedSystem===!0?-1:1,k=r.ratio||0,ue=!!r.depthSort,ce=r.distanceTo,ue&&ce===void 0&&(ce=x.Zero()));let X=0,xe=0,$=0,pe=0;for(Q&&r&&r.bbSize&&(X=r.subDiv.X*k/r.bbSize.x,xe=r.subDiv.Y*k/r.bbSize.y,$=r.subDiv.Z*k/r.bbSize.z,pe=r.subDiv.max*r.subDiv.max,r.facetPartitioning.length=0),n=0;n<e.length;n++)i[n]=0;let Ce=t.length/3|0;for(n=0;n<Ce;n++){if(g=t[n*3]*3,b=g+1,y=g+2,M=t[n*3+1]*3,w=M+1,I=M+2,v=t[n*3+2]*3,D=v+1,T=v+2,a=e[g]-e[M],o=e[b]-e[w],u=e[y]-e[I],l=e[v]-e[M],c=e[D]-e[w],h=e[T]-e[I],f=le*(o*h-u*c),d=le*(u*l-a*h),_=le*(a*c-o*l),p=Math.sqrt(f*f+d*d+_*_),p=p===0?1:p,f/=p,d/=p,_/=p,W&&r&&(r.facetNormals[n].x=f,r.facetNormals[n].y=d,r.facetNormals[n].z=_),E&&r&&(r.facetPositions[n].x=(e[g]+e[M]+e[v])/3,r.facetPositions[n].y=(e[b]+e[w]+e[D])/3,r.facetPositions[n].z=(e[y]+e[I]+e[T])/3),Q&&r){let Oe=Math.floor((r.facetPositions[n].x-r.bInfo.minimum.x*k)*X),Zt=Math.floor((r.facetPositions[n].y-r.bInfo.minimum.y*k)*xe),ct=Math.floor((r.facetPositions[n].z-r.bInfo.minimum.z*k)*$),ht=Math.floor((e[g]-r.bInfo.minimum.x*k)*X),Xt=Math.floor((e[b]-r.bInfo.minimum.y*k)*xe),U=Math.floor((e[y]-r.bInfo.minimum.z*k)*$),qs=Math.floor((e[M]-r.bInfo.minimum.x*k)*X),Ys=Math.floor((e[w]-r.bInfo.minimum.y*k)*xe),Hs=Math.floor((e[I]-r.bInfo.minimum.z*k)*$),Zs=Math.floor((e[v]-r.bInfo.minimum.x*k)*X),Xs=Math.floor((e[D]-r.bInfo.minimum.y*k)*xe),js=Math.floor((e[T]-r.bInfo.minimum.z*k)*$),we=ht+r.subDiv.max*Xt+pe*U,Ae=qs+r.subDiv.max*Ys+pe*Hs,De=Zs+r.subDiv.max*Xs+pe*js,Te=Oe+r.subDiv.max*Zt+pe*ct;r.facetPartitioning[Te]=r.facetPartitioning[Te]?r.facetPartitioning[Te]:[],r.facetPartitioning[we]=r.facetPartitioning[we]?r.facetPartitioning[we]:[],r.facetPartitioning[Ae]=r.facetPartitioning[Ae]?r.facetPartitioning[Ae]:[],r.facetPartitioning[De]=r.facetPartitioning[De]?r.facetPartitioning[De]:[],r.facetPartitioning[we].push(n),Ae!=we&&r.facetPartitioning[Ae].push(n),De==Ae||De==we||r.facetPartitioning[De].push(n),Te==we||Te==Ae||Te==De||r.facetPartitioning[Te].push(n)}if(ue&&r&&r.facetPositions){let Oe=r.depthSortedFacets[n];Oe.ind=n*3,Oe.sqDistance=x.DistanceSquared(r.facetPositions[n],ce)}i[g]+=f,i[b]+=d,i[y]+=_,i[M]+=f,i[w]+=d,i[I]+=_,i[v]+=f,i[D]+=d,i[T]+=_}for(n=0;n<i.length/3;n++)f=i[n*3],d=i[n*3+1],_=i[n*3+2],p=Math.sqrt(f*f+d*d+_*_),p=p===0?1:p,f/=p,d/=p,_/=p,i[n*3]=f,i[n*3+1]=d,i[n*3+2]=_}static _ComputeSides(e,t,i,r,n,a,o){let u=i.length,l=r.length,c,h;switch(e=e||s.DEFAULTSIDE,e){case s.FRONTSIDE:break;case s.BACKSIDE:for(c=0;c<u;c+=3){let f=i[c];i[c]=i[c+2],i[c+2]=f}for(h=0;h<l;h++)r[h]=-r[h];break;case s.DOUBLESIDE:{let f=t.length,d=f/3;for(let g=0;g<f;g++)t[f+g]=t[g];for(c=0;c<u;c+=3)i[c+u]=i[c+2]+d,i[c+1+u]=i[c+1]+d,i[c+2+u]=i[c]+d;for(h=0;h<l;h++)r[l+h]=-r[h];let _=n.length,p=0;for(p=0;p<_;p++)n[p+_]=n[p];for(a=a||new Ye(0,0,1,1),o=o||new Ye(0,0,1,1),p=0,c=0;c<_/2;c++)n[p]=a.x+(a.z-a.x)*n[p],n[p+1]=a.y+(a.w-a.y)*n[p+1],n[p+_]=o.x+(o.z-o.x)*n[p+_],n[p+_+1]=o.y+(o.w-o.y)*n[p+_+1],p+=2;break}}}static Parse(e){let t=new s,i=e.positions;i&&t.set(i,m.PositionKind);let r=e.normals;r&&t.set(r,m.NormalKind);let n=e.tangents;n&&t.set(n,m.TangentKind);let a=e.uvs;a&&t.set(a,m.UVKind);let o=e.uvs2;o&&t.set(o,m.UV2Kind);let u=e.uvs3;u&&t.set(u,m.UV3Kind);let l=e.uvs4;l&&t.set(l,m.UV4Kind);let c=e.uvs5;c&&t.set(c,m.UV5Kind);let h=e.uvs6;h&&t.set(h,m.UV6Kind);let f=e.colors;f&&(t.set(ye.CheckColors4(f,i.length/3),m.ColorKind),e.hasVertexAlpha!==void 0&&(t.hasVertexAlpha=e.hasVertexAlpha));let d=e.matricesIndices;d&&t.set(d,m.MatricesIndicesKind);let _=e.matricesWeights;_&&t.set(_,m.MatricesWeightsKind);let p=e.indices;p&&(t.indices=p);let g=e.materialInfos;if(g){t.materialInfos=[];for(let b of g){let y=new lt;y.indexCount=b.indexCount,y.indexStart=b.indexStart,y.verticesCount=b.verticesCount,y.verticesStart=b.verticesStart,y.materialIndex=b.materialIndex,t.materialInfos.push(y)}}return t}static ImportVertexData(e,t){let i=s.Parse(e);t.setAllVerticesData(i,e.updatable)}};J.FRONTSIDE=0;J.BACKSIDE=1;J.DOUBLESIDE=2;J.DEFAULTSIDE=0;J._UniqueIdGenerator=0;Y([Be.filter((...[s])=>!Array.isArray(s))],J,"_TransformVector3Coordinates",null);Y([Be.filter((...[s])=>!Array.isArray(s))],J,"_TransformVector3Normals",null);Y([Be.filter((...[s])=>!Array.isArray(s))],J,"_TransformVector4Normals",null);Y([Be.filter((...[s])=>!Array.isArray(s))],J,"_FlipFaces",null)});var L,Ws=A(()=>{"use strict";ei();ti();en();dt();_e();tn();Ei();L=class s extends ii{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&s.BILLBOARDMODE_USE_POSITION)!==0)}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t,!1),this._forward=new x(0,0,1),this._up=new x(0,1,0),this._right=new x(1,0,0),this._position=x.Zero(),this._rotation=x.Zero(),this._rotationQuaternion=null,this._scaling=x.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=s.BILLBOARDMODE_NONE,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=F.Zero(),this._usePivotMatrix=!1,this._absolutePosition=x.Zero(),this._absoluteScaling=x.Zero(),this._absoluteRotationQuaternion=O.Identity(),this._pivotMatrix=F.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new j,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._markAsDirtyInternal()}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._markAsDirtyInternal()}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._markAsDirtyInternal()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._markAsDirtyInternal()}_markAsDirtyInternal(){this._isDirty||(this._isDirty=!0,this.customMarkAsDirty&&this.customMarkAsDirty())}get forward(){return x.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return x.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return x.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=F.Identity()),this._poseMatrix}_isSynchronized(){let e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==s.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();let e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=F.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){let r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);r&&i&&i(this,r);for(let n of this.getChildTransformNodes(!0))n.instantiateHierarchy(r,t,i);return r}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||O.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,r;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],r=arguments[2]}else t=e.x,i=e.y,r=e.z;if(this.parent){let n=S.Matrix[0];this.parent.getWorldMatrix().invertToRef(n),x.TransformCoordinatesFromFloatsToRef(t,i,r,n,this.position)}else this.position.x=t,this.position.y=i,this.position.z=r;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=x.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();let e=S.Matrix[0];return this._localMatrix.invertToRef(e),x.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=x.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,r=0,n=0){let a=s._LookAtVectorCache,o=n===0?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,a),this.setDirection(a,t,i,r),n===1&&this.parent)if(this.rotationQuaternion){let u=S.Matrix[0];this.rotationQuaternion.toRotationMatrix(u);let l=S.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(l),l.invert(),u.multiplyToRef(l,u),this.rotationQuaternion.fromRotationMatrix(u)}else{let u=S.Quaternion[0];O.FromEulerVectorToRef(this.rotation,u);let l=S.Matrix[0];u.toRotationMatrix(l);let c=S.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),l.multiplyToRef(c,l),u.fromRotationMatrix(l),u.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){let t=x.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return x.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,r=0){let n=-Math.atan2(e.z,e.x)+Math.PI/2,a=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,a);return this.rotationQuaternion?O.RotationYawPitchRollToRef(n+t,o+i,r,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=n+t,this.rotation.z=r),this}setPivotPoint(e,t=0){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);let i=this.getWorldMatrix();if(t==1){let r=S.Matrix[0];i.invertToRef(r),e=x.TransformCoordinates(e,r)}return this.setPivotMatrix(F.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){let e=x.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){let e=x.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),x.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(let t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;let r=S.Quaternion[0],n=S.Vector3[0],a=S.Vector3[1],o=S.Matrix[1];F.IdentityToRef(o);let u=S.Matrix[0];this.computeWorldMatrix(!0);let l=this.rotationQuaternion;return l||(l=s._TmpRotation,O.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),F.ComposeToRef(this.scaling,l,this.position,u),this.parent&&u.multiplyToRef(this.parent.computeWorldMatrix(!0),u),e&&(e.computeWorldMatrix(!0).invertToRef(o),u.multiplyToRef(o,u)),u.decompose(a,r,n,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(a),this.position.copyFrom(n),this.parent=e,i&&this.setPivotMatrix(F.Identity()),this}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.parent!==this?this:(e.setParent(null,t),this)}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let r;if(!i||i===0)r=O.RotationAxisToRef(e,t,s._RotationAxisCache),this.rotationQuaternion.multiplyToRef(r,this.rotationQuaternion);else{if(this.parent){let n=this.parent.getWorldMatrix(),a=S.Matrix[0];n.invertToRef(a),e=x.TransformNormal(e,a),n.determinant()<0&&(t*=-1)}r=O.RotationAxisToRef(e,t,s._RotationAxisCache),r.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=O.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));let r=S.Vector3[0],n=S.Vector3[1],a=S.Vector3[2],o=S.Quaternion[0],u=S.Matrix[0],l=S.Matrix[1],c=S.Matrix[2],h=S.Matrix[3];return e.subtractToRef(this.position,r),F.TranslationToRef(r.x,r.y,r.z,u),F.TranslationToRef(-r.x,-r.y,-r.z,l),F.RotationAxisToRef(t,i,c),l.multiplyToRef(c,h),h.multiplyToRef(u,h),h.decompose(n,o,a),this.position.addInPlace(a),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){let r=e.scale(t);if(!i||i===0){let n=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(n)}else this.setAbsolutePosition(this.getAbsolutePosition().add(r));return this}addRotation(e,t,i){let r;this.rotationQuaternion?r=this.rotationQuaternion:(r=S.Quaternion[1],O.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,r));let n=S.Quaternion[0];return O.RotationYawPitchRollToRef(t,e,i,n),r.multiplyInPlace(n),this.rotationQuaternion||r.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==s.BILLBOARDMODE_NONE}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;let i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();let r=this._cache;r.pivotMatrixUpdated=!1,r.billboardMode=this.billboardMode,r.infiniteDistance=this.infiniteDistance,r.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;let n=this._getEffectiveParent(),a=s._TmpScaling,o=this._position;if(this._infiniteDistance&&!this.parent&&t){let l=t.getWorldMatrix(),c=new x(l.m[12],l.m[13],l.m[14]);o=s._TmpTranslation,o.copyFromFloats(this._position.x+c.x,this._position.y+c.y,this._position.z+c.z)}a.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let u;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,u=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(O.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(u=s._TmpRotation,O.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,u)),this._usePivotMatrix){let l=S.Matrix[1];F.ScalingToRef(a.x,a.y,a.z,l);let c=S.Matrix[0];u.toRotationMatrix(c),this._pivotMatrix.multiplyToRef(l,S.Matrix[4]),S.Matrix[4].multiplyToRef(c,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(o.x,o.y,o.z)}else F.ComposeToRef(a,u,o,this._localMatrix);if(n&&n.getWorldMatrix){if(e&&n.computeWorldMatrix(e),this.billboardMode){if(this._transformToBoneReferal){let f=this.parent;f.getSkeleton().prepare(),f.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),S.Matrix[7])}else S.Matrix[7].copyFrom(n.getWorldMatrix());let l=S.Vector3[5],c=S.Vector3[6],h=S.Quaternion[0];S.Matrix[7].decompose(c,h,l),F.ScalingToRef(c.x,c.y,c.z,S.Matrix[7]),S.Matrix[7].setTranslation(l),s.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(h,l),this._localMatrix.setTranslation(l)),this._localMatrix.multiplyToRef(S.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){let l=this.parent;l.getSkeleton().prepare(),this._localMatrix.multiplyToRef(l.getFinalMatrix(),S.Matrix[6]),S.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(n.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(t&&this.billboardMode)if(r.useBillboardPosition){let l=S.Vector3[0];this._worldMatrix.getTranslationToRef(l);let c=t.globalPosition;this._worldMatrix.invertToRef(S.Matrix[1]);let h=S.Vector3[1];x.TransformCoordinatesToRef(c,S.Matrix[1],h),h.normalize();let f=-Math.atan2(h.z,h.x)+Math.PI/2,d=Math.sqrt(h.x*h.x+h.z*h.z),_=-Math.atan2(h.y,d);if(O.RotationYawPitchRollToRef(f,_,0,S.Quaternion[0]),(this.billboardMode&s.BILLBOARDMODE_ALL)!==s.BILLBOARDMODE_ALL){let p=S.Vector3[1];S.Quaternion[0].toEulerAnglesToRef(p),(this.billboardMode&s.BILLBOARDMODE_X)!==s.BILLBOARDMODE_X&&(p.x=0),(this.billboardMode&s.BILLBOARDMODE_Y)!==s.BILLBOARDMODE_Y&&(p.y=0),(this.billboardMode&s.BILLBOARDMODE_Z)!==s.BILLBOARDMODE_Z&&(p.z=0),F.RotationYawPitchRollToRef(p.y,p.x,p.z,S.Matrix[0])}else F.FromQuaternionToRef(S.Quaternion[0],S.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(S.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(S.Vector3[0])}else{let l=S.Vector3[0];this._worldMatrix.getTranslationToRef(l),S.Matrix[1].copyFrom(t.getViewMatrix());let c=this.getScene().useRightHandedSystem;if(c&&S.Matrix[1].multiplyToRef(s._TmpRHRestore,S.Matrix[1]),S.Matrix[1].setTranslationFromFloats(0,0,0),S.Matrix[1].invertToRef(S.Matrix[0]),(this.billboardMode&s.BILLBOARDMODE_ALL)!==s.BILLBOARDMODE_ALL){S.Matrix[0].decompose(void 0,S.Quaternion[0],void 0);let h=S.Vector3[1];S.Quaternion[0].toEulerAnglesToRef(h),(this.billboardMode&s.BILLBOARDMODE_X)!==s.BILLBOARDMODE_X&&(h.x=0),(this.billboardMode&s.BILLBOARDMODE_Y)!==s.BILLBOARDMODE_Y&&(h.y=0),(this.billboardMode&s.BILLBOARDMODE_Z)!==s.BILLBOARDMODE_Z&&(h.z=0),c&&(h.y+=Math.PI),F.RotationYawPitchRollToRef(h.y,h.x,h.z,S.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(S.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(S.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):n&&n._nonUniformScaling?this._updateNonUniformScalingState(n._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=F.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){let t=this.getChildren();for(let i=0;i<t.length;++i){let r=t[i];if(r){r.computeWorldMatrix();let n=S.Matrix[0];r._localMatrix.multiplyToRef(this._localMatrix,n);let a=S.Quaternion[0];n.decompose(r.scaling,a,r.position),r.rotationQuaternion?r.rotationQuaternion.copyFrom(a):a.toEulerAnglesToRef(r.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=O.Identity()),this._worldMatrix=F.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),x.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){let r=He.Clone(()=>new s(e,this.getScene()),this);if(r.name=e,r.id=e,t&&(r.parent=t),!i){let n=this.getDescendants(!0);for(let a=0;a<n.length;a++){let o=n[a];o.clone&&o.clone(e+"."+o.name,r)}}return r}serialize(e){let t=He.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),He.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t}static Parse(e,t,i){let r=He.Parse(()=>new s(e.name,t),e,t,i);if(e.localMatrix?r.setPreTransformMatrix(F.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(F.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.animations){for(let n=0;n<e.animations.length;n++){let a=e.animations[n],o=Li("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}ii.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),r}getChildTransformNodes(e,t){let i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r instanceof s),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){let i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){let i=this.getChildTransformNodes(!0);for(let r of i)r.parent=null,r.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let r=null,n=null;t&&(this.rotationQuaternion?(n=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(r=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));let a=this.getHierarchyBoundingVectors(e,i),o=a.max.subtract(a.min),u=Math.max(o.x,o.y,o.z);if(u===0)return this;let l=1/u;return this.scaling.scaleInPlace(l),t&&(this.rotationQuaternion&&n?this.rotationQuaternion.copyFrom(n):this.rotation&&r&&this.rotation.copyFrom(r)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}};L.BILLBOARDMODE_NONE=0;L.BILLBOARDMODE_X=1;L.BILLBOARDMODE_Y=2;L.BILLBOARDMODE_Z=4;L.BILLBOARDMODE_ALL=7;L.BILLBOARDMODE_USE_POSITION=128;L.BillboardUseParentOrientation=!1;L._TmpRotation=O.Zero();L._TmpScaling=x.Zero();L._TmpTranslation=x.Zero();L._TmpRHRestore=F.Scaling(1,1,-1);L._LookAtVectorCache=new x(0,0,0);L._RotationAxisCache=new O;Y([pt("position")],L.prototype,"_position",void 0);Y([pt("rotation")],L.prototype,"_rotation",void 0);Y([Wi("rotationQuaternion")],L.prototype,"_rotationQuaternion",void 0);Y([pt("scaling")],L.prototype,"_scaling",void 0);Y([Ge("billboardMode")],L.prototype,"_billboardMode",void 0);Y([Ge()],L.prototype,"scalingDeterminant",void 0);Y([Ge("infiniteDistance")],L.prototype,"_infiniteDistance",void 0);Y([Ge()],L.prototype,"ignoreNonUniformScaling",void 0);Y([Ge()],L.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0)});var Ht,Vs=A(()=>{"use strict";_e();Ht=class{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new x(0,0,0),this._diffPositionForCollisions=new x(0,0,0),this._collisionResponse=!0}}});function so(s,e,t){let i=null;switch(e){case m.PositionKind:i=r=>r.getPositions();break;case m.NormalKind:i=r=>r.getNormals();break;case m.TangentKind:i=r=>r.getTangents();break;case m.UVKind:i=r=>r.getUVs();break;case m.UV2Kind:i=r=>r.getUV2s();break;case m.ColorKind:i=r=>r.getColors();break;default:return}for(let r=0;r<s.length;r++){let n=s[r];for(let a=0;a<t.numTargets;a++){let o=t.getTarget(a),u=o.influence;if(u!==0){let l=i(o);l&&(n+=(l[r]-s[r])*u)}}s[r]=n}}function no(s,e,t,i,r,n,a){let o=S.Vector3[0],u=S.Matrix[0],l=S.Matrix[1],c=e===m.NormalKind?x.TransformNormalFromFloatsToRef:x.TransformCoordinatesFromFloatsToRef;for(let h=0,f=0;h<s.length;h+=3,f+=4){u.reset();let d,_;for(d=0;d<4;d++)_=r[f+d],_>0&&(F.FromFloat32ArrayToRefScaled(t,Math.floor(i[f+d]*16),_,l),u.addToSelf(l));if(n&&a)for(d=0;d<4;d++)_=a[f+d],_>0&&(F.FromFloat32ArrayToRefScaled(t,Math.floor(n[f+d]*16),_,l),u.addToSelf(l));c(s[h],s[h+1],s[h+2],u,o),o.toArray(s,h)}}var Ti,Bi,G,Ns=A(()=>{"use strict";ei();dt();_e();Pe();Gs();Ws();fn();Di();ni();Vs();Vi();sr();Gi();Pi();mn();Ei();ti();Ve();Ti=class{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=x.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}},Bi=class{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new Ti,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=new Map,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new Ht,this._enableDistantPicking=!1,this._rawBoundingInfo=null,this._sideOrientationHint=!1,this._wasActiveLastFrame=!1}},G=class s extends L{static get BILLBOARDMODE_NONE(){return L.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return L.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return L.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return L.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return L.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return L.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;let t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(t===1&&e!==1||t!==1&&e===1)&&this._markSubMeshesAsDirty(i=>{i.markAsMiscDirty(),i.markAsPrePassDirty()})}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._setMaterial(e)}_setMaterial(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(void 0,e==null),this._unBindEffect()))}getMaterialForRenderPass(e){return this._internalAbstractMeshDataInfo._materialForRenderPass?.[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]);let i=this._internalAbstractMeshDataInfo._materialForRenderPass[e];i?.meshMap?.[this.uniqueId]&&(i.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this)}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}set skeleton(e){let t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new Bi,this._waitingMaterialId=null,this._waitingMorphTargetManagerId=null,this.cullingStrategy=s.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new j,this.onCollisionPositionChangeObservable=new j,this.onMaterialChangedObservable=new j,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=Jt.Red(),this.outlineWidth=.02,this.overlayColor=Jt.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new x(.5,1,.5),this.ellipsoidOffset=new x(0,0,0),this.edgesWidth=1,this.edgesColor=new ye(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new j,this._onCollisionPositionChange=(i,r,n=null)=>{r.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>H.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),n&&this.onCollideObservable.notifyObservers(n),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},t=this.getScene(),t.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new Ie(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case 2:this.doNotSyncBoundingInfo=!0;case 1:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){let t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+(this.getClassName()==="InstancedMesh"?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);let i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==L.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes){for(let t of this.subMeshes)t._rebuild();this.resetDrawCache()}}_resyncLightSources(){this._lightSources.length=0;for(let e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){let t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e),r=!1;if(i===-1){if(!t)return;this._lightSources.push(e)}else{if(t)return;r=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(r)}_unBindEffect(){for(let e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){let i=this._lightSources.indexOf(e);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(let t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){let r=t._drawWrappers[i];!r||!r.defines||!r.defines.markAllAsDirty||e(r.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,super.markAsDirty(e),this._isDirty=!0,this}resetDrawCache(e,t=!1){if(this.subMeshes)for(let i of this.subMeshes)i.resetDrawCache(e,t)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,r){return this}updateVerticesData(e,t,i,r){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){return this.rawBoundingInfo??this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,t,i){return this._boundingInfo=new oe(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(m.MatricesIndicesKind)&&this.isVerticesDataPresent(m.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===L.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){let r=new F;(this.rotationQuaternion?this.rotationQuaternion:O.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(r);let a=x.Zero(),o=this.definedFacingForward?-1:1;return x.TransformCoordinatesFromFloatsToRef(e*o,t,i*o,r,a),a}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){let r=this.definedFacingForward?1:-1;return new x(e*r,t,i*r)}_refreshBoundingInfo(e,t){if(e){let i=rr(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new oe(i.minimum,i.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(e);this._updateBoundingInfo()}_refreshBoundingInfoDirect(e){if(this._boundingInfo?this._boundingInfo.reConstruct(e.minimum,e.maximum):this._boundingInfo=new oe(e.minimum,e.maximum),this.subMeshes)for(let t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo(null);this._updateBoundingInfo()}static _ApplySkeleton(e,t,i,r,n,a,o){no(e,t,i,r,n,a,o)}_getData(e,t,i=m.PositionKind){let r=e.cache,n=a=>{if(r){let o=r._vertexData||(r._vertexData={});return o[a]||this.copyVerticesData(a,o),o[a]}return this.getVerticesData(a)};if(t||(t=n(i)),!t)return null;if(r?(r._outputData?r._outputData.set(t):r._outputData=new Float32Array(t),t=r._outputData):(e.applyMorph&&this.morphTargetManager||e.applySkeleton&&this.skeleton)&&(t=t.slice()),e.applyMorph&&this.morphTargetManager&&so(t,i,this.morphTargetManager),e.applySkeleton&&this.skeleton){let a=n(m.MatricesIndicesKind),o=n(m.MatricesWeightsKind);if(o&&a){let u=this.numBoneInfluencers>4,l=u?n(m.MatricesIndicesExtraKind):null,c=u?n(m.MatricesWeightsExtraKind):null,h=this.skeleton.getTransformMatrices(this);s._ApplySkeleton(t,i,h,a,o,l,c)}}if(e.updatePositionsArray!==!1&&i===m.PositionKind){let a=this._internalAbstractMeshDataInfo._positions||[],o=a.length;if(a.length=t.length/3,o<a.length)for(let u=o;u<a.length;u++)a[u]=new x;for(let u=0,l=0;u<a.length;u++,l+=3)a[u].copyFromFloats(t[l],t[l+1],t[l+2]);this._internalAbstractMeshDataInfo._positions=a}return t}getNormalsData(e=!1,t=!1){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},null,m.NormalKind)}getPositionData(e=!1,t=!1,i=null){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},i,m.PositionKind)}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new oe(x.Zero(),x.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;let t=this.subMeshes.length;for(let i=0;i<t;i++){let r=this.subMeshes[i];(t>1||!r.IsGlobal)&&r.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){let r=this.getBoundingInfo(),n=e.getBoundingInfo();if(r.intersects(n,t))return!0;if(i){for(let a of this.getChildMeshes())if(a.intersectsMesh(e,t,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e,t=!0){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);let r=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=r.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,r.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId,t),this}_collideForSubMesh(e,t,i){if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];let r=e.verticesStart,n=e.verticesStart+e.verticesCount;for(let a=r;a<n;a++)e._lastColliderWorldVertices.push(x.TransformCoordinates(this._positions[a],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),e.getMaterial()?.fillMode===7),this}_processCollisionsForSubMeshes(e,t){let i=this._scene.getCollidingSubMeshCandidates(this,e),r=i.length;for(let n=0;n<r;n++){let a=i.data[n];r>1&&!a._checkCollision(e)||this._collideForSubMesh(a,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;let t=S.Matrix[0],i=S.Matrix[1];return F.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,r=!1,n,a=!1){let o=new er,u=this.getClassName(),l=u==="InstancedLinesMesh"||u==="LinesMesh"||u==="GreasedLineMesh"?this.intersectionThreshold:0,c=this.getBoundingInfo();if(!this.subMeshes||!a&&(!e.intersectsSphere(c.boundingSphere,l)||!e.intersectsBox(c.boundingBox,l)))return o;if(r)return o.hit=!a,o.pickedMesh=a?null:this,o.distance=a?0:x.Distance(e.origin,c.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let h=null,f=this._scene.getIntersectingSubMeshCandidates(this,e),d=f.length,_=!1;for(let p=0;p<d;p++){let b=f.data[p].getMaterial();if(b&&(b.fillMode==7||b.fillMode==0||b.fillMode==1||b.fillMode==2||b.fillMode==4)){_=!0;break}}if(!_)return o.hit=!0,o.pickedMesh=this,o.distance=x.Distance(e.origin,c.boundingSphere.center),o.subMeshId=-1,o;for(let p=0;p<d;p++){let g=f.data[p];if(d>1&&!a&&!g.canIntersects(e))continue;let b=g.intersects(e,this._positions,this.getIndices(),t,i);if(b&&(t||!h||b.distance<h.distance)&&(h=b,h.subMeshId=g._id,h._internalSubMeshId=p,t))break}if(h){let p=n??this.getWorldMatrix(),g=S.Vector3[0],b=S.Vector3[1];x.TransformCoordinatesToRef(e.origin,p,g),e.direction.scaleToRef(h.distance,b);let M=x.TransformNormal(b,p).addInPlace(g);return o.hit=!0,o.distance=x.Distance(g,M),o.pickedPoint=M,o.pickedMesh=this,o.bu=h.bu||0,o.bv=h.bv||0,o.subMeshFaceId=h.faceId,o.faceId=h.faceId+f.data[h._internalSubMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),o.subMeshId=h.subMeshId,o}return o}clone(e,t,i){return null}releaseSubMeshes(e=!1){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose(e);else this.subMeshes=[];return this}dispose(e,t=!1){let i,r=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),r.freeActiveMeshes(),r.freeRenderingGroups(),r.renderingManager.maintainStateBetweenFrames&&r.renderingManager.restoreDispachedFlags(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.disposeWhenUnowned&&!this._scene.meshes.some(o=>o!==this&&o.actionManager===this.actionManager)&&this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){let o=this._intersectionsInProgress[i],u=o._intersectionsInProgress.indexOf(this);o._intersectionsInProgress.splice(u,1)}this._intersectionsInProgress.length=0;let n=r.lights;for(let o of n){let u=o.includedOnlyMeshes.indexOf(this);u!==-1&&o.includedOnlyMeshes.splice(u,1),u=o.excludedMeshes.indexOf(this),u!==-1&&o.excludedMeshes.splice(u,1);let l=o.getShadowGenerators();if(l){let c=l.values();for(let h=c.next();h.done!==!0;h=c.next()){let d=h.value.getShadowMap();d&&d.renderList&&(u=d.renderList.indexOf(this),u!==-1&&d.renderList.splice(u,1))}}}(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes(!0);let a=r.getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,a.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),a.wipeCaches(),r.removeMesh(this),this._parentContainer){let o=this._parentContainer.meshes.indexOf(this);o>-1&&this._parentContainer.meshes.splice(o,1),this._parentContainer=null}if(t&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<r.particleSystems.length;i++)r.particleSystems[i].emitter===this&&(r.particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}_initFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=[]),e.facetPositions||(e.facetPositions=[]),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=x.Zero(),e.facetPositions[t]=x.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();let t=this.getVerticesData(m.PositionKind),i=this.getIndices(),r=this.getVerticesData(m.NormalKind)?.slice(),n=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let o=!1;for(let u=0;u<i.length;u++)if(i[u]>65535){o=!0;break}o?e.depthSortedIndices=new Uint32Array(i):e.depthSortedIndices=new Uint16Array(i)}if(e.facetDepthSortFunction=function(o,u){return u.sqDistance-o.sqDistance},!e.facetDepthSortFrom){let o=this.getScene().activeCamera;e.facetDepthSortFrom=o?o.position:x.Zero()}e.depthSortedFacets=[];for(let o=0;o<e.facetNb;o++){let u={ind:o*3,sqDistance:0};e.depthSortedFacets.push(u)}e.invertedMatrix=F.Identity(),e.facetDepthSortOrigin=x.Zero()}e.bbSize.x=n.maximum.x-n.minimum.x>me?n.maximum.x-n.minimum.x:me,e.bbSize.y=n.maximum.y-n.minimum.y>me?n.maximum.y-n.minimum.y:me,e.bbSize.z=n.maximum.z-n.minimum.z>me?n.maximum.z-n.minimum.z:me;let a=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(a=a>e.bbSize.z?a:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/a),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/a),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/a),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=n,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),x.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,r&&J.ComputeNormals(t,i,r,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);let o=e.depthSortedIndices.length/3|0;for(let u=0;u<o;u++){let l=e.depthSortedFacets[u].ind;e.depthSortedIndices[u*3]=i[l],e.depthSortedIndices[u*3+1]=i[l+1],e.depthSortedIndices[u*3+2]=i[l+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){let t=x.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){let i=this.getFacetLocalPositions()[e],r=this.getWorldMatrix();return x.TransformCoordinatesToRef(i,r,t),this}getFacetNormal(e){let t=x.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){let i=this.getFacetLocalNormals()[e];return x.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){let r=this.getBoundingInfo(),n=this._internalAbstractMeshDataInfo._facetData,a=Math.floor((e-r.minimum.x*n.partitioningBBoxRatio)*n.subDiv.X*n.partitioningBBoxRatio/n.bbSize.x),o=Math.floor((t-r.minimum.y*n.partitioningBBoxRatio)*n.subDiv.Y*n.partitioningBBoxRatio/n.bbSize.y),u=Math.floor((i-r.minimum.z*n.partitioningBBoxRatio)*n.subDiv.Z*n.partitioningBBoxRatio/n.bbSize.z);return a<0||a>n.subDiv.max||o<0||o>n.subDiv.max||u<0||u>n.subDiv.max?null:n.facetPartitioning[a+n.subDiv.max*o+n.subDiv.max*n.subDiv.max*u]}getClosestFacetAtCoordinates(e,t,i,r,n=!1,a=!0){let o=this.getWorldMatrix(),u=S.Matrix[5];o.invertToRef(u);let l=S.Vector3[8];x.TransformCoordinatesFromFloatsToRef(e,t,i,u,l);let c=this.getClosestFacetAtLocalCoordinates(l.x,l.y,l.z,r,n,a);return r&&x.TransformCoordinatesFromFloatsToRef(r.x,r.y,r.z,o,r),c}getClosestFacetAtLocalCoordinates(e,t,i,r,n=!1,a=!0){let o=null,u=0,l=0,c=0,h=0,f=0,d=0,_=0,p=0,g=this.getFacetLocalPositions(),b=this.getFacetLocalNormals(),y=this.getFacetsAtLocalCoordinates(e,t,i);if(!y)return null;let M=Number.MAX_VALUE,w=M,I,v,D;for(let T=0;T<y.length;T++)I=y[T],v=b[I],D=g[I],h=(e-D.x)*v.x+(t-D.y)*v.y+(i-D.z)*v.z,(!n||n&&a&&h>=0||n&&!a&&h<=0)&&(h=v.x*D.x+v.y*D.y+v.z*D.z,f=-(v.x*e+v.y*t+v.z*i-h)/(v.x*v.x+v.y*v.y+v.z*v.z),d=e+v.x*f,_=t+v.y*f,p=i+v.z*f,u=d-e,l=_-t,c=p-i,w=u*u+l*l+c*c,w<M&&(M=w,o=I,r&&(r.x=d,r.y=_,r.z=p)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=new Array,e.facetParameters={},e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){let t=this.getVerticesData(m.PositionKind),i=this.getIndices(),r;return this.isVerticesDataPresent(m.NormalKind)?r=this.getVerticesData(m.NormalKind):r=[],J.ComputeNormals(t,i,r,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(m.NormalKind,r,e),this}async optimizeIndicesAsync(){let e=this.getIndices();if(!e)return this;let{OptimizeIndices:t}=await import("./chunk-6ZUPNPXK.js");return t(e),this.setIndices(e,this.getTotalVertices()),this}alignWithNormal(e,t){t||(t=ar.Y);let i=S.Vector3[0],r=S.Vector3[1];return x.CrossToRef(t,e,r),x.CrossToRef(e,r,i),this.rotationQuaternion?O.RotationQuaternionFromAxisToRef(i,e,r,this.rotationQuaternion):x.RotationFromAxisToRef(i,e,r,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw N("EdgesRenderer")}enableEdgesRendering(e,t,i){throw N("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}};G.OCCLUSION_TYPE_NONE=0;G.OCCLUSION_TYPE_OPTIMISTIC=1;G.OCCLUSION_TYPE_STRICT=2;G.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;G.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;G.CULLINGSTRATEGY_STANDARD=0;G.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;G.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;G.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;Y([Be.filter((...[s,e,t,i,r])=>!Array.isArray(s)&&!Array.isArray(e)&&!Array.isArray(t)&&!Array.isArray(i)&&!Array.isArray(r))],G,"_ApplySkeleton",null);Fi("BABYLON.AbstractMesh",G)});var Ri,ks=A(()=>{"use strict";Ns();Ve();Ri=class{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=G.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=G.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}};H.prototype.createQuery=function(){return null};H.prototype.deleteQuery=function(s){return this};H.prototype.isQueryResultAvailable=function(s){return!1};H.prototype.getQueryResult=function(s){return 0};H.prototype.beginOcclusionQuery=function(s,e){return!1};H.prototype.endOcclusionQuery=function(s){return this};Object.defineProperty(G.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(s){this._occlusionDataStorage.isOcclusionQueryInProgress=s},enumerable:!1,configurable:!0});Object.defineProperty(G.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new Ri),this.__occlusionDataStorage},enumerable:!1,configurable:!0});Object.defineProperty(G.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(s){this._occlusionDataStorage.isOccluded=s},enumerable:!0,configurable:!0});Object.defineProperty(G.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(s){this._occlusionDataStorage.occlusionQueryAlgorithmType=s},enumerable:!0,configurable:!0});Object.defineProperty(G.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(s){this._occlusionDataStorage.occlusionType=s},enumerable:!0,configurable:!0});Object.defineProperty(G.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(s){this._occlusionDataStorage.occlusionRetryCount=s},enumerable:!0,configurable:!0});Object.defineProperty(G.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(s){this._occlusionDataStorage.forceRenderingWhenOccluded=s},enumerable:!0,configurable:!0});G.prototype._checkOcclusionQuery=function(){let s=this._occlusionDataStorage;if(s.occlusionType===G.OCCLUSION_TYPE_NONE)return s.isOccluded=!1,!1;let e=this.getEngine();if(!e.getCaps().supportOcclusionQuery||!e.isQueryResultAvailable)return s.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery!==null&&this._occlusionQuery!==void 0)if(e.isQueryResultAvailable(this._occlusionQuery)){let r=e.getQueryResult(this._occlusionQuery);s.isOcclusionQueryInProgress=!1,s.occlusionInternalRetryCounter=0,s.isOccluded=!(r>0)}else if(s.occlusionInternalRetryCounter++,s.occlusionRetryCount!==-1&&s.occlusionInternalRetryCounter>s.occlusionRetryCount)s.isOcclusionQueryInProgress=!1,s.occlusionInternalRetryCounter=0,s.isOccluded=s.occlusionType===G.OCCLUSION_TYPE_OPTIMISTIC?!1:s.isOccluded;else return s.occlusionType===G.OCCLUSION_TYPE_OPTIMISTIC?!1:s.isOccluded;let t=this.getScene();if(t.getBoundingBoxRenderer){let i=t.getBoundingBoxRenderer();this._occlusionQuery===null&&(this._occlusionQuery=e.createQuery()),this._occlusionQuery&&e.beginOcclusionQuery(s.occlusionQueryAlgorithmType,this._occlusionQuery)&&(i.renderOcclusionBoundingBox(this),e.endOcclusionQuery(s.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return s.isOccluded}});var $s=A(()=>{"use strict";de();pi();ks();P.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter};P.prototype.captureGPUFrameTime=function(s){this._timestampQuery.enable=s&&!!this._caps.timerQuery};P.prototype.createQuery=function(){return this._occlusionQuery.createQuery()};P.prototype.deleteQuery=function(s){return this._occlusionQuery.deleteQuery(s),this};P.prototype.isQueryResultAvailable=function(s){return this._occlusionQuery.isQueryResultAvailable(s)};P.prototype.getQueryResult=function(s){return this._occlusionQuery.getQueryResult(s)};P.prototype.beginOcclusionQuery=function(s,e){if(this.compatibilityMode){if(this._occlusionQuery.canBeginQuery(e))return this._currentRenderPass?.beginOcclusionQuery(e),!0}else return this._bundleList.addItem(new Ft(e)),!0;return!1};P.prototype.endOcclusionQuery=function(){return this.compatibilityMode?this._currentRenderPass?.endOcclusionQuery():this._bundleList.addItem(new Lt),this}});var zs,Qs,ao,ee,Ks=A(()=>{"use strict";te();de();vn();Re();on();Ne();Pe();Ar();Rr();Fr();je();Xi();be();Mt();Ve();Or();li();ni();ci();hi();zr();Qr();qr();Hr();Zr();ts();pi();is();rs();ns();as();Xe();os();cn();us();Cn();In();En();gn();tr();An();Dn();Bn();Rn();Pn();Fn();Ln();ys();an();Is();Ss();Ms();vs();Cs();As();Ds();Ts();$s();zs={label:"TextureView_SwapChain_ResolveTarget",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},Qs={label:"TextureView_SwapChain",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},ao=new ye,ee=class s extends P{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e}get disableCacheSamplers(){return this._cacheSampler?this._cacheSampler.disabled:!1}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e)}get disableCacheRenderPipelines(){return this._cacheRenderPipeline?this._cacheRenderPipeline.disabled:!1}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)}get disableCacheBindGroups(){return this._cacheBindGroups?this._cacheBindGroups.disabled:!1}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e)}areAllEffectsReady(){return!0}getFontOffset(e){return br(e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(e=>!!e,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return C.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get supportedLimits(){return this._adapterSupportedLimits}get currentLimits(){return this._deviceLimits}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:this._adapterInfo.vendor||"unknown vendor",renderer:this._adapterInfo.architecture||"unknown renderer",version:this._adapterInfo.description||"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){let i=new s(e,t);return new Promise(r=>{i.initAsync(t.glslangOptions,t.twgslOptions).then(()=>r(i))})}constructor(e,t={}){if(super(t.antialias??!0,t),this.uniqueId=-1,this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._glslangAndTintAreFullyLoaded=!1,this._adapterInfo={vendor:"",architecture:"",device:"",description:"",subgroupMinSize:0,subgroupMaxSize:0,isFallbackAdapter:!1},this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this.scenes=[],this._virtualScenes=new Array,this._commandBuffers=[null,null],this._mainRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._rttRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._currentVertexBuffers={},this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._workingGlslangAndTintPromise=null,this._viewportsCurrent={x:0,y:0,w:0,h:0},this._scissorsCurrent={x:0,y:0,w:0,h:0},this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=-1,this._blendColorsCurrent=[null,null,null,null],this._performanceMonitor=new fr,this._name="WebGPU",this._drawCalls=new mt,t.deviceDescriptor=t.deviceDescriptor||{},t.enableGPUDebugMarkers=t.enableGPUDebugMarkers??!1,this._enableGPUDebugMarkers=t.enableGPUDebugMarkers,C.Log(`Babylon.js v${H.Version} - ${this.description} engine`),!navigator.gpu){C.Error("WebGPU is not supported by your browser.");return}t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._renderingCanvas=e,this._options=t,this._mainPassSampleCount=t.antialias?this._defaultSampleCount:1,navigator&&navigator.userAgent&&this._setupMobileChecks(),this._sharedInit(this._renderingCanvas),this._shaderProcessor=new yt,this._shaderProcessorWGSL=new It}prepareGlslangAndTintAsync(){return this._workingGlslangAndTintPromise||(this._workingGlslangAndTintPromise=new Promise(e=>{this._initGlslangAsync(this._glslangOptions??this._options?.glslangOptions).then(t=>{this._glslang=t,this._tintWASM=new ve,this._tintWASM.initTwgsl(this._twgslOptions??this._options?.twgslOptions).then(()=>{this._glslangAndTintAreFullyLoaded=!0,e()})})})),this._workingGlslangAndTintPromise}initAsync(e,t){return this.uniqueId=s._InstanceId++,this._glslangOptions=e,this._twgslOptions=t,navigator.gpu.requestAdapter(this._options).then(async i=>{if(i){this._adapter=i,this._adapterSupportedExtensions=[],this._adapter.features?.forEach(a=>{this._adapterSupportedExtensions.push(a)}),this._adapterSupportedLimits=this._adapter.limits,this._adapterInfo=this._adapter.info;let r=this._options.deviceDescriptor??{},n=r?.requiredFeatures??(this._options.enableAllFeatures?this._adapterSupportedExtensions:void 0);if(n){let a=n,o=[];for(let u of a)this._adapterSupportedExtensions.indexOf(u)!==-1&&o.push(u);r.requiredFeatures=o}if(this._options.setMaximumLimits&&!r.requiredLimits){r.requiredLimits={};for(let a in this._adapterSupportedLimits)a==="minSubgroupSize"||a==="maxSubgroupSize"||(r.requiredLimits[a]=this._adapterSupportedLimits[a])}return r.label=`BabylonWebGPUDevice${this.uniqueId}`,await this._adapter.requestDevice(r)}else throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(i=>{this._device=i,this._deviceEnabledExtensions=[],this._device.features?.forEach(n=>{this._deviceEnabledExtensions.push(n)}),this._deviceLimits=i.limits;let r=-1;this._device.addEventListener("uncapturederror",n=>{++r<this.numMaxUncapturedErrors?C.Warn(`WebGPU uncaptured error (${r+1}): ${n.error} - ${n.error.message}`):r++===this.numMaxUncapturedErrors&&C.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||this._device.lost?.then(n=>{this._isDisposed||(this._contextWasLost=!0,C.Warn("WebGPU context lost. "+n),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(async()=>{let a=this.snapshotRenderingMode,o=this.snapshotRendering,u=this.disableCacheSamplers,l=this.disableCacheRenderPipelines,c=this.disableCacheBindGroups,h=this.enableGPUTimingMeasurements;await this.initAsync(this._glslangOptions??this._options?.glslangOptions,this._twgslOptions??this._options?.twgslOptions),this.snapshotRenderingMode=a,this.snapshotRendering=o,this.disableCacheSamplers=u,this.disableCacheRenderPipelines=l,this.disableCacheBindGroups=c,this.enableGPUTimingMeasurements=h,this._currentRenderPass=null}))})}).then(()=>{this._initializeLimits(),this._bufferManager=new Ct(this,this._device),this._textureHelper=new St(this,this._device,this._bufferManager,this._deviceEnabledExtensions),this._cacheSampler=new ke(this._device),this._cacheBindGroups=new ie(this._device,this._cacheSampler,this),this._timestampQuery=new Ut(this,this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new Ot(this,this._device,this._bufferManager):void 0,this._bundleList=new Et(this._device),this._snapshotRendering=new Gt(this,this._snapshotRenderingMode,this._bundleList),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),R.Uniform|R.CopyDst,"UBInvertY"),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),R.Uniform|R.CopyDst,"UBDontInvertY"),this.dbgVerboseLogsForFirstFrames&&this._count===void 0&&(this._count=0,C.Log(["%c frame #"+this._count+" - begin","background: #ffff00"])),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._emptyVertexBuffer=new m(this,[0],"",{stride:1,offset:0,size:1,label:"EmptyVertexBuffer"}),this._dummyIndexBuffer=this._bufferManager.createBuffer(new Uint16Array([0,0,0,0]),R.Storage|R.CopyDst,"DummyIndices"),this._cacheRenderPipeline=new Me(this._device,this._emptyVertexBuffer),this._depthCullingState=new Dt(this._cacheRenderPipeline),this._stencilStateComposer=new At(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new Tt(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(i=>{throw C.Error("A fatal error occurred during WebGPU creation/initialization."),i})}_initGlslangAsync(e){if(e=e||{},e=z(z({},s._GlslangDefaultOptions),e),e.glslang)return e.glslang;if(self.glslang)return self.glslang(e.wasmPath);if(e.jsPath&&e.wasmPath)return he.LoadBabylonScriptAsync(e.jsPath).then(()=>self.glslang(he.GetBabylonScriptURL(e.wasmPath)));throw new Error("glslang is not available")}_initializeLimits(){let e=this._deviceEnabledExtensions.indexOf("texture-formats-tier1")>=0;this._caps={maxTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxVertexTextureImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxCombinedTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage*2,maxTextureSize:this._deviceLimits.maxTextureDimension2D,maxCubemapTextureSize:this._deviceLimits.maxTextureDimension2D,maxRenderTextureSize:this._deviceLimits.maxTextureDimension2D,maxVertexAttribs:this._deviceLimits.maxVertexAttributes,maxDrawBuffers:8,maxVaryingVectors:this._deviceLimits.maxInterStageShaderVariables,maxFragmentUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),maxVertexUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),shaderFloatPrecision:23,standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf("texture-compression-astc")>=0?!0:void 0,s3tc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0?!0:void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf("texture-compression-etc2")>=0?!0:void 0,bptc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0?!0:void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,blendFloat:this._deviceEnabledExtensions.indexOf("float32-blendable")>=0,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:this._deviceEnabledExtensions.indexOf("rg11b10ufloat-renderable")>=0,textureFloat:!0,textureFloatLinearFiltering:this._deviceEnabledExtensions.indexOf("float32-filterable")>=0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:typeof BigUint64Array<"u"&&this._deviceEnabledExtensions.indexOf("timestamp-query")!==-1?!0:void 0,supportOcclusionQuery:typeof BigUint64Array<"u",canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:this._deviceLimits.maxTextureArrayLayers,disableMorphTargetTexture:!1,textureNorm16:e,blendParametersPerTarget:!0,dualSourceBlending:!0},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportIBLShadows:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!0,_collectUbosUpdatedInFrame:!1},this._alphaState=new Zi(this._caps.blendParametersPerTarget)}_initializeContextAndSwapChain(){if(!this._renderingCanvas)throw"The rendering canvas has not been set!";this._context=this._renderingCanvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new Se(this)],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this._setColorFormat(this._mainRenderPassWrapper)}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(),this._mainTextureExtends={width:this.getRenderWidth(!0),height:this.getRenderHeight(!0),depthOrArrayLayers:1};let e=new Float32Array([this.getRenderHeight(!0)]);this._bufferManager.setSubData(this._ubInvertY,4,e),this._bufferManager.setSubData(this._ubDontInvertY,4,e);let t;if(this._options.antialias){let n={label:`Texture_MainColor_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}_antialiasing`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._options.swapChainFormat,usage:16};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(n),t=[{view:this._mainTexture.createView({label:"TextureView_MainColor_antialiasing",dimension:"2d",format:this._options.swapChainFormat,mipLevelCount:1,arrayLayerCount:1}),clearValue:new ye(0,0,0,1),loadOp:"clear",storeOp:"store"}]}else t=[{view:void 0,clearValue:new ye(0,0,0,1),loadOp:"clear",storeOp:"store"}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?"depth24plus-stencil8":"depth32float",this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper);let i={label:`Texture_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._mainRenderPassWrapper.depthTextureFormat,usage:16};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(i);let r={view:this._depthTexture.createView({label:`TextureView_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,dimension:"2d",format:this._depthTexture.format,mipLevelCount:1,arrayLayerCount:1}),depthClearValue:this._clearDepthValue,depthLoadOp:"clear",depthStoreOp:"store",stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?"clear":void 0,stencilStoreOp:this.isStencilEnable?"store":void 0};this._mainRenderPassWrapper.renderPassDescriptor={label:"MainRenderPass",colorAttachments:t,depthStencilAttachment:r},this.beginFrame(),this._startMainRenderPass(!0,null,!0,!1),this._endCurrentRenderPass(),this.endFrame(),this._frameId--}_sharedInit(e){super._sharedInit(e),gr(this,e,this._creationOptions)}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:17,alphaMode:this.premultipliedAlpha?"premultiplied":"opaque"})}resizeImageBitmap(e,t,i){return yr(this,e,t,i)}async _createImageBitmapFromSource(e,t){return await xr(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&Ir(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&Sr()}enterPointerlock(){this._renderingCanvas&&Mr(this._renderingCanvas)}exitPointerlock(){vr()}_rebuildBuffers(){super._rebuildBuffers();for(let e of this._storageBuffers)e.getBuffer().engineId!==this.uniqueId&&e._rebuild()}_restoreEngineAfterContextLost(e){Me.ResetCache(),ie.ResetCache();let t=r=>{for(let n of r){for(let a of n.meshes){let o=a.subMeshes;if(o)for(let u of o)u._drawWrappers=[]}for(let a of n.materials)a._materialContext?.reset()}};t(this.scenes),t(this._virtualScenes);let i=[];for(let r of this._uniformBuffers)r.name.indexOf("leftOver")<0&&i.push(r);this._uniformBuffers=i,super._restoreEngineAfterContextLost(e)}setSize(e,t,i=!1){return super.setSize(e,t,i)?(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&C.Log(["frame #"+this._count+" - setSize -",e,t])),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0):!1}_getShaderProcessor(e){return e===1?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e,t){return new fe(e,t)}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassWrapper(){return this._currentRenderTarget?this._rttRenderPassWrapper:this._mainRenderPassWrapper}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled)}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._resetAlphaMode(),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0)}getColorWrite(){return this._colorWriteLocal}_mustUpdateViewport(){let e=this._viewportCached.x,t=this._viewportCached.y,i=this._viewportCached.z,r=this._viewportCached.w,n=this._viewportsCurrent.x!==e||this._viewportsCurrent.y!==t||this._viewportsCurrent.w!==i||this._viewportsCurrent.h!==r;return n&&(this._viewportsCurrent.x=this._viewportCached.x,this._viewportsCurrent.y=this._viewportCached.y,this._viewportsCurrent.w=this._viewportCached.z,this._viewportsCurrent.h=this._viewportCached.w),n}_applyViewport(e){let t=Math.floor(this._viewportCached.x),i=Math.floor(this._viewportCached.z),r=Math.floor(this._viewportCached.w),n=Math.floor(this._viewportCached.y);this._currentRenderTarget||(n=this.getRenderHeight(!0)-n-r),e?e.addItem(new Bt(t,n,i,r)):this._getCurrentRenderPass().setViewport(t,n,i,r,0,1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&C.Log(["frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_viewport(e,t,i,r){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r}_mustUpdateScissor(){let e=this._scissorCached.x,t=this._scissorCached.y,i=this._scissorCached.z,r=this._scissorCached.w,n=this._scissorsCurrent.x!==e||this._scissorsCurrent.y!==t||this._scissorsCurrent.w!==i||this._scissorsCurrent.h!==r;return n&&(this._scissorsCurrent.x=this._scissorCached.x,this._scissorsCurrent.y=this._scissorCached.y,this._scissorsCurrent.w=this._scissorCached.z,this._scissorsCurrent.h=this._scissorCached.w),n}_applyScissor(e){let t=this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y;e?e.addItem(new Rt(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w)):this._getCurrentRenderPass().setScissorRect(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&C.Log(["frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_scissorIsActive(){return this._scissorCached.x!==0||this._scissorCached.y!==0||this._scissorCached.z!==0||this._scissorCached.w!==0}enableScissor(e,t,i,r){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=i,this._scissorCached.w=r}disableScissor(){this._scissorCached.x=this._scissorCached.y=this._scissorCached.z=this._scissorCached.w=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0}_mustUpdateStencilRef(){let e=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent;return e&&(this._stencilRefsCurrent=this._stencilStateComposer.funcRef),e}_applyStencilRef(e){e?e.addItem(new st(this._stencilStateComposer.funcRef??0)):this._getCurrentRenderPass().setStencilReference(this._stencilStateComposer.funcRef??0)}_mustUpdateBlendColor(){let e=this._alphaState._blendConstants,t=e[0]!==this._blendColorsCurrent[0]||e[1]!==this._blendColorsCurrent[1]||e[2]!==this._blendColorsCurrent[2]||e[3]!==this._blendColorsCurrent[3];return t&&(this._blendColorsCurrent[0]=e[0],this._blendColorsCurrent[1]=e[1],this._blendColorsCurrent[2]=e[2],this._blendColorsCurrent[3]=e[3]),t}_applyBlendColor(e){e?e.addItem(new Pt(this._alphaState._blendConstants.slice())):this._getCurrentRenderPass().setBlendConstant(this._alphaState._blendConstants)}_resetRenderPassStates(){this._viewportsCurrent.x=this._viewportsCurrent.y=this._viewportsCurrent.w=this._viewportsCurrent.h=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0,this._stencilRefsCurrent=-1,this._blendColorsCurrent[0]=this._blendColorsCurrent[1]=this._blendColorsCurrent[2]=this._blendColorsCurrent[3]=null}clear(e,t,i,r=!1,n=0){e&&e.a===void 0&&(e.a=1),r&&(this._clearStencilValue=n);let a=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&C.Log(["frame #"+this._count+" - clear - backBuffer=",t," depth=",i," stencil=",r," scissor is active=",a])),this._currentRenderTarget?a?(this._currentRenderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,t?e:null,i,r),this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)):(this._currentRenderPass&&this._endCurrentRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,t?e:null,i,r)):((!this._currentRenderPass||!a)&&this._startMainRenderPass(!a,t?e:null,i,r),a&&(this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)))}_clearFullQuad(e,t,i){let r=this.compatibilityMode?this._getCurrentRenderPass():null;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(this._cacheRenderPipeline.mrtAttachments??[],this._cacheRenderPipeline.mrtTextureArray??[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?r.setStencilReference(this._clearStencilValue):this._bundleList.addItem(new st(this._clearStencilValue));let n=this._clearQuad.clear(r,e,t,i,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(null):(this._bundleList.addBundle(n),this._applyStencilRef(this._bundleList),this._reportDrawCall())}createVertexBuffer(e,t,i){let r;return e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e,this._bufferManager.createBuffer(r,R.Vertex|R.CopyDst|R.Storage,i)}createDynamicVertexBuffer(e,t){return this.createVertexBuffer(e,void 0,t)}createIndexBuffer(e,t,i){let r=!0,n;if(e instanceof Uint32Array||e instanceof Int32Array)n=e;else if(e instanceof Uint16Array)n=e,r=!1;else{for(let o=0;o<e.length;o++)if(e[o]>65535){n=new Uint32Array(e);break}n||(n=new Uint16Array(e),r=!1)}let a=this._bufferManager.createBuffer(n,R.Index|R.CopyDst|R.Storage,i);return a.is32Bits=r,a}updateDynamicIndexBuffer(e,t,i=0){let r=e,n;e.is32Bits?n=t instanceof Uint32Array?t:new Uint32Array(t):n=t instanceof Uint16Array?t:new Uint16Array(t),this._bufferManager.setSubData(r,i,n)}updateDynamicVertexBuffer(e,t,i,r){let n=e;i===void 0&&(i=0);let a;r===void 0?(t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,r=a.byteLength):t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,this._bufferManager.setSubData(n,i,a,0,r)}_createBuffer(e,t,i){let r;e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e;let n=0;return t&1&&(n|=R.CopySrc),t&2&&(n|=R.CopyDst),t&4&&(n|=R.Uniform),t&8&&(n|=R.Vertex),t&16&&(n|=R.Index),t&32&&(n|=R.Storage),t&64&&(n|=R.Indirect),this._bufferManager.createBuffer(r,n,i)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}unbindInstanceAttributes(){}bindBuffers(e,t,i,r){this._currentVertexBuffers=e,this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=r??null,this._cacheRenderPipeline.setBuffers(this._currentVertexBuffers,this._currentIndexBuffer,this._currentOverrideVertexBuffers)}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createUniformBuffer(e,t){let i;return e instanceof Array?i=new Float32Array(e):i=e,this._bufferManager.createBuffer(i,R.Uniform|R.CopyDst,t)}createDynamicUniformBuffer(e,t){return this.createUniformBuffer(e,t)}updateUniformBuffer(e,t,i,r){i===void 0&&(i=0);let n=e,a;r===void 0?(t instanceof Float32Array?a=t:a=new Float32Array(t),r=a.byteLength):t instanceof Float32Array?a=t:a=new Float32Array(t),this._bufferManager.setSubData(n,i,a,0,r)}bindUniformBufferBase(e,t,i){this._currentDrawContext.setBuffer(i,e)}bindUniformBlock(){}createEffect(e,t,i,r,n,a,o,u,l,c=0,h){let f=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,_=this._getGlobalDefines(),p=t.attributes!==void 0,g=n??t.defines??"";_&&(g+=`
`+_);let b=f+"+"+d+"@"+g;if(this._compiledEffects[b]){let M=this._compiledEffects[b];return o&&M.isReady()&&o(M),M._refCount++,M}let y=new qi(e,t,p?this:i,r,this,n,a,o,u,l,b,t.shaderLanguage??c,t.extraInitializationsAsync??h);return this._compiledEffects[b]=y,y}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,i,r){return this._compileRawShaderToSpirV(r+(i?i+`
`:"")+e,t)}_getWGSLShader(e,t,i){return i?i="//"+i.split(`
`).join(`
//`)+`
`:i="",i+e}_createPipelineStageDescriptor(e,t,i,r,n){return this._tintWASM&&i===0&&(e=this._tintWASM.convertSpirV2WGSL(e,r),t=this._tintWASM.convertSpirV2WGSL(t,n)),{vertexStage:{module:this._device.createShaderModule({label:"vertex",code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({label:"fragment",code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,t,i){let r=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,n=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a=i===0?this._compileRawShaderToSpirV(e,"vertex"):e,o=i===0?this._compileRawShaderToSpirV(t,"fragment"):t;return this._createPipelineStageDescriptor(a,o,i,r,n)}_compilePipelineStageDescriptor(e,t,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);let n=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,o=`#version 450
`,u=r===0?this._compileShaderToSpirV(e,"vertex",i,o):this._getWGSLShader(e,"vertex",i),l=r===0?this._compileShaderToSpirV(t,"fragment",i,o):this._getWGSLShader(t,"fragment",i),c=this._createPipelineStageDescriptor(u,l,r,n,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),c}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(e){let t=new ss(e);return t.debug=!1,t.processCode(),t.code}createPipelineContext(e){return new _t(e,this)}createMaterialContext(){return new Kr}createDrawContext(){return new Yr(this._bufferManager,this._dummyIndexBuffer)}async _preparePipelineContextAsync(e,t,i,r,n,a,o,u,l,c,h){let f=e,d=f.shaderProcessingContext.shaderLanguage;d===0&&!this._glslangAndTintAreFullyLoaded&&await this.prepareGlslangAndTintAsync(),this.dbgShowShaderCode&&(C.Log(["defines",u]),C.Log(t),C.Log(i),C.Log("***********************************************")),f.sources={fragment:i,vertex:t,rawVertex:n,rawFragment:a},r?f.stages=this._compileRawPipelineStageDescriptor(t,i,d):f.stages=this._compilePipelineStageDescriptor(t,i,u,d),h()}getAttributes(e,t){let i=new Array(t.length),r=e;for(let n=0;n<t.length;n++){let a=t[n],o=r.shaderProcessingContext.availableAttributes[a];o!==void 0&&(i[n]=o)}return i}enableEffect(e){if(e){if(!or(e))this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&C.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${typeof e.name=="string"?"":e.name.vertex}, effect.name.fragment=${typeof e.name=="string"?"":e.name.fragment}`,10);else if(!e.effect||e.effect===this._currentEffect&&e.materialContext===this._currentMaterialContext&&e.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw C.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the effect property is empty!";return}else if(this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw C.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the materialContext property is empty!";this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=!1,this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect)}}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))}releaseEffects(){for(let e in this._compiledEffects){let t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}_deletePipelineContext(e){let t=e;t&&Ki(t)}get needPOTTextures(){return!1}_createHardwareTexture(){return new Se(this)}_releaseTexture(e){let t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(e,t){e._comparisonFunction=t}_createInternalTexture(e,t,i=!0,r=0){let n={};t!==void 0&&typeof t=="object"?(n.generateMipMaps=t.generateMipMaps,n.createMipMaps=t.createMipMaps,n.type=t.type===void 0?0:t.type,n.samplingMode=t.samplingMode===void 0?3:t.samplingMode,n.format=t.format===void 0?5:t.format,n.samples=t.samples??1,n.creationFlags=t.creationFlags??0,n.useSRGBBuffer=t.useSRGBBuffer??!1,n.label=t.label,n.isCube=!!t.isCube):(n.generateMipMaps=t,n.type=0,n.samplingMode=3,n.format=5,n.samples=1,n.creationFlags=0,n.useSRGBBuffer=!1,n.isCube=!1),(n.type===1&&!this._caps.textureFloatLinearFiltering||n.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(n.samplingMode=1),n.type===1&&!this._caps.textureFloat&&(n.type=0,C.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));let a=new K(this,r),o=e.width??e,u=e.height??e,l=e.depth??0,c=e.layers??0;if(a.baseWidth=o,a.baseHeight=u,a.width=o,a.height=u,a.depth=l||c,a.isReady=!0,a.samples=n.samples,a.generateMipMaps=!!n.generateMipMaps,a.samplingMode=n.samplingMode,a.type=n.type,a.format=n.format,a.is2DArray=c>0,a.is3D=l>0,a.isCube=n.isCube,a._cachedWrapU=0,a._cachedWrapV=0,a._useSRGBBuffer=n.useSRGBBuffer,a.label=n.label,this._internalTexturesCache.push(a),!i){let h=!n.generateMipMaps&&n.createMipMaps;h&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a,o,u,a.depth||1,n.creationFlags),h&&(a.generateMipMaps=!1)}return a}createTexture(e,t,i,r,n=3,a=null,o=null,u=null,l=null,c=null,h=null,f,d,_,p){return this._createTextureBase(e,t,i,r,n,a,o,(g,b,y,M,w,I,v,D)=>{let T=M;if(g.baseWidth=T.width,g.baseHeight=T.height,g.width=T.width,g.height=T.height,g.format=g.format!==-1?g.format:c??5,g.type=g.type!==-1?g.type:0,g._creationFlags=_??0,D(g.width,g.height,T,b,g,()=>{}),g._hardwareTexture?.underlyingResource)!I&&!v&&this._generateMipmaps(g,this._uploadEncoder);else{let W=this._textureHelper.createGPUTextureForInternalTexture(g,T.width,T.height,void 0,_);B.IsImageBitmap(T)&&(this._textureHelper.updateTexture(T,g,T.width,T.height,g.depth,W.format,0,0,w,!1,0,0),!I&&!v&&this._generateMipmaps(g,this._uploadEncoder))}y&&y.removePendingData(g),g.isReady=!0,g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear()},()=>!1,u,l,c,h,f,d,p)}wrapWebGPUTexture(e){let t=new Se(this,e),i=new K(this,0,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers}_unpackFlipY(e){}updateTextureSamplingMode(e,t,i=!1){i&&(t.generateMipMaps=!0,this._generateMipmaps(t)),t.samplingMode=e}updateTextureWrappingMode(e,t,i=null,r=null){t!==null&&(e._cachedWrapU=t),i!==null&&(e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(e._cachedWrapR=r)}updateTextureDimensions(e,t,i,r=1){if(!e._hardwareTexture||e.width===t&&e.height===i&&e.depth===r)return;let n=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,i,r,n)}_setInternalTexture(e,t,i){if(i=i??e,this._currentEffect){let n=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[i];if(this._currentMaterialContext.setTexture(e,t),n&&n.autoBindSampler){let a=i+"Sampler";this._currentMaterialContext.setSampler(a,t)}}}createPrefilteredCubeTexture(e,t,i,r,n=null,a=null,o,u=null,l=!0){let c=h=>{if(!h){n&&n(null);return}let f=h.texture;l?h.info.sphericalPolynomial&&(f._sphericalPolynomial=h.info.sphericalPolynomial):f._sphericalPolynomial=f._sphericalPolynomial??new mr,f._source=9,n&&n(f)};return this.createCubeTexture(e,t,null,!1,c,a,o,u,l,i,r)}setTexture(e,t,i,r){this._setTexture(e,i,!1,!1,r,r)}setTextureArray(e,t,i,r){for(let n=0;n<i.length;n++)this._setTexture(-1,i[n],!0,!1,r+n.toString(),r)}_setTexture(e,t,i=!1,r=!1,n="",a){if(a=a??n,this._currentEffect){if(!t)return this._currentMaterialContext.setTexture(n,null),!1;if(t.video)t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let o=null;if(r?o=t.depthStencilTexture:t.isReady()?o=t.getInternalTexture():t.isCube?o=this.emptyCubeTexture:t.is3D?o=this.emptyTexture3D:t.is2DArray?o=this.emptyTexture2DArray:o=this.emptyTexture,o&&!o.isMultiview){if(o.isCube&&o._cachedCoordinatesMode!==t.coordinatesMode){o._cachedCoordinatesMode=t.coordinatesMode;let u=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=u,t.wrapV=u}o._cachedWrapU=t.wrapU,o._cachedWrapV=t.wrapV,o.is3D&&(o._cachedWrapR=t.wrapR),this._setAnisotropicLevel(0,o,t.anisotropicFilteringLevel)}this._setInternalTexture(n,o,a)}else this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&C.Log(["frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",t]));return!0}_setAnisotropicLevel(e,t,i){t._cachedAnisotropicFilteringLevel!==i&&(t._cachedAnisotropicFilteringLevel=Math.min(i,this._caps.maxAnisotropy))}_bindTexture(e,t,i){e!==void 0&&this._setInternalTexture(i,t)}generateMipmaps(e){this._generateMipmaps(e)}updateTextureData(e,t,i,r,n,a,o=0,u=0,l=!1){let c=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(e));let h=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(h,e,n,a,e.depth,c.format,o,u,e.invertY,!1,i,r),l&&this._generateMipmaps(e)}_uploadCompressedDataToTextureDirectly(e,t,i,r,n,a=0,o=0){let u=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(e.format=t,u=this._textureHelper.createGPUTextureForInternalTexture(e,i,r));let l=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);this._textureHelper.updateTexture(l,e,i,r,e.depth,u.format,a,o,!1,!1,0,0)}_uploadDataToTextureDirectly(e,t,i=0,r=0,n,a=!1){let o=Math.round(Math.log(e.width)*Math.LOG2E),u=Math.round(Math.log(e.height)*Math.LOG2E),l=a?e.width:Math.pow(2,Math.max(o-r,0)),c=a?e.height:Math.pow(2,Math.max(u-r,0)),h=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(h=this._textureHelper.createGPUTextureForInternalTexture(e,l,c));let f=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(f,e,l,c,e.depth,h.format,i,r,e.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){this._uploadDataToTextureDirectly(e,t,i,r)}_uploadImageToTexture(e,t,i=0,r=0){let n=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(n=this._textureHelper.createGPUTextureForInternalTexture(e)),t instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";let a=t,o=Math.ceil(e.width/(1<<r)),u=Math.ceil(e.height/(1<<r));this._textureHelper.updateTexture(a,e,o,u,e.depth,n.format,i,r,e.invertY,!1,0,0)}readPixels(e,t,i,r,n=!0,a=!0,o=null){let l=this._getCurrentRenderPassWrapper().colorAttachmentGPUTextures[0];if(!l)return Promise.resolve(new Uint8Array(0));let c=l.underlyingResource,h=l.format;return c?(a&&this.flushFramebuffer(),this._textureHelper.readPixels(c,e,t,i,r,h,void 0,void 0,o)):Promise.resolve(new Uint8Array(0))}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}beginFrame(){this._measureFps(),super.beginFrame()}endFrame(){if(this._endCurrentRenderPass(),this._snapshotRendering.endFrame(),this._timestampQuery.endFrame(this._renderEncoder),this._timestampIndex=0,this.flushFramebuffer(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){let e=[];for(let t in Ie._UpdatedUbosInFrame)e.push(t+":"+Ie._UpdatedUbosInFrame[t]);C.Log(["frame #"+this._count+" - updated ubos -",e.join(", ")])}Ie._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&C.Log(["%c frame #"+this._count+" - end","background: #ffff00"]),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&C.Log(["%c frame #"+this._count+" - begin","background: #ffff00"]))),super.endFrame()}extractDriverInfo(){return""}flushFramebuffer(){this._endCurrentRenderPass(),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset()}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentPassIsMainPass()}_startRenderTargetRenderPass(e,t,i,r,n){this._endCurrentRenderPass();let a=e,o=e.samples,u=o>1,l=a._depthStencilTexture,c=l?._hardwareTexture,h=c?.underlyingResource,f,d;if(u){let I=c?.getMSAATexture(o);f=I?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),d=I?.format}!f&&h&&(f=h.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor)),!d&&c&&(d=c.format);let _=d?B.HasStencilAspect(d):!1,p=d?B.HasDepthAspect(d):!1,g=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();let b=ao;i&&(b.r=i.r*255,b.g=i.g*255,b.b=i.b*255,b.a=i.a*255);let y=t&&i,M=t&&r,w=t&&n;if(a._attachments&&a.isMulti){(!this._mrtAttachments||this._mrtAttachments.length===0)&&(this._mrtAttachments=a._defaultAttachments);for(let I=0;I<this._mrtAttachments.length;++I){let v=this._mrtAttachments[I],D=a.textures[I],T=D?._hardwareTexture,W=T?.underlyingResource;if(T&&W){let E=a.getBaseArrayLayer(I),Q=u?T.getMSAATexture(o,I):void 0,ue=qe(z({},this._rttRenderPassWrapper.colorAttachmentViewDescriptor),{dimension:D.is3D?"3d":"2d",format:T.format,baseArrayLayer:E}),le=qe(z({},this._rttRenderPassWrapper.colorAttachmentViewDescriptor),{dimension:D.is3D?"3d":"2d",format:T.format,baseArrayLayer:0}),k=D.type===7||D.type===5,ce=W.createView(ue),X=Q?.createView(le);g.push({view:X||ce,resolveTarget:Q&&!a.disableAutomaticMSAAResolve&&a.resolveMSAAColors?ce:void 0,depthSlice:D.is3D?a.layerIndices?.[I]??0:void 0,clearValue:v!==0&&y?k?b:i:void 0,loadOp:v!==0&&y?"clear":"load",storeOp:"store"})}}this._cacheRenderPipeline.setMRT(a.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{let I=a.texture;if(I){let v=I._hardwareTexture,D=v.underlyingResource,T;a.is3D&&(T=this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer,this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer=0);let W=u?v.getMSAATexture(o):void 0,E=D.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),Q=W?.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),ue=I.type===7||I.type===5;g.push({view:Q||E,resolveTarget:W&&!a.disableAutomaticMSAAResolve&&a.resolveMSAAColors?E:void 0,depthSlice:T,clearValue:y?ue?b:i:void 0,loadOp:y?"clear":"load",storeOp:"store"})}else g.push(null)}if(this._rttRenderPassWrapper.renderPassDescriptor={label:(e.label??"RTT")+" - RenderPass",colorAttachments:g,depthStencilAttachment:l&&h?{view:f,depthClearValue:M?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:a.depthReadOnly||!p?void 0:M?"clear":"load",depthStoreOp:a.depthReadOnly||!p?void 0:"store",depthReadOnly:a.depthReadOnly,stencilClearValue:a._depthStencilTextureWithStencil&&w?this._clearStencilValue:void 0,stencilLoadOp:a.stencilReadOnly||!_?void 0:a._depthStencilTextureWithStencil&&w?"clear":"load",stencilStoreOp:a.stencilReadOnly||!_?void 0:"store",stencilReadOnly:a.stencilReadOnly}:void 0,occlusionQuerySet:this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0},this._timestampQuery.startPass(this._rttRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){let I=a.texture;C.Log(["frame #"+this._count+" - render target begin pass - rtt name="+e.label+", internalTexture.uniqueId="+I.uniqueId+", width="+I.width+", height="+I.height+", setClearStates="+t,"renderPassDescriptor=",this._rttRenderPassWrapper.renderPassDescriptor])}this._resetRenderPassStates(),(!c||!B.HasStencilAspect(c.format))&&(this._stencilStateComposer.enabled=!1)}_startMainRenderPass(e,t,i,r){this._endCurrentRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();let n=e&&t,a=e&&i,o=e&&r;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=n?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=n?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=a?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=a?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=o?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?o?"clear":"load":void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0;let u=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(u),this._options.antialias?(zs.format=u.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=u.createView(zs)):(Qs.format=u.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=u.createView(Qs)),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&C.Log(["frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height+", setClearStates="+e,"renderPassDescriptor=",this._mainRenderPassWrapper.renderPassDescriptor])),this._timestampQuery.startPass(this._mainRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper),this._resetRenderPassStates(),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}bindFramebuffer(e,t=0,i,r,n,a=0,o=0){let u=e.texture?._hardwareTexture;this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass(),this._currentRenderTarget=e;let l=this._currentRenderTarget._depthStencilTexture;this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=u,this._rttRenderPassWrapper.depthTextureFormat=l?B.GetWebGPUTextureFormat(-1,l.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={label:e.label?e.label+" - Color Attachment View":"RTT - Color Attachment View",format:this._colorFormat,dimension:e.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:e.isCube?o*6+t:o,baseMipLevel:a,arrayLayerCount:1,aspect:"all"},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={label:e.label?e.label+" - Depth Attachment View":"RTT - Depth Attachment View",format:this._depthTextureFormat,dimension:l&&l.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:l?l.isCube?o*6+t:o:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"},this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&C.Log(["frame #"+this._count+" - bindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId="+e.texture?.uniqueId+", face="+t+", lodLevel="+a+", layer="+o,"colorAttachmentViewDescriptor=",this._rttRenderPassWrapper.colorAttachmentViewDescriptor,"depthAttachmentViewDescriptor=",this._rttRenderPassWrapper.depthAttachmentViewDescriptor])),(this._snapshotRendering.play||this._snapshotRendering.record)&&this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1),this._cachedViewport&&!n?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,a&&(i=i/Math.pow(2,a))),r||(r=e.height,a&&(r=r/Math.pow(2,a))),this._viewport(0,0,i,r)),this.wipeCaches()}unBindFramebuffer(e,t=!1,i){let r=this._currentRenderTarget;this._currentRenderTarget=null,i&&i(),this._currentRenderTarget=r,this._endCurrentRenderPass(),this._resolveAndGenerateMipMapsFramebuffer(e,t),this._currentRenderTarget=null,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&C.Log("frame #"+this._count+" - unBindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId=",e.texture?.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}_resolveAndGenerateMipMapsFramebuffer(e,t=!1){e.disableAutomaticMSAAResolve||this.resolveFramebuffer(e,!1),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e))}generateMipMapsFramebuffer(e){!e.isMulti&&e.texture?.generateMipMaps&&!e.isCube&&this._generateMipmaps(e.texture)}resolveFramebuffer(e,t=!0){if(!(e.samples<=1)){if(e.resolveMSAAColors&&t){let i=e.disableAutomaticMSAAResolve;e.disableAutomaticMSAAResolve=!1,this.bindFramebuffer(e),this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1),this.unBindFramebuffer(e),e.disableAutomaticMSAAResolve=i}if(e.resolveMSAADepth&&e._depthStencilTexture){let i=e._depthStencilTexture._hardwareTexture;this._textureHelper.resolveMSAADepthTexture(i.getMSAATexture(e.samples),i.underlyingResource,this._renderEncoder)}}}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._currentRenderPass&&this._endCurrentRenderPass(),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(e){let t=e.colorAttachmentGPUTextures[0]?.format??null;this._cacheRenderPipeline.setColorFormat(t),this._colorFormat!==t&&(this._colorFormat=t)}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}_executeWhenRenderingStateIsCompiled(e,t){t()}bindSamplers(){}_getUnpackAlignement(){return 1}_bindTextureDirectly(){return!1}setStateCullFaceType(e,t=!1){let i=this.cullBackFaces??e??!0?1:2;(this._depthCullingState.cullFace!==i||t)&&(this._depthCullingState.cullFace=i)}setState(e,t=0,i,r=!1,n,a,o=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(n,i),this.setZOffset(t),this.setZOffsetUnits(o);let u=r?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==u||i)&&(this._depthCullingState.frontFace=u),this._stencilStateComposer.stencilMaterial=a}_applyRenderPassChanges(e){let t=this._stencilStateComposer.enabled?this._mustUpdateStencilRef():!1,i=this._alphaState.alphaBlend?this._mustUpdateBlendColor():!1;this._mustUpdateViewport()&&this._applyViewport(e),this._mustUpdateScissor()&&this._applyScissor(e),t&&this._applyStencilRef(e),i&&this._applyBlendColor(e)}_draw(e,t,i,r,n){let a=this._getCurrentRenderPass(),o=this._bundleList;this.applyStates();let u=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,q.InternalsUBOName),this._currentDrawContext.setVertexPulling(this._currentMaterialContext.useVertexPulling,u,this._currentVertexBuffers,this._cacheRenderPipeline.indexBuffer,this._currentOverrideVertexBuffers),u.uniformBuffer&&(u.uniformBuffer.update(),this.bindUniformBufferBase(u.uniformBuffer.getBuffer(),0,q.LeftOvertUBOName)),this._snapshotRendering.play){this._reportDrawCall();return}!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);let l=!this.compatibilityMode&&this._currentDrawContext.fastBundle,c=a;if(l||this._snapshotRendering.record){if(this._applyRenderPassChanges(o),!this._snapshotRendering.record){this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(r,n||1,i),o.addBundle(this._currentDrawContext.fastBundle),this._reportDrawCall();return}c=o.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),o.numDrawCalls++}let h=0;if(this._currentMaterialContext.hasFloatOrDepthTextures){let g=1;for(let b=0;b<u.shaderProcessingContext.textureNames.length;++b){let y=u.shaderProcessingContext.textureNames[b],M=this._currentMaterialContext.textures[y]?.texture,w=M&&M.format>=13&&M.format<=18;(M?.type===1&&!this._caps.textureFloatLinearFiltering||w)&&(h|=g),g=g<<1}}this._currentMaterialContext.textureState=h;let f=this._cacheRenderPipeline.getRenderPipeline(t,this._currentEffect,this.currentSampleCount,h),d=this._cacheBindGroups.getBindGroups(u,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(this.compatibilityMode?null:o),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,c=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:B.GetSample(this.currentSampleCount)}))),c.setPipeline(f),this._currentIndexBuffer&&c.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?"uint32":"uint16",0);let _=this._cacheRenderPipeline.vertexBuffers;for(let g=0;g<_.length;g++){let b=_[g],y=b.effectiveBuffer;y&&c.setVertexBuffer(g,y.underlyingResource,b._validOffsetRange?0:b.byteOffset)}for(let g=0;g<d.length;g++)c.setBindGroup(g,d[g]);let p=!this.compatibilityMode&&!this._snapshotRendering.record;(p||this._currentDrawContext._enableIndirectDrawInCompatMode)&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(r,n||1,i),e===0?c.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):c.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):e===0?c.drawIndexed(r,n||1,i,0,0):c.draw(r,n||1,i,0),p&&(this._currentDrawContext.fastBundle=c.finish(),o.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(e,t,i,r=1){this._draw(0,e,t,i,r)}drawArraysType(e,t,i,r=1){this._currentIndexBuffer=null,this._draw(1,e,t,i,r)}dispose(){this._isDisposed=!0,this.hideLoadingUI(),this._timestampQuery.dispose(),this._mainTexture?.destroy(),this._depthTexture?.destroy(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._device.destroy(),_r(this,this._renderingCanvas),super.dispose()}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._renderingCanvas?.width??0}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._renderingCanvas?.height??0}getError(){return 0}createExternalTexture(e){return new Kt(e)}setExternalTexture(e,t){if(!t){this._currentMaterialContext.setTexture(e,null);return}this._setInternalTexture(e,t)}setTextureSampler(e,t){this._currentMaterialContext?.setSampler(e,t)}createStorageBuffer(e,t,i){return this._createBuffer(e,t|32,i)}clearStorageBuffer(e,t,i){this._renderEncoder.clearBuffer(e.underlyingResource,t,i)}updateStorageBuffer(e,t,i,r){let n=e;i===void 0&&(i=0);let a;r===void 0?(t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,r=a.byteLength):t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,this._bufferManager.setSubData(n,i,a,0,r)}async _readFromGPUBuffer(e,t,i,r){return await new Promise((n,a)=>{let o=()=>{e.mapAsync(1,0,t).then(()=>{let u=e.getMappedRange(0,t),l=i;if(l===void 0)l=new Uint8Array(t),l.set(new Uint8Array(u));else{let c=l.constructor;l=new c(l.buffer),l.set(new c(u))}e.unmap(),this._bufferManager.releaseBuffer(e),n(l)},u=>{this.isDisposed?n(new Uint8Array):a(u)})};r?(this.flushFramebuffer(),o()):this.onEndFrameObservable.addOnce(()=>{o()})})}readFromStorageBuffer(e,t,i,r,n){i=i||e.capacity;let a=this._bufferManager.createRawBuffer(i,R.MapRead|R.CopyDst,void 0,"TempReadFromStorageBuffer");return this._renderEncoder.copyBufferToBuffer(e.underlyingResource,t??0,a,0,i),this._readFromGPUBuffer(a,i,r,n)}readFromMultipleStorageBuffers(e,t,i,r,n){i=i||e[0].capacity;let a=this._bufferManager.createRawBuffer(i*e.length,R.MapRead|R.CopyDst,void 0,"TempReadFromMultipleStorageBuffers");for(let o=0;o<e.length;o++)this._renderEncoder.copyBufferToBuffer(e[o].underlyingResource,t??0,a,o*i,i);return this._readFromGPUBuffer(a,i*e.length,r,n)}setStorageBuffer(e,t){this._currentDrawContext?.setBuffer(e,t?.getBuffer()??null)}};ee._GlslangDefaultOptions={jsPath:`${he._DefaultCdnUrl}/glslang/glslang.js`,wasmPath:`${he._DefaultCdnUrl}/glslang/glslang.wasm`};ee._InstanceId=0});var oo=A(()=>{Re();te();Ks();ee.prototype.unBindMultiColorAttachmentFramebuffer=function(s,e=!1,t){t&&t(),this._endCurrentRenderPass(),s.disableAutomaticMSAAResolve||this.resolveMultiFramebuffer(s,!1),e||this.generateMipMapsMultiFramebuffer(s),this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)};ee.prototype.createMultipleRenderTarget=function(s,e,t){let i=!1,r=!0,n=!1,a=!1,o=15,u=1,l=1,c=0,h=3,f=!1,d=5,_=3553,p=[],g=[],b=[],y=[],M=[],w=[],I=[],v=[],D=[],T=[],W=!1,E=this._createHardwareRenderTargetWrapper(!0,!1,s);e!==void 0&&(i=e.generateMipMaps??!1,r=e.generateDepthBuffer??!0,n=e.generateStencilBuffer??!1,a=e.generateDepthTexture??!1,u=e.textureCount??1,o=e.depthTextureFormat??15,p=e.types||p,g=e.samplingModes||g,b=e.useSRGBBuffers||b,y=e.formats||y,M=e.targetTypes||M,w=e.faceIndex||w,I=e.layerIndex||I,v=e.layerCounts||v,D=e.labels||D,T=e.creationFlags||T,l=e.samples??l,W=e.dontCreateTextures??!1);let Q=s.width??s,ue=s.height??s,le=[],k=[],ce=[];E.label=e?.label??"MultiRenderTargetWrapper",E._generateDepthBuffer=r,E._generateStencilBuffer=n,E._attachments=k,E._defaultAttachments=ce;let X=null;(r||n||a)&&!W&&(a||(r&&n?o=13:r?o=14:o=19),X=E.createDepthStencilTexture(0,!1,n,1,o,E.label+"-DepthStencil"));let xe=e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i;for(let $=0;$<u;$++){let pe=g[$]||h,Ce=p[$]||c,Oe=y[$]||d,Zt=(b[$]||f)&&this._caps.supportSRGBBuffers,ct=M[$]||_,ht=v[$]??1,Xt=T[$];if((Ce===1&&!this._caps.textureFloatLinearFiltering||Ce===2&&!this._caps.textureHalfFloatLinearFiltering)&&(pe=1),Ce===1&&!this._caps.textureFloat&&(Ce=0,C.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),k.push($+1),ce.push(t?$+1:$===0?1:0),ct===-1||W)continue;let U=new K(this,6);switch(le[$]=U,ct){case 34067:U.isCube=!0;break;case 32879:U.is3D=!0,U.baseDepth=U.depth=ht;break;case 35866:U.is2DArray=!0,U.baseDepth=U.depth=ht;break}U.baseWidth=Q,U.baseHeight=ue,U.width=Q,U.height=ue,U.isReady=!0,U.samples=1,U.generateMipMaps=i,U.samplingMode=pe,U.type=Ce,U._cachedWrapU=0,U._cachedWrapV=0,U._useSRGBBuffer=Zt,U.format=Oe,U.label=D[$]??E.label+"-Texture"+$,this._internalTexturesCache.push(U),xe&&(U.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(U,void 0,void 0,void 0,Xt),xe&&(U.generateMipMaps=!1)}return X&&(X.incrementReferences(),le[u]=X,this._internalTexturesCache.push(X)),E.setTextures(le),E.setLayerAndFaceIndices(I,w),W?E._samples=l:this.updateMultipleRenderTargetTextureSampleCount(E,l),E};ee.prototype.updateMultipleRenderTargetTextureSampleCount=function(s,e){if(!s||!s.textures||s.textures.length===0||s.textures[0].samples===e)return e;let t=s.textures.length;if(t===0)return 1;e=Math.min(e,this.getCaps().maxMSAASamples);for(let i=0;i<t;++i)s.textures[i]._hardwareTexture?.releaseMSAATextures();for(let i=0;i<t;++i){let r=s.textures[i];r.samples=e}return s._depthStencilTexture&&(s._depthStencilTexture.samples=e),s._samples=e,e};ee.prototype.generateMipMapsMultiFramebuffer=function(s){let e=s;if(!e.isMulti)return;let i=e._attachments.length;for(let r=0;r<i;r++){let n=e.textures[r];n.generateMipMaps&&!n.isCube&&!n.is3D&&this._generateMipmaps(n)}};ee.prototype.resolveMultiFramebuffer=function(s,e=!0){this.resolveFramebuffer(s,e)};ee.prototype.bindAttachments=function(s){s.length===0||!this._currentRenderTarget||(this._mrtAttachments=s,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(s))};ee.prototype.buildTextureLayout=function(s,e=!1){let t=[];if(e)t.push(1);else for(let i=0;i<s.length;i++)s[i]?t.push(i+1):t.push(0);return t};ee.prototype.restoreSingleAttachment=function(){};ee.prototype.restoreSingleAttachmentForRenderTarget=function(){}});export{vi as a,fc as b,Bs as c,Ci as d,ro as e,Rs as f,pc as g,Ps as h,ut as i,Fs as j,Qe as k,Ls as l,Ke as m,Es as n,oe as o,Di as p,Yt as q,Os as r,lt as s,J as t,Gs as u,L as v,Ws as w,Ht as x,Vs as y,G as z,Ns as A,to as B,Wt as C,Ue as D,rl as E,sl as F,nl as G,al as H,ol as I,ul as J,ll as K,ls as L,cs as M,hs as N,Vt as O,_i as P,Ll as Q,at as R,xs as S,Mi as T,ys as U,us as V,Gr as W,tt as X,xt as Y,ss as Z,ns as _,Wr as $,Vr as aa,Ri as ba,ks as ca,Ss as da,Qn as ea,Kn as fa,qn as ga,R as ha,Yn as ia,Hn as ja,Zn as ka,Xn as la,jn as ma,Jn as na,ea as oa,ta as pa,ia as qa,ra,sa,na as ta,aa as ua,oa as va,ua as wa,la as xa,ca as ya,ha as za,da as Aa,fa as Ba,pa as Ca,ma as Da,ga as Ea,_a as Fa,ba as Ga,xa as Ha,ya as Ia,Ia as Ja,Sa as Ka,Ma as La,va as Ma,Ca as Na,wa as Oa,Aa as Pa,Da as Qa,Ta as Ra,Ba as Sa,Ne as Ta,q as Ua,Xe as Va,_t as Wa,Ar as Xa,vt as Ya,Ur as Za,ke as _a,ci as $a,kr as ab,$r as bb,Me as cb,hi as db,$e as eb,di as fb,Yr as gb,Hr as hb,ie as ib,Zr as jb,ve as kb,as as lb,Ms as mb,vs as nb,Cs as ob,qt as pb,ws as qb,As as rb,Ds as sb,Ts as tb,$s as ub,ee as vb,Ks as wb,oo as xb};
