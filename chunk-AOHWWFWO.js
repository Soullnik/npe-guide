import{A as C,B as Q,ga as x,ha as he,j as J,k as K,l as pe,y as W,z as we}from"./chunk-SELDHAFC.js";import{p as P,q as ue}from"./chunk-BENX5G52.js";import{e as U,f as me}from"./chunk-VKUYP47B.js";import{a as $,d as ce}from"./chunk-2WAPFUUP.js";import{A as le,b as L,e as ie,v as d}from"./chunk-HPFLS2LJ.js";import{f as z,g as ge}from"./chunk-TARQX23T.js";import{a as j,b as fe,f as q,u as de}from"./chunk-J2REHNP7.js";import{a as Y,d as oe}from"./chunk-A2QYPOYP.js";import{j as E,z as Z}from"./chunk-W4M4SCHI.js";import{da as ee,ea as Ee}from"./chunk-XYWTDT3T.js";import{a as b,b as k,e as N}from"./chunk-FAF55DAL.js";var _,O,Pe=N(()=>{"use strict";le();Z();pe();ie();ce();_=class{constructor(e,r,a,t){this.name=e,this.worldAxisForNormal=r,this.worldAxisForFileX=a,this.worldAxisForFileY=t}},O=class{static ConvertCubeMapTextureToSphericalPolynomial(e){if(!e.isCube)return null;e.getScene()?.getEngine().flushFramebuffer();let r=e.getSize().width,a=e.readPixels(0,void 0,void 0,!1),t=e.readPixels(1,void 0,void 0,!1),i,s;e.isRenderTarget?(i=e.readPixels(3,void 0,void 0,!1),s=e.readPixels(2,void 0,void 0,!1)):(i=e.readPixels(2,void 0,void 0,!1),s=e.readPixels(3,void 0,void 0,!1));let o=e.readPixels(4,void 0,void 0,!1),f=e.readPixels(5,void 0,void 0,!1),l=e.gammaSpace,c=5,m=0;return(e.textureType==1||e.textureType==2)&&(m=1),new Promise(p=>{Promise.all([t,a,i,s,o,f]).then(([h,I,A,S,R,T])=>{let M={size:r,right:I,left:h,up:A,down:S,front:R,back:T,format:c,type:m,gammaSpace:l};p(this.ConvertCubeMapToSphericalPolynomial(M))})})}static _AreaElement(e,r){return Math.atan2(e*r,Math.sqrt(e*e+r*r+1))}static ConvertCubeMapToSphericalPolynomial(e){let r=new J,a=0,t=2/e.size,i=t,s=.5*t,o=s-1;for(let p=0;p<6;p++){let h=this._FileFaces[p],I=e[h.name],A=o,S=e.format===5?4:3;for(let R=0;R<e.size;R++){let T=o;for(let M=0;M<e.size;M++){let H=h.worldAxisForFileX.scale(T).add(h.worldAxisForFileY.scale(A)).add(h.worldAxisForNormal);H.normalize();let B=this._AreaElement(T-s,A-s)-this._AreaElement(T-s,A+s)-this._AreaElement(T+s,A-s)+this._AreaElement(T+s,A+s),u=I[R*e.size*S+M*S+0],g=I[R*e.size*S+M*S+1],w=I[R*e.size*S+M*S+2];isNaN(u)&&(u=0),isNaN(g)&&(g=0),isNaN(w)&&(w=0),e.type===0&&(u/=255,g/=255,w/=255),e.gammaSpace&&(u=Math.pow(E(u),L),g=Math.pow(E(g),L),w=Math.pow(E(w),L));let y=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){let X=Math.max(u,g,w);if(X>y){let D=y/X;u*=D,g*=D,w*=D}}else u=E(u,0,y),g=E(g,0,y),w=E(w,0,y);let te=new $(u,g,w);r.addLight(H,te,B),a+=B,T+=t}A+=i}}let m=4*Math.PI*6/6/a;return r.scaleInPlace(m),r.convertIncidentRadianceToIrradiance(),r.convertIrradianceToLambertianRadiance(),K.FromHarmonics(r)}};O._FileFaces=[new _("right",new d(1,0,0),new d(0,0,-1),new d(0,-1,0)),new _("left",new d(-1,0,0),new d(0,0,1),new d(0,-1,0)),new _("up",new d(0,1,0),new d(1,0,0),new d(0,0,1)),new _("down",new d(0,-1,0),new d(1,0,0),new d(0,0,-1)),new _("front",new d(0,0,1),new d(1,0,0),new d(0,-1,0)),new _("back",new d(0,0,-1),new d(-1,0,0),new d(0,-1,0))];O.MAX_HDRI_VALUE=4096;O.PRESERVE_CLAMPED_COLORS=!1});var V,ne,re=N(()=>{"use strict";ge();he();V=(()=>{class n extends z{_gatherImports(r,a){r?(this._webGPUReady=!0,a.push(Promise.all([import("./chunk-PS7EWEX6.js")]))):a.push(Promise.all([import("./chunk-IE6NAKAH.js")])),super._gatherImports(r,a)}constructor(r,a=null,t){let i=b({name:r,engine:a||x.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:n.FragmentUrl},t);i.engine||(i.engine=x.LastCreatedEngine),super(i)}}return n.FragmentUrl="pass",n})(),ne=(()=>{class n extends z{_gatherImports(r,a){r?(this._webGPUReady=!0,a.push(Promise.all([import("./chunk-6WY6X5XU.js")]))):a.push(Promise.all([import("./chunk-LLKV5PID.js")])),super._gatherImports(r,a)}constructor(r,a=null,t){super(k(b({},t),{name:r,engine:a||x.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:n.FragmentUrl,defines:"#define POSITIVEX"})),this._face=0}get face(){return this._face}set face(r){if(!(r<0||r>5))switch(this._face=r,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ");break}}}return n.FragmentUrl="passCube",n})()});var F,G,ae=N(()=>{"use strict";fe();Q();Ee();oe();me();re();de();F=class n extends C{getClassName(){return"PassPostProcess"}constructor(e,r,a=null,t,i,s,o=0,f=!1){let l=b({size:typeof r=="number"?r:void 0,camera:a,samplingMode:t,engine:i,reusable:s,textureType:o,blockCompilation:f},r);super(e,V.FragmentUrl,b({effectWrapper:typeof r=="number"||!r.effectWrapper?new V(e,i,l):void 0},l))}static _Parse(e,r,a,t){return U.Parse(()=>new n(e.name,e.options,r,e.renderTargetSamplingMode,e._engine,e.reusable),e,a,t)}};Y("BABYLON.PassPostProcess",F);G=class n extends C{get face(){return this._effectWrapper.face}set face(e){this._effectWrapper.face=e}getClassName(){return"PassCubePostProcess"}constructor(e,r,a=null,t,i,s,o=0,f=!1){let l=b({size:typeof r=="number"?r:void 0,camera:a,samplingMode:t,engine:i,reusable:s,textureType:o,blockCompilation:f},r);super(e,V.FragmentUrl,b({effectWrapper:typeof r=="number"||!r.effectWrapper?new ne(e,i,l):void 0},l))}static _Parse(e,r,a,t){return U.Parse(()=>new n(e.name,e.options,r,e.renderTargetSamplingMode,e._engine,e.reusable),e,a,t)}};j([q()],G.prototype,"face",null);ee._RescalePostProcessFactory=n=>new F("rescale",1,null,2,n,!1,0)});function Ae(n,e,r,a=!0){let t=n.getScene(),i=t.getEngine(),s=new W("resized"+n.name,{width:e,height:r},t,!n.noMipmap,!0,n._texture.type,!1,n.samplingMode,!1);s.wrapU=n.wrapU,s.wrapV=n.wrapV,s.uOffset=n.uOffset,s.vOffset=n.vOffset,s.uScale=n.uScale,s.vScale=n.vScale,s.uAng=n.uAng,s.vAng=n.vAng,s.wAng=n.wAng,s.coordinatesIndex=n.coordinatesIndex,s.level=n.level,s.anisotropicFilteringLevel=n.anisotropicFilteringLevel,s._texture.isReady=!1,n.wrapU=P.CLAMP_ADDRESSMODE,n.wrapV=P.CLAMP_ADDRESSMODE;let o=new F("pass",1,null,a?P.BILINEAR_SAMPLINGMODE:P.NEAREST_SAMPLINGMODE,i,!1,0);return o.externalTextureSamplerBinding=!0,o.onEffectCreatedObservable.addOnce(f=>{f.executeWhenCompiled(()=>{o.onApply=function(c){c.setTexture("textureSampler",n)};let l=s.renderTarget;l&&(t.postProcessManager.directRender([o],l),i.unBindFramebuffer(l),s.disposeFramebufferObjects(),o.dispose(),s.getInternalTexture().isReady=!0)})}),s}function Se(n,e,r,a,t,i,s,o){let f=e.getEngine();return e.isReady=!1,t=t??e.samplingMode,a=a??e.type,i=i??e.format,s=s??e.width,o=o??e.height,a===-1&&(a=0),new Promise(l=>{let c=new C("postprocess",n,null,null,1,null,t,f,!1,void 0,a,void 0,null,!1,i);c.externalTextureSamplerBinding=!0;let m=f.createRenderTargetTexture({width:s,height:o},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t,type:a,format:i});c.onEffectCreatedObservable.addOnce(p=>{p.executeWhenCompiled(()=>{c.onApply=h=>{h._bindTexture("textureSampler",e),h.setFloat2("scale",1,1)},r.postProcessManager.directRender([c],m,!0),f.restoreDefaultFramebuffer(),f._releaseTexture(e),c&&c.dispose(),m._swapAndDie(e),e.type=a,e.format=5,e.isReady=!0,l(e)})})})}function Te(n){v||(v=new Float32Array(1),se=new Int32Array(v.buffer)),v[0]=n;let e=se[0],r=e>>16&32768,a=e>>12&2047,t=e>>23&255;return t<103?r:t>142?(r|=31744,r|=(t==255?0:1)&&e&8388607,r):t<113?(a|=2048,r|=(a>>114-t)+(a>>113-t&1),r):(r|=t-112<<10|a>>1,r+=a&1,r)}function be(n){let e=(n&32768)>>15,r=(n&31744)>>10,a=n&1023;return r===0?(e?-1:1)*Math.pow(2,-14)*(a/Math.pow(2,10)):r==31?a?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,r-15)*(1+a/Math.pow(2,10))}function _e(n){switch(n){case 36492:case 36493:case 36495:case 36494:case 33779:case 35919:case 33778:case 35918:case 33777:case 33776:case 35917:case 35916:case 37808:case 37840:case 36196:case 37492:case 37493:case 37494:case 37495:case 37496:case 37497:return!0;default:return!1}}async function Re(n){if(n.isReady())return;if(n.loadingError)throw new Error(n.errorObject?.message||`Texture ${n.name} errored while loading.`);let e=n.onLoadObservable;if(e)return await new Promise(a=>e.addOnce(()=>a()));let r=n._texture?.onLoadedObservable;if(r)return await new Promise(a=>r.addOnce(()=>a()));throw new Error(`Cannot determine readiness of texture ${n.name}.`)}async function Me(n,e,r,a,t){let i=n.getScene(),s=i.getEngine();s.isWebGPU?n.isCube?await import("./chunk-3HCWKWWX.js"):await import("./chunk-JL43SLDC.js"):n.isCube?await import("./chunk-UOFXAETH.js"):await import("./chunk-7IINNZX2.js");let o;if(!n.isCube)o=new C("lod","lod",{uniforms:["lod","gamma"],samplingMode:P.NEAREST_NEAREST_MIPNEAREST,engine:s,shaderLanguage:s.isWebGPU?1:0});else{let c=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];o=new C("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:P.NEAREST_NEAREST_MIPNEAREST,engine:s,defines:c[a],shaderLanguage:s.isWebGPU?1:0})}await new Promise(c=>{o.onEffectCreatedObservable.addOnce(m=>{m.executeWhenCompiled(()=>{c(0)})})});let f=new W("temp",{width:e,height:r},i,!1);o.onApply=function(c){c.setTexture("textureSampler",n),c.setFloat("lod",t),c.setInt("gamma",n.gammaSpace?1:0)};let l=n.getInternalTexture();try{if(f.renderTarget&&l){let c=l.samplingMode;t!==0?n.updateSamplingMode(P.NEAREST_NEAREST_MIPNEAREST):n.updateSamplingMode(P.NEAREST_NEAREST),i.postProcessManager.directRender([o],f.renderTarget,!0),n.updateSamplingMode(c);let m=await s.readPixels(0,0,e,r),p=new Uint8Array(m.buffer,0,m.byteLength);return s.unBindFramebuffer(f.renderTarget),p}else throw Error("Render to texture failed.")}finally{f.dispose(),o.dispose()}}async function Ce(n,e,r,a=0,t=0){await Re(n);let{width:i,height:s}=n.getSize(),o=e??i,f=r??s;if(_e(n.textureFormat)||o!==i||f!==s)return await Me(n,o,f,a,t);let l=await n.readPixels(a,t);if(!l)throw new Error(`Failed to read pixels from texture ${n.name}.`);if(l instanceof Float32Array){let c=new Uint8Array(l.length),m=l.length;for(;m--;){let p=l[m];c[m]=Math.round(E(p)*255)}l=c}return l}var v,se,Qe,Fe=N(()=>{"use strict";ue();we();ae();Q();Z();Qe={CreateResizedCopy:Ae,ApplyPostProcess:Se,ToHalfFloat:Te,FromHalfFloat:be,GetTextureDataAsync:Ce}});export{O as a,Pe as b,V as c,ne as d,re as e,F as f,G as g,ae as h,Ae as i,Se as j,Te as k,be as l,Re as m,Ce as n,Qe as o,Fe as p};
