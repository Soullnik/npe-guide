import{A as j,v as f}from"./chunk-DYR6BFEB.js";import{e as P}from"./chunk-FAF55DAL.js";var m,L=P(()=>{"use strict";j();m=class{static ConvertPanoramaToCubemap(e,n,t,o,a=!1,c=!0){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";let w=0;if(e.length!=n*t*3){if(e.length!=n*t*4)throw"ConvertPanoramaToCubemap: input size is wrong";w=4}else w=3;let l=this.CreateCubemapTexture(o,this.FACE_FRONT,e,n,t,a,c,w),s=this.CreateCubemapTexture(o,this.FACE_BACK,e,n,t,a,c,w),u=this.CreateCubemapTexture(o,this.FACE_LEFT,e,n,t,a,c,w),i=this.CreateCubemapTexture(o,this.FACE_RIGHT,e,n,t,a,c,w),h=this.CreateCubemapTexture(o,this.FACE_UP,e,n,t,a,c,w),C=this.CreateCubemapTexture(o,this.FACE_DOWN,e,n,t,a,c,w);return{front:l,back:s,left:u,right:i,up:h,down:C,size:o,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,n,t,o,a,c,w,l){let s=new ArrayBuffer(e*e*4*3),u=new Float32Array(s),i=c?Math.max(1,Math.round(o/4/e)):1,h=1/i,C=h*h,d=n[1].subtract(n[0]).scale(h/e),R=n[3].subtract(n[2]).scale(h/e),b=1/e,g=0;for(let F=0;F<e;F++)for(let x=0;x<i;x++){let M=n[0],p=n[2];for(let B=0;B<e;B++)for(let D=0;D<i;D++){let G=p.subtract(M).scale(g).add(M);G.normalize();let T=this.CalcProjectionSpherical(G,t,o,a,l,w);u[F*e*3+B*3+0]+=T.r*C,u[F*e*3+B*3+1]+=T.g*C,u[F*e*3+B*3+2]+=T.b*C,M=M.add(d),p=p.add(R)}g+=b*h}return u}static CalcProjectionSpherical(e,n,t,o,a,c){let w=Math.atan2(e.z,e.x),l=Math.acos(e.y);for(;w<-Math.PI;)w+=2*Math.PI;for(;w>Math.PI;)w-=2*Math.PI;let s=w/Math.PI,u=l/Math.PI;s=s*.5+.5;let i=Math.round(s*t);i<0?i=0:i>=t&&(i=t-1);let h=Math.round(u*o);h<0?h=0:h>=o&&(h=o-1);let C=c?o-h-1:h,d=n[C*t*a+i*a+0],R=n[C*t*a+i*a+1],b=n[C*t*a+i*a+2];return{r:d,g:R,b}}};m.FACE_LEFT=[new f(-1,-1,-1),new f(1,-1,-1),new f(-1,1,-1),new f(1,1,-1)];m.FACE_RIGHT=[new f(1,-1,1),new f(-1,-1,1),new f(1,1,1),new f(-1,1,1)];m.FACE_FRONT=[new f(1,-1,-1),new f(1,-1,1),new f(1,1,-1),new f(1,1,1)];m.FACE_BACK=[new f(-1,-1,1),new f(-1,-1,-1),new f(-1,1,1),new f(-1,1,-1)];m.FACE_DOWN=[new f(1,1,-1),new f(1,1,1),new f(-1,1,-1),new f(-1,1,1)];m.FACE_UP=[new f(-1,-1,-1),new f(-1,-1,1),new f(1,-1,-1),new f(1,-1,1)]});function k(r,e){return e>1023?r*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?r*Math.pow(2,-1074)*Math.pow(2,e+1074):r*Math.pow(2,e)}function O(r,e,n,t,o,a){o>0?(o=k(1,o-136),r[a+0]=e*o,r[a+1]=n*o,r[a+2]=t*o):(r[a+0]=0,r[a+1]=0,r[a+2]=0)}function _(r,e){let n="",t="";for(let o=e;o<r.length-e&&(t=String.fromCharCode(r[o]),t!=`
`);o++)n+=t;return n}function A(r){let e=0,n=0,t=_(r,0);if(t[0]!="#"||t[1]!="?")throw"Bad HDR Format.";let o=!1,a=!1,c=0;do c+=t.length+1,t=_(r,c),t=="FORMAT=32-bit_rle_rgbe"?a=!0:t.length==0&&(o=!0);while(!o);if(!a)throw"HDR Bad header format, unsupported FORMAT";c+=t.length+1,t=_(r,c);let l=/^-Y (.*) \+X (.*)$/g.exec(t);if(!l||l.length<3)throw"HDR Bad header format, no size";if(n=parseInt(l[2]),e=parseInt(l[1]),n<8||n>32767)throw"HDR Bad header format, unsupported size";return c+=t.length+1,{height:e,width:n,dataPosition:c}}function X(r,e,n=!1){let t=new Uint8Array(r),o=A(t),a=E(t,o);return m.ConvertPanoramaToCubemap(a,o.width,o.height,e,n)}function E(r,e){return y(r,e)}function y(r,e){let n=e.height,t=e.width,o,a,c,w,l,s=e.dataPosition,u=0,i=0,h=0,C=new ArrayBuffer(t*4),d=new Uint8Array(C),R=new ArrayBuffer(e.width*e.height*4*3),b=new Float32Array(R);for(;n>0;){if(o=r[s++],a=r[s++],c=r[s++],w=r[s++],o!=2||a!=2||c&128||e.width<8||e.width>32767)return H(r,e);if((c<<8|w)!=t)throw"HDR Bad header format, wrong scan line width";for(u=0,h=0;h<4;h++)for(i=(h+1)*t;u<i;)if(o=r[s++],a=r[s++],o>128){if(l=o-128,l==0||l>i-u)throw"HDR Bad Format, bad scanline data (run)";for(;l-- >0;)d[u++]=a}else{if(l=o,l==0||l>i-u)throw"HDR Bad Format, bad scanline data (non-run)";if(d[u++]=a,--l>0)for(let g=0;g<l;g++)d[u++]=r[s++]}for(h=0;h<t;h++)o=d[h],a=d[h+t],c=d[h+2*t],w=d[h+3*t],O(b,o,a,c,w,(e.height-n)*t*3+h*3);n--}return b}function H(r,e){let n=e.height,t=e.width,o,a,c,w,l,s=e.dataPosition,u=new ArrayBuffer(e.width*e.height*4*3),i=new Float32Array(u);for(;n>0;){for(l=0;l<e.width;l++)o=r[s++],a=r[s++],c=r[s++],w=r[s++],O(i,o,a,c,w,(e.height-n)*t*3+l*3);n--}return i}var $,U=P(()=>{"use strict";L();$={RGBE_ReadHeader:A,GetCubeMapTextureData:X,RGBE_ReadPixels:E}});var N,K=P(()=>{U();N=class{constructor(){this.supportCascades=!1}loadCubeData(){throw".hdr not supported in Cube."}loadData(e,n,t){let o=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),a=A(o),c=E(o,a),w=a.width*a.height,l=new Float32Array(w*4);for(let s=0;s<w;s+=1)l[s*4]=c[s*3],l[s*4+1]=c[s*3+1],l[s*4+2]=c[s*3+2],l[s*4+3]=1;t(a.width,a.height,n.generateMipMaps,!1,()=>{let s=n.getEngine();n.type=1,n.format=5,n._gammaSpace=!1,s._uploadDataToTextureDirectly(n,l)})}}});export{m as a,L as b,X as c,$ as d,U as e,N as f,K as g};
