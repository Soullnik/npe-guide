import{o,p as te}from"./chunk-O64X2WXU.js";import{S as V,T as ee}from"./chunk-WFRBO4E6.js";import{a as J,b as W}from"./chunk-MEUTOEEX.js";import{e as z}from"./chunk-FAF55DAL.js";var re=z(()=>{ee();W();te();o.prototype.restoreSingleAttachment=function(){let r=this._gl;this.bindAttachments([r.BACK])};o.prototype.restoreSingleAttachmentForRenderTarget=function(){let r=this._gl;this.bindAttachments([r.COLOR_ATTACHMENT0])};o.prototype.buildTextureLayout=function(r,t=!1){let n=this._gl,u=[];if(t)u.push(n.BACK);else for(let i=0;i<r.length;i++)r[i]?u.push(n["COLOR_ATTACHMENT"+i]):u.push(n.NONE);return u};o.prototype.bindAttachments=function(r){this._gl.drawBuffers(r)};o.prototype.unBindMultiColorAttachmentFramebuffer=function(r,t=!1,n){this._currentRenderTarget=null,r.disableAutomaticMSAAResolve||this.resolveMultiFramebuffer(r),t||this.generateMipMapsMultiFramebuffer(r),n&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),n()),this._bindUnboundFramebuffer(null)};o.prototype.createMultipleRenderTarget=function(r,t,n=!0){let u=!1,i=!0,m=!1,a=!1,s,_=1,E=1,D=0,F=3,M=!1,Q=5,Z=3553,p=[],B=[],C=[],N=[],L=[],U=[],O=[],w=[],y=[],x=!1,T=this._createHardwareRenderTargetWrapper(!0,!1,r);t!==void 0&&(u=t.generateMipMaps===void 0?!1:t.generateMipMaps,i=t.generateDepthBuffer===void 0?!0:t.generateDepthBuffer,m=t.generateStencilBuffer===void 0?!1:t.generateStencilBuffer,a=t.generateDepthTexture===void 0?!1:t.generateDepthTexture,_=t.textureCount??1,E=t.samples??E,p=t.types||p,B=t.samplingModes||B,C=t.useSRGBBuffers||C,N=t.formats||N,L=t.targetTypes||L,U=t.faceIndex||U,O=t.layerIndex||O,w=t.layerCounts||w,y=t.labels||y,x=t.dontCreateTextures??!1,this.webGLVersion>1&&(t.depthTextureFormat===13||t.depthTextureFormat===17||t.depthTextureFormat===16||t.depthTextureFormat===14||t.depthTextureFormat===18)&&(s=t.depthTextureFormat)),s===void 0&&(s=m?13:14);let e=this._gl,v=this._currentFramebuffer,K=e.createFramebuffer();this._bindUnboundFramebuffer(K);let b=r.width??r,g=r.height??r,I=[],S=[],Y=this.webGLVersion>1&&(s===13||s===17||s===18);T.label=t?.label??"MultiRenderTargetWrapper",T._framebuffer=K,T._generateDepthBuffer=a||i,T._generateStencilBuffer=a?Y:m,T._depthStencilBuffer=this._setupFramebufferDepthAttachments(T._generateStencilBuffer,T._generateDepthBuffer,b,g,1,s),T._attachments=S;for(let f=0;f<_;f++){let c=B[f]||F,d=p[f]||D,R=C[f]||M,A=N[f]||Q,h=L[f]||Z,j=w[f]??1;(d===1&&!this._caps.textureFloatLinearFiltering||d===2&&!this._caps.textureHalfFloatLinearFiltering)&&(c=1);let k=this._getSamplingParameters(c,u);d===1&&!this._caps.textureFloat&&(d=0,J.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),R=R&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);let q=this.webGLVersion>1,$=e[q?"COLOR_ATTACHMENT"+f:"COLOR_ATTACHMENT"+f+"_WEBGL"];if(S.push($),h===-1||x)continue;let l=new V(this,6);I[f]=l,e.activeTexture(e["TEXTURE"+f]),e.bindTexture(h,l._hardwareTexture.underlyingResource),e.texParameteri(h,e.TEXTURE_MAG_FILTER,k.mag),e.texParameteri(h,e.TEXTURE_MIN_FILTER,k.min),e.texParameteri(h,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(h,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);let P=this._getRGBABufferInternalSizedFormat(d,A,R),G=this._getInternalFormat(A),H=this._getWebGLTextureType(d);if(q&&(h===35866||h===32879))h===35866?l.is2DArray=!0:l.is3D=!0,l.baseDepth=l.depth=j,e.texImage3D(h,0,P,b,g,j,0,G,H,null);else if(h===34067){for(let X=0;X<6;X++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+X,0,P,b,g,0,G,H,null);l.isCube=!0}else e.texImage2D(e.TEXTURE_2D,0,P,b,g,0,G,H,null);u&&e.generateMipmap(h),this._bindTextureDirectly(h,null),l.baseWidth=b,l.baseHeight=g,l.width=b,l.height=g,l.isReady=!0,l.samples=1,l.generateMipMaps=u,l.samplingMode=c,l.type=d,l._useSRGBBuffer=R,l.format=A,l.label=y[f]??T.label+"-Texture"+f,this._internalTexturesCache.push(l)}if(a&&this._caps.depthTextureExtension&&!x){let f=new V(this,14),c=5,d=e.DEPTH_COMPONENT16,R=e.DEPTH_COMPONENT,A=e.UNSIGNED_SHORT,h=e.DEPTH_ATTACHMENT;this.webGLVersion<2?d=e.DEPTH_COMPONENT:s===14?(c=1,A=e.FLOAT,d=e.DEPTH_COMPONENT32F):s===18?(c=0,A=e.FLOAT_32_UNSIGNED_INT_24_8_REV,d=e.DEPTH32F_STENCIL8,R=e.DEPTH_STENCIL,h=e.DEPTH_STENCIL_ATTACHMENT):s===16?(c=0,A=e.UNSIGNED_INT,d=e.DEPTH_COMPONENT24,h=e.DEPTH_ATTACHMENT):(s===13||s===17)&&(c=12,A=e.UNSIGNED_INT_24_8,d=e.DEPTH24_STENCIL8,R=e.DEPTH_STENCIL,h=e.DEPTH_STENCIL_ATTACHMENT),this._bindTextureDirectly(e.TEXTURE_2D,f,!0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,d,b,g,0,R,A,null),e.framebufferTexture2D(e.FRAMEBUFFER,h,e.TEXTURE_2D,f._hardwareTexture.underlyingResource,0),this._bindTextureDirectly(e.TEXTURE_2D,null),T._depthStencilTexture=f,T._depthStencilTextureWithStencil=Y,f.baseWidth=b,f.baseHeight=g,f.width=b,f.height=g,f.isReady=!0,f.samples=1,f.generateMipMaps=u,f.samplingMode=1,f.format=s,f.type=c,f.label=T.label+"-DepthStencil",I[_]=f,this._internalTexturesCache.push(f)}if(T.setTextures(I),n&&e.drawBuffers(S),this._bindUnboundFramebuffer(v),T.setLayerAndFaceIndices(O,U),this.resetTextureCache(),!x)this.updateMultipleRenderTargetTextureSampleCount(T,E,n);else if(E>1){let f=e.createFramebuffer();if(!f)throw new Error("Unable to create multi sampled framebuffer");T._samples=E,T._MSAAFramebuffer=f,_>0&&n&&(this._bindUnboundFramebuffer(f),e.drawBuffers(S),this._bindUnboundFramebuffer(v))}return T};o.prototype.updateMultipleRenderTargetTextureSampleCount=function(r,t,n=!0){if(this.webGLVersion<2||!r)return 1;if(r.samples===t)return t;let u=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),r._depthStencilBuffer&&(u.deleteRenderbuffer(r._depthStencilBuffer),r._depthStencilBuffer=null),r._MSAAFramebuffer&&(u.deleteFramebuffer(r._MSAAFramebuffer),r._MSAAFramebuffer=null);let i=r._attachments.length;for(let a=0;a<i;a++)r.textures[a]._hardwareTexture?.releaseMSAARenderBuffers();if(t>1&&typeof u.renderbufferStorageMultisample=="function"){let a=u.createFramebuffer();if(!a)throw new Error("Unable to create multi sampled framebuffer");r._MSAAFramebuffer=a,this._bindUnboundFramebuffer(a);let s=[];for(let _=0;_<i;_++){let E=r.textures[_],D=E._hardwareTexture,F=u[this.webGLVersion>1?"COLOR_ATTACHMENT"+_:"COLOR_ATTACHMENT"+_+"_WEBGL"],M=this._createRenderBuffer(E.width,E.height,t,-1,this._getRGBABufferInternalSizedFormat(E.type,E.format,E._useSRGBBuffer),F);if(!M)throw new Error("Unable to create multi sampled framebuffer");D.addMSAARenderBuffer(M),E.samples=t,s.push(F)}n&&u.drawBuffers(s)}else this._bindUnboundFramebuffer(r._framebuffer);let m=r._depthStencilTexture?r._depthStencilTexture.format:void 0;return r._depthStencilBuffer=this._setupFramebufferDepthAttachments(r._generateStencilBuffer,r._generateDepthBuffer,r.width,r.height,t,m),this._bindUnboundFramebuffer(null),r._samples=t,t};o.prototype.generateMipMapsMultiFramebuffer=function(r){let t=r,n=this._gl;if(t.isMulti)for(let u=0;u<t._attachments.length;u++){let i=t.textures[u];i?.generateMipMaps&&!i?.isCube&&!i?.is3D&&(this._bindTextureDirectly(n.TEXTURE_2D,i,!0),n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null))}};o.prototype.resolveMultiFramebuffer=function(r){let t=r,n=this._gl;if(!t._MSAAFramebuffer||!t.isMulti)return;let u=t.resolveMSAAColors?n.COLOR_BUFFER_BIT:0;u|=t._generateDepthBuffer&&t.resolveMSAADepth?n.DEPTH_BUFFER_BIT:0,u|=t._generateStencilBuffer&&t.resolveMSAAStencil?n.STENCIL_BUFFER_BIT:0;let i=t._attachments,m=i.length;n.bindFramebuffer(n.READ_FRAMEBUFFER,t._MSAAFramebuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,t._framebuffer);for(let a=0;a<m;a++){let s=t.textures[a];for(let _=0;_<m;_++)i[_]=n.NONE;i[a]=n[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"],n.readBuffer(i[a]),n.drawBuffers(i),n.blitFramebuffer(0,0,s.width,s.height,0,0,s.width,s.height,u,n.NEAREST)}for(let a=0;a<m;a++)i[a]=n[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"];n.drawBuffers(i),n.bindFramebuffer(this._gl.FRAMEBUFFER,t._MSAAFramebuffer)}});export{re as a};
