import{M as Y,N as de}from"./chunk-BT5IBVS6.js";import{c as N,g as ye}from"./chunk-QBSFQ7CP.js";import{a as q,b as he}from"./chunk-KTLBV3B2.js";import{C as Q,D as me,i as C,j as J,ja as K,pa as ge}from"./chunk-I37SS3RD.js";import{g as D,h as $}from"./chunk-C2NDYXG7.js";import{c as j,f as fe}from"./chunk-XGXGTYYM.js";import{S as E,T as pe}from"./chunk-WFRBO4E6.js";import{A as ce,v as P}from"./chunk-DYR6BFEB.js";import{m as B,z as le}from"./chunk-W4M4SCHI.js";import{a as k,b as ue}from"./chunk-MEUTOEEX.js";import{a as V,b as W,e as F}from"./chunk-FAF55DAL.js";var S,X=F(()=>{"use strict";J();ge();S=class{static ExpandRGBDTexture(t){let r=t._texture;if(!r||!t.isRGBD)return;let n=r.getEngine(),o=n.getCaps(),a=r.isReady,i=!1;o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?(i=!0,r.type=2):o.textureFloatRender&&o.textureFloatLinearFiltering&&(i=!0,r.type=1),i&&(r.isReady=!1,r._isRGBD=!1,r.invertY=!1);let c=async()=>{let u=n.isWebGPU,h=u?1:0;r.isReady=!1,u?await import("./chunk-XRJH2QOB.js"):await import("./chunk-742E5MV6.js");let d=new C("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,r.type,void 0,null,!1,void 0,h);d.externalTextureSamplerBinding=!0;let y=n.createRenderTargetTexture(r.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:r.samplingMode,type:r.type,format:5});d.onEffectCreatedObservable.addOnce(x=>{x.executeWhenCompiled(()=>{d.onApply=f=>{f._bindTexture("textureSampler",r),f.setFloat2("scale",1,1)},t.getScene().postProcessManager.directRender([d],y,!0),n.restoreDefaultFramebuffer(),n._releaseTexture(r),d&&d.dispose(),y._swapAndDie(r),r.isReady=!0})})};i&&(a?c():t.onLoadObservable.addOnce(c))}static async EncodeTextureToRGBD(t,r,n=0){return r.getEngine().isWebGPU?await import("./chunk-XHVWC6RB.js"):await import("./chunk-CRJT7LXB.js"),await K("rgbdEncode",t,r,n,1,5)}}});var Z=F(()=>{"use strict";he();$();D.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(D.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=q.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0})});function O(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength),r=0;for(let i=0;i<z.length;i++)if(t.getUint8(r++)!==z[i])return k.Error("Not a babylon environment map"),null;let n="",o=0;for(;o=t.getUint8(r++);)n+=String.fromCharCode(o);let a=JSON.parse(n);return a=M(a),a.binaryDataPosition=r,a.specular&&(a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}function M(e){if(e.version>U)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${U}".`);return e.version===2||(e=W(V({},e),{version:2,imageType:L})),e}async function xe(e,t={}){let r=e.getInternalTexture();if(!r)return await Promise.reject("The cube texture is invalid.");let n=r.getEngine();if(e.textureType!==2&&e.textureType!==1&&e.textureType!==0&&e.textureType!==0&&e.textureType!==7&&e.textureType!==-1)return await Promise.reject("The cube texture should allow HDR (Full Float or Half Float).");let o=1;if(!n.getCaps().textureFloatRender&&(o=2,!n.getCaps().textureHalfFloatRender))return await Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.");e.sphericalPolynomial;let a=e.getInternalTexture()?._sphericalPolynomialPromise,i=r.width,c=new Y(n),u={},h={};n.flushFramebuffer();let d=t.imageType??L,y=B(r.width);for(let s=0;s<=y;s++){let p=Math.pow(2,y-s);for(let g=0;g<6;g++)u[s*6+g]=await ee(c,e,o,g,s,p,d,t.imageQuality)}let x=t.disableIrradianceTexture?null:e.irradianceTexture;if(x){let s=x.getSize().width;for(let p=0;p<6;p++)h[p]=await ee(c,x,o,p,0,s,d,t.imageQuality)}c.dispose(),a&&await a;let f={version:U,width:i,imageType:d,irradiance:we(e),specular:{mipmaps:[],lodGenerationScale:e.lodGenerationScale}},l=0;for(let s=0;s<=y;s++)for(let p=0;p<6;p++){let g=u[s*6+p].byteLength;f.specular.mipmaps.push({length:g,position:l}),l+=g}if(x){f.irradiance=f.irradiance||{x:[0,0,0],xx:[0,0,0],y:[0,0,0],yy:[0,0,0],z:[0,0,0],zz:[0,0,0],yz:[0,0,0],zx:[0,0,0],xy:[0,0,0]},f.irradiance.irradianceTexture={size:x.getSize().width,faces:[],dominantDirection:x._dominantDirection?.asArray()};for(let s=0;s<6;s++){let p=h[s].byteLength;f.irradiance.irradianceTexture.faces.push({length:p,position:l}),l+=p}}let m=JSON.stringify(f),T=new ArrayBuffer(m.length+1),w=new Uint8Array(T);for(let s=0,p=m.length;s<p;s++)w[s]=m.charCodeAt(s);w[m.length]=0;let A=z.length+l+T.byteLength,R=new ArrayBuffer(A),_=new Uint8Array(R),v=new DataView(R),b=0;for(let s=0;s<z.length;s++)v.setUint8(b++,z[s]);_.set(new Uint8Array(T),b),b+=T.byteLength;for(let s=0;s<=y;s++)for(let p=0;p<6;p++){let g=u[s*6+p];_.set(new Uint8Array(g),b),b+=g.byteLength}if(x)for(let s=0;s<6;s++){let p=h[s];_.set(new Uint8Array(p),b),b+=p.byteLength}return R}async function ee(e,t,r,n,o,a,i,c){let u=await t.readPixels(n,o,void 0,!1);if(u&&u.byteLength===u.length){let f=new Float32Array(u.byteLength*4);for(let l=0;l<u.byteLength;l++)f[l]=u[l]/255,f[l]=Math.pow(f[l],2.2);u=f}else if(u&&t.gammaSpace){let f=u;for(let l=0;l<f.length;l++)f[l]=Math.pow(f[l],2.2)}let h=e.getEngine(),d=h.createRawTexture(u,a,a,5,!1,!0,1,null,r);await S.EncodeTextureToRGBD(d,e,r);let y=await h._readTexturePixels(d,a,a),x=await N(a,a,y,i,void 0,!1,!0,c);return d.dispose(),x}function we(e){let t=e.sphericalPolynomial;return t==null?null:{x:[t.x.x,t.x.y,t.x.z],y:[t.y.x,t.y.y,t.y.z],z:[t.z.x,t.z.y,t.z.z],xx:[t.xx.x,t.xx.y,t.xx.z],yy:[t.yy.x,t.yy.y,t.yy.z],zz:[t.zz.x,t.zz.y,t.zz.z],yz:[t.yz.x,t.yz.y,t.yz.z],zx:[t.zx.x,t.zx.y,t.zx.z],xy:[t.xy.x,t.xy.y,t.xy.z]}}function re(e,t){t=M(t);let r=t.specular,n=Math.log2(t.width);if(n=Math.round(n)+1,r.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);let o=new Array(n);for(let a=0;a<n;a++){o[a]=new Array(6);for(let i=0;i<6;i++){let c=r.mipmaps[a*6+i];o[a][i]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+c.position,c.length)}}return o}function ae(e,t){t=M(t);let r=new Array(6),n=t.irradiance?.irradianceTexture;if(n){if(n.faces.length!==6)throw new Error(`Incorrect irradiance texture faces number "${n.faces.length}"`);for(let o=0;o<6;o++){let a=n.faces[o];r[o]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+a.position,a.length)}}return r}function G(e,t,r){r=M(r);let n=r.specular;if(!n)return Promise.resolve([]);e._lodGenerationScale=n.lodGenerationScale;let o=[],a=re(t,r);o.push(I(e,a,r.imageType));let i=r.irradiance?.irradianceTexture;if(i){let c=ae(t,r),u=null;r.irradiance?.irradianceTexture?.dominantDirection&&(u=P.FromArray(r.irradiance.irradianceTexture.dominantDirection)),o.push(ne(e,c,i.size,r.imageType,u))}return Promise.all(o)}async function te(e,t,r,n,o,a,i,c,u,h,d){return await new Promise((y,x)=>{if(r){let f=t.createTexture(null,!0,!0,null,1,null,l=>{x(l)},e);n?.onEffectCreatedObservable.addOnce(l=>{l.executeWhenCompiled(()=>{n.externalTextureSamplerBinding=!0,n.onApply=m=>{m._bindTexture("textureSampler",f),m.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([n],h,!0,a,i),t.restoreDefaultFramebuffer(),f.dispose(),URL.revokeObjectURL(o),y())})})}else{if(t._uploadImageToTexture(d,e,a,i),c){let f=u[i];f&&t._uploadImageToTexture(f._texture,e,a,0)}y()}})}async function I(e,t,r=L){let n=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,e),await ie(e,t,!0,r),e.isReady=!0}async function ne(e,t,r,n=L,o=null){let a=e.getEngine(),i=new E(a,5),c=new D(a,i);e._irradianceTexture=c,c._dominantDirection=o,i.isCube=!0,i.format=5,i.type=0,i.generateMipMaps=!0,i._cachedAnisotropicFilteringLevel=null,i.generateMipMaps=!0,i.width=r,i.height=r,a.updateTextureSamplingMode(3,i),await ie(i,[t],!1,n),a.generateMipMapsForCubemap(i),i.isReady=!0}async function ie(e,t,r,n=L){if(!j.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");let o=B(e.width)+1,a=e.getEngine(),i=!1,c=!1,u=null,h=null,d=null,y=a.getCaps();y.textureLOD?a._features.supportRenderAndCopyToLodForFloatTextures?y.textureHalfFloatRender&&y.textureHalfFloatLinearFiltering?(i=!0,e.type=2):y.textureFloatRender&&y.textureFloatLinearFiltering&&(i=!0,e.type=1):i=!1:(i=!1,c=r);let x=0;if(i)a.isWebGPU?(x=1,await import("./chunk-XRJH2QOB.js")):await import("./chunk-742E5MV6.js"),u=new C("rgbdDecode","rgbdDecode",null,null,1,null,3,a,!1,void 0,e.type,void 0,null,!1,void 0,x),e._isRGBD=!1,e.invertY=!1,h=a.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,c){d={};let m=e._lodGenerationScale,T=e._lodGenerationOffset;for(let w=0;w<3;w++){let R=1-w/2,_=T,v=(o-1)*m+T,b=_+(v-_)*R,s=Math.round(Math.min(Math.max(b,0),v)),p=new E(a,2);p.isCube=!0,p.invertY=!0,p.generateMipMaps=!1,a.updateTextureSamplingMode(2,p);let g=new D(null);switch(g._isCube=!0,g._texture=p,d[s]=g,w){case 0:e._lodTextureLow=g;break;case 1:e._lodTextureMid=g;break;case 2:e._lodTextureHigh=g;break}}}let f=[];for(let l=0;l<t.length;l++)for(let m=0;m<6;m++){let T=t[l][m],w=new Blob([T],{type:n}),A=URL.createObjectURL(w),R;if(a._features.forceBitmapOverHTMLImageElement)R=a.createImageBitmap(w,{premultiplyAlpha:"none"}).then(async _=>await te(_,a,i,u,A,m,l,c,d,h,e));else{let _=new Image;_.src=A,R=new Promise((v,b)=>{_.onload=()=>{te(_,a,i,u,A,m,l,c,d,h,e).then(()=>v()).catch(s=>{b(s)})},_.onerror=s=>{b(s)}})}f.push(R)}if(await Promise.all(f),t.length<o){let l,m=Math.pow(2,o-1-t.length),T=m*m*4;switch(e.type){case 0:{l=new Uint8Array(T);break}case 2:{l=new Uint16Array(T);break}case 1:{l=new Float32Array(T);break}}for(let w=t.length;w<o;w++)for(let A=0;A<6;A++)a._uploadArrayBufferViewToTexture(h?.texture||e,l,A,w)}if(h){let l=e._irradianceTexture;e._irradianceTexture=null,a._releaseTexture(e),h._swapAndDie(e),e._irradianceTexture=l}u&&u.dispose(),c&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function H(e,t){t=M(t);let r=t.irradiance;if(!r)return;let n=new Q;P.FromArrayToRef(r.x,0,n.x),P.FromArrayToRef(r.y,0,n.y),P.FromArrayToRef(r.z,0,n.z),P.FromArrayToRef(r.xx,0,n.xx),P.FromArrayToRef(r.yy,0,n.yy),P.FromArrayToRef(r.zz,0,n.zz),P.FromArrayToRef(r.yz,0,n.yz),P.FromArrayToRef(r.zx,0,n.zx),P.FromArrayToRef(r.xy,0,n.xy),e._sphericalPolynomial=n}function Oe(e,t,r,n,o){let a=e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),i=I(a,t).then(()=>e);return e.onRebuildCallback=c=>({proxy:i,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=t,e._lodGenerationScale=n,e._lodGenerationOffset=o,e._sphericalPolynomial=r,I(e,t).then(()=>(e.isReady=!0,e))}var L,U,z,Ge,oe=F(()=>{"use strict";fe();ce();le();me();pe();$();de();J();ue();X();ye();Z();L="image/png",U=2,z=[134,22,135,150,246,214,150,54];Ge={GetEnvInfo:O,CreateEnvTextureAsync:xe,CreateRadianceImageDataArrayBufferViews:re,CreateIrradianceImageDataArrayBufferViews:ae,UploadEnvLevelsAsync:G,UploadRadianceLevelsAsync:I,UploadIrradianceLevelsAsync:ne,UploadEnvSpherical:H}});var se,Te=F(()=>{oe();se=class{constructor(){this.supportCascades=!1}loadCubeData(t,r,n,o,a){if(Array.isArray(t))return;let i=O(t);if(i){r.width=i.width,r.height=i.width;try{H(r,i),G(r,t,i).then(()=>{r.isReady=!0,r.onLoadedObservable.notifyObservers(r),r.onLoadedObservable.clear(),o&&o()},c=>{a?.("Can not upload environment levels",c)})}catch(c){a?.("Can not upload environment file",c)}}else a&&a("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}});export{S as a,X as b,Z as c,O as d,M as e,xe as f,re as g,ae as h,G as i,I as j,ne as k,H as l,Oe as m,Ge as n,oe as o,se as p,Te as q};
